<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' *.twitter.com unpkg.com www.googletagmanager.com www.google-analytics.com *.twimg.com; img-src 'self' data: *;style-src 'self' 'unsafe-inline' *.twitter.com *.twimg.com">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
        <link rel="canonical" href="https://blog.jermdavis.dev/posts/2022/fancy-paste-behaviour-wpf">
        <meta name="description" content="Windows Presentation Foundation makes use of some interesting extension patterns. Here&amp;#x27;s a good example around extending text boxes.">
        <meta property="og:description" content="Windows Presentation Foundation makes use of some interesting extension patterns. Here&amp;#x27;s a good example around extending text boxes.">
            <meta name="keywords" content="C#, Statiq, WPF">
        <meta name="author" content="Jeremy Davis">
        <meta name="copyright" content="Jeremy Davis">

    <title>Jeremy Davis - Fancy paste behaviour in WPF</title> 

        <meta name="robots" content="index, follow">

            <link type="application/rss+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.rss">
            <link type="application/atom+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.atom">

    <meta name="application-name" content="Jeremy Davis">
    <meta name="msapplication-tooltip" content="Jeremy Davis">
    <meta name="msapplication-starturl" content="/">
    <link rel="manifest" href="/manifest.webmanifest">

    
    <meta property="og:title" content="Jeremy Davis - Fancy paste behaviour in WPF">
        <meta property="og:image" content="https://blog.jermdavis.dev/img/featured/fancy-paste-behaviour-wpf-social.jpg">
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": "Fancy paste behaviour in WPF",
        "image": [
            "https://blog.jermdavis.dev/img/featured/fancy-paste-behaviour-wpf-social.jpg"
        ],
        "datePublished": "2022-02-14T00:00:00+00:00",
        "author": [{
            "@type": "Person",
            "name": "Jeremy Davis",
            "url": "https://jermdavis.dev/"
        }]
    }
    </script>
<meta property="og:url" content="https://blog.jermdavis.dev/posts/2022/fancy-paste-behaviour-wpf">
<meta property="og:type" content="website">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">

    <link href="/scss/tailwind.css" rel="stylesheet">

    <link href="/vendor/Enlighter/enlighterjs.min.css" rel="stylesheet">
    <link href="/scss/site-theme.css" rel="stylesheet">


    <script src="/vendor/Cookies/cookies.min.js" defer=""></script>

    

    
    <!-- 18/07/2022 07:56:09 -->
</head>

<body class="max-w-7xl mx-auto">
    <div class="relative bg-white" x-data="{ open: false }">

    <!-- desktop -->
    <div class="px-4 lg:px-6 bg-gray-100">
        <div class="flex justify-between items-center border-b-2 border-gray-100 py-6 lg:justify-start lg:space-x-10">

            <div class="flex justify-start lg:w-0 flex-1">
                <a href="/">
                    <img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
                </a>
                <div class="mx-2">
                    <div class="text-3xl">Jeremy Davis</div>
                    <div class="text-lg">Sitecore, C# and web development</div>
                </div>
            </div>

            <div class="nav -mr-2 -my-2 lg:hidden">
                <button @click="open = true" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-expanded="false">
                    <span class="sr-only">Open menu</span>
                    <!-- Heroicon name: outline/menu -->
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>

            <nav class="nav hidden lg:flex space-x-10">
<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/posts">Posts</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/tags">Tags</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/about">About</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/links">Useful Links</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/mvp">MVP</a>            </nav>

        </div>
    </div>

    <!--Mobile menu, show/hide based on mobile menu state.-->
    <div class="absolute top-0 inset-x-0 p-2 transition transform origin-top-right lg:hidden z-50">

        <div class="rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 bg-white divide-y-2 divide-gray-50" x-show="open" x-transition="">
            <div class="pt-5 pb-6 px-5">
                <div class="flex items-center justify-between">
                    <div class="flex">
                        <a href="/">
                            <img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
                        </a>
                        <div class="mx-2">
                            <div class="text-2xl">Jeremy Davis</div>
                            <div class="text-base">Sitecore, C# and web development</div>
                        </div>
                    </div>

                    <div class="nav -mr-2">
                        <button @click="open = false" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
                            <span class="sr-only">Close menu</span>
                            <!-- Heroicon name: outline/x -->
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="nav py-6 px-5 pt-0">
                <nav class=" gap-x-8">
<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/posts">Posts</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/tags">Tags</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/about">About</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/links">Useful Links</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/mvp">MVP</a>                </nav>
            </div>

        </div>
    </div>
</div>

    <header class="bg-gray-300 px-4 py-1 lg:px-6 text-center">
    <div class="post-heading">
        <div class="url p-1 bg-gray-100 rounded-md">Article printed from: <tt>https://blog.jermdavis.dev/posts/2022/fancy-paste-behaviour-wpf</tt></div>
        <h1 class="text-5xl mb-4 pb-1">
        Fancy paste behaviour in WPF
        </h1>
        <h2 class="text-2xl">Composition over inheritance wins again</h2>
            <div class="meta">Published 14 February 2022</div>
            <div class="flex py-1">
                    <a href="/tags/c/" class="p-1 mr-1 bg-gray-100 rounded-md"> C#</a>
                    <a href="/tags/statiq/" class="p-1 mr-1 bg-gray-100 rounded-md"> Statiq</a>
                    <a href="/tags/wpf/" class="p-1 mr-1 bg-gray-100 rounded-md"> WPF</a>
            </div>
    </div>
</header>

    <div class="py-2 lg:pl-3">
        <div class="lg:flex">
            <div class="lg:flex-auto mx-3 lg:min-w-0 content">
                <p>I realised recently that I've become quite used to way many web forms let you paste image data straight into a text field. The behaviour of &quot;upload the image data, and insert the correct mark-up for the image&quot; is a really helpful shortcut when you're editing DevOps tickets, or Stack Overflow answers. So I started wondering how easy it would be to add that to the text editing tool I use for writing these blog posts. Turns out, not too hard, because WPF has some helpful extension patterns...<!--more--></p>
<h2 id="the-challenge">The challenge</h2>
<p>I'm typing this in a (very) simple WPF app I wrote. It's a basic text editor, which I've enhanced with a few helpful extras which make my writing process easier for me. I have shortcuts to insert common Markdown and HTML tags, just to save typing. It's got a &quot;pick the right tags&quot; dialog, which can look at my current blog posts and give me a pick list of tags I've used before. And it's able to fire up the Statiq generator to give me close-to-realtime previews of what I'm writing. The editor's code is pretty horrible right now - but it works for me.</p>
<p>Since Markdown is plain text, the bulk of the UI is a WPF <code>TextBox</code> that I can type into. But if you put any sort of data that isn't text onto your clipboard and try to paste it into this textbox control it won't work. The context menu option for paste will disabled and shortcut keys will do nothing. For example, if I copy an image in Paint.Net I see a greyed-out context menu:</p>
<p><a target="_blank" href="/img/2022/01-PasteDenied.png"><img alt="The context menu of a WPF textbox, with the paste option greyed out" src="/img/2022/01-PasteDenied.png"></a></p>
<p>Which isn't surprising - why would a default textbox know what to do with anything that wasn't text? So the challenge is to work out how to extend this behaviour...</p>
<h2 id="composition-for-the-win">Composition for the win</h2>
<p>One of the ways WPF improves upon old-style Windows Forms is that it favours a &quot;composition before inheritance&quot; model for adding customisations. It has a collection of extension points where you can provide composable helper objects which give new behaviour to a control. For example, in WPF we have &quot;adorner&quot; classes to change the way a component draws itself, rather than the old &quot;override the <code>Paint()</code> method that was required in Forms. Because they're composable, they are potentially reusable across multiple controls.</p>
<p>It happens that WPF has one of these extension points for logical behaviours too - so that's the place to start implementing this behaviour.</p>
<h2 id="a-simple-example">A simple example</h2>
<p>To start with this, you need to add a Nuget package to your project: <code>Microsoft.Xaml.Behaviours.Wpf</code>. That gives you the relevant types to implement your own reusable behaviours. You start with a class for your new behaviour:</p>
<pre><code class="language-csharp">public class PasteBehaviour : Behaviour&lt;TextBox&gt;
{
}
</code></pre>
<p>By making the type parameter to <code>Behaviour</code> a <code>TextBox</code> here, we're saying that this behaviour expects to work on textboxes. But you could use more generic WPF UI types here, if your behaviour doesn't require such a specific type. And with that defined, you can attach it to any relevant UI component with some XAML. For example, on my textbox:</p>
<pre><code class="language-xml">&lt;TextBox&gt;
    &lt;behaviour:Interaction.Behaviors&gt;
        &lt;local:PasteBehavior/&gt;
    &lt;/behaviour:Interaction.Behaviors&gt;
&lt;/TextBox&gt;
</code></pre>
<p>Here the <code>behaviour</code> namespace maps to that Nuget package's namespace: <code>http://schemas.microsoft.com/xaml/behaviors</code> and <code>local</code> is the namespace for where the custom behaviour class is declared.</p>
<p>To make this type do custom pasting behaviour, it needs two key things. First is logic to attach and detach the its code from the UI element. And the second is the logic for whatever the new behaviour should actually do.</p>
<p>Attaching and detaching are pretty simple - there methods to overload in your behaviour. In those, you can attach and detach whatever event handlers you need:</p>
<pre><code class="language-csharp">protected override void OnAttached()
{
    base.OnAttached();

    CommandManager.AddPreviewExecutedHandler(AssociatedObject, onPreviewExecuted);
    CommandManager.AddPreviewCanExecuteHandler(AssociatedObject, onPreviewCanExecute);
}

protected override void OnDetaching()
{
    base.OnDetaching();

    CommandManager.RemovePreviewExecutedHandler(AssociatedObject, onPreviewExecuted);
    CommandManager.RemovePreviewCanExecuteHandler(AssociatedObject, onPreviewCanExecute);
}
</code></pre>
<p>In this case, the key events to handle are ones that preview the &quot;can execute&quot; and &quot;executed&quot; events for some routed commands. A routed command is the way WPF binds actions like &quot;button clicked&quot; or &quot;shortcut key pressed&quot; to UI elements. So by previewing these we can spot pasting behaviour however it's triggered, and apply our custom logic. The <code>AssociatedObject</code> here is whatever <code>TextBox</code> this <code>Behaviour&lt;&gt;</code> class has been bound to.</p>
<p>The logic for previewing the &quot;can execute&quot; event is fairly simple. If the command being previewed is &quot;Paste&quot; we need to override the logic for &quot;can this control accept the clipboard data format that's present&quot; and allow it to accept image data. (The default control we're extending will already handle text here) We can do that with something like:</p>
<pre><code class="language-csharp">private void onPreviewCanExecute(object sender, CanExecuteRoutedEventArgs e)
{
    if (e.Command == ApplicationCommands.Paste)
    {
        e.CanExecute = Clipboard.ContainsImage();
        e.Handled = Clipboard.ContainsImage();
    }
}
</code></pre>
<p>By setting the value of <code>CanExecute</code> we're extending this &quot;can the control accept the data&quot; logic. And by setting <code>Handled</code> we tell the runtime that we made a change. And with that in place, we should see that the context menu &quot;paste&quot; entry our textbox will not be greyed out if we have bitmap data on the clipboard.</p>
<p>Next the code needs to extend the actual &quot;data is being pasted&quot; event - which the attachment logic above is sending to a <code>onPreviewExecuted</code> method in this behaviour object. As before, that needs to check that the command being processed is &quot;paste&quot; and that the clipboard data is an image. But if those tests pass, it can get on and perform its custom functions, before again setting <code>Handled</code> true to show it did stuff with the event. And as noted above, the <code>AssociatedObject</code> here (whatever we've bound this behaviour logic too) is a <code>TextBox</code> so we can do operations on the text it contains:</p>
<pre><code class="language-csharp">private void onPreviewExecuted(object sender, ExecutedRoutedEventArgs e)
{
    if (e.Command == ApplicationCommands.Paste)
    {
        if (Clipboard.ContainsImage())
        {
            // work out a disk filename and web url for our new image
            // save the image to disk

            var markup = $&quot;![Alt text here](/web-path-to-file/goes-here.png)&quot;;

            AssociatedObject.Text = AssociatedObject.Text.Insert(AssociatedObject.SelectionStart, markup);

            e.Handled = true;
        }
    }
}
</code></pre>
<p>So the outcome of all of this is that the custom code written above &quot;previews&quot; the events sent to the textbox. We get to run the extra code before the default behaviour of the textbox runs, and hence we can extend its features. So now when I copy some image data from Paint.Net, I see this:</p>
<p><a target="_blank" href="/img/2022/01-PasteAllowed.png"><img alt="The context menu of a WPF textbox, with the paste option enabled" src="/img/2022/01-PasteAllowed.png"></a></p>
<p>And if I click &quot;Paste&quot; or hit <code>Ctrl-V</code> I now get my link inserted:</p>
<p><a target="_blank" href="/img/2022/01-PasteCompleted.png"><img alt="" src="/img/2022/01-PasteCompleted.png"></a></p>
<p>I've skipped how the clipboard data ends up as an image file with a URL here. But that's not really relevant to the basic pattern for extending paste behaviour. (And saving images is fairly easily googleable) And what's above is pretty much all the code required to allow doing this a data conversion to paste something that's not text into a texbox.</p>
<p>If you'd like to fiddle with this yourself, there's a <a target="_blank" href="/files/PasteBehavior.zip">zip of the basic code above you can grab if you want</a>...</p>


            </div>
            <div class="sidebar lg:flex-none lg:w-72 m-0 mt-1 lg:mt-0 lg:p-1 lg:bg-gray-100">
                <section class="mvp">
    <h3 class="bg-gray-300 p-2">Sitecore MVP 2015-2022</h3>
    <div class="bg-white mb-2 p-2"><a href="/mvp"><img src="/img/mvp/2022.jpg" width="219" height="219" alt="2022 MVP Badge"></a></div>
</section>

<section>
    <h3 class="bg-gray-300 p-2">Top Tags</h3>
    <div class="bg-white p-2 flex flex-wrap">
                    <a href="/tags/sitecore/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Sitecore (203)</a>
                    <a href="/tags/c/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> C# (47)</a>
                    <a href="/tags/powershell/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> PowerShell (31)</a>
                    <a href="/tags/installation/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Installation (23)</a>
                    <a href="/tags/solr/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Solr (15)</a>
                    <a href="/tags/general/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> General (14)</a>
                    <a href="/tags/ui/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> UI (14)</a>
                    <a href="/tags/docker/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Docker (12)</a>
                    <a href="/tags/coveo/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Coveo (12)</a>
                    <a href="/tags/packages/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Packages (11)</a>
    </div>
    <div class="bg-white mb-2 p-2">
        <a class="" href="/tags" role="button">All Tags <i class="fas fa-angle-double-right"></i></a>
    </div>
</section>

<section>
    <h3 class="bg-gray-300 p-2">Recent Months</h3>
    <div class="bg-white p-2">
                <div><a class="text-lg" href="/posts/2022-07">2022 - July</a></div>
                <div><a class="text-lg" href="/posts/2022-06">2022 - June</a></div>
                <div><a class="text-lg" href="/posts/2022-05">2022 - May</a></div>
                <div><a class="text-lg" href="/posts/2022-04">2022 - April</a></div>
                <div><a class="text-lg" href="/posts/2022-03">2022 - March</a></div>
    </div>
    <div class="bg-white mb-2 p-2">
        <a class="" href="/posts" role="button">All Posts <i class="fas fa-angle-double-right"></i></a>
    </div>
</section>

<section>
    <h3 class="bg-gray-300 p-2">Twitter</h3>
    <div class="bg-white mb-2 p-2">
        <a class="twitter-timeline" data-height="400" data-chrome="noheader nofooter noborders" href="https://twitter.com/jermdavis">Tweets by JermDavis</a>
        <script async="" defer="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    </div>
</section>
            </div>
        </div>
    </div>

    <footer class="lg:flex order-1 bg-gray-100 px-4 lg:px-6 py-4">
    <div class="flex-1 lg:flex-1 text-center lg:text-left">
        <div>&copy; <a target="_blank" class="font-medium text-gray-500 hover:text-gray-900" rel="noopener" href="https://jermdavis.dev/">Jeremy Davis</a> 2014-2022</div>
    </div>

    <div class="lg:flex-1 lg:order-3 text-center lg:text-right">
        <a class="font-medium text-gray-500 hover:text-gray-900" href="/tools">Published using Statiq</a><br>
    </div>

    <ul class="list-none lg:flex-1 lg:order-2 p-0 text-center lg:align-middle" style="margin:0px !important">
        <li class="inline-block">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
            </svg>
        </li>
            <li class="inline-block ml-4">
                <a class="font-medium text-gray-500 hover:text-gray-900" target="_blank" href="/feed.rss">RSS</a>
            </li>
            <li class="inline-block ml-4">
                <a class="font-medium text-gray-500 hover:text-gray-900" target="_blank" href="/feed.atom">Atom</a>
            </li>
    </ul>
</footer>

    <div class="min-h-screen bg-gray-300 py-6 flex flex-col justify-center sm:py-12" x-data="{ hide_banner: true }" x-init="hide_banner = docCookies.hasItem('hide_banner');" x-bind:class="{ 'hidden': hide_banner, 'fixed': !hide_banner }">
        <div class="border-2 border-gray-600 bg-gray-100 max-w-screen-lg mx-auto fixed bg-white inset-x-5 p-5 bottom-10 rounded-lg drop-shadow-2xl flex gap-4 flex-wrap md:flex-nowrap text-center md:text-left items-center justify-center md:justify-between">
            <div class="w-full text-lg">
                <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cookie-usage" rel="noreferrer" target="_blank">This website uses Google Analytics, and its cookies.</a>
            </div>
            <button type="button" @click="hide_banner = true; docCookies.setItem('hide_banner', true, 'Fri, 31 Dec 9999 23:59:59 GMT', null, null, null, 'strict');" class="bg-gray-400 px-5 py-2 text-white rounded-md hover:bg-gray-600 focus:outline-none" aria-label="Dismiss">Understood</button>
        </div>
    </div>
    
    <script src="/vendor/Alpine/alpine.3.7.1.min.js" defer=""></script>
    <script src="/vendor/Enlighter/enlighterjs.min.js"></script>

    <script type="text/javascript">
        EnlighterJS.init('pre', 'code', {
            theme: 'droide',
            indent : 4,
            linehover : false,
            textOverflow: 'scroll',
            toolbarTop: '',
            toolbarBottom: ''
        });
    </script>

    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JQ44ZR47YX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-JQ44ZR47YX');
    </script>

    

    



</body></html>