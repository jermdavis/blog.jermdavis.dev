<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' *.twitter.com unpkg.com www.googletagmanager.com www.google-analytics.com *.twimg.com; img-src 'self' data: *;style-src 'self' 'unsafe-inline' *.twitter.com *.twimg.com">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="canonical" href="https://blog.jermdavis.dev/posts/2014/custom-sitemap-filespart-two">
		<meta name="description" content="<a href=&quot;/posts/2014/custom-sitemap-filespart-one&quot; target=&quot;_blank&quot;>Last week we looked at the stuff to create in Sitecore to configure a custom sitemap generator</a>. This week we'll carry on and look at the basic proof-of-concept code that can be used to process that configuration and generate a sitemaps and sitemap index files. It's another epic post... ">
		<meta property="og:description" content="<a href=&quot;/posts/2014/custom-sitemap-filespart-one&quot; target=&quot;_blank&quot;>Last week we looked at the stuff to create in Sitecore to configure a custom sitemap generator</a>. This week we'll carry on and look at the basic proof-of-concept code that can be used to process that configuration and generate a sitemaps and sitemap index files. It's another epic post... ">
		<meta name="keywords" content="C#, Sitecore">
		<meta name="author" content="Jeremy Davis">
		<meta name="copyright" content="Jeremy Davis">
		<title>Jeremy Davis - Custom Sitemap Files – Part Two</title>
		<meta name="robots" content="index, follow">
		<link type="application/rss+xml" rel="alternate" href="/feed.rss">
		<link type="application/atom+xml" rel="alternate" href="/feed.atom">
		<meta name="application-name" content="Jeremy Davis">
		<meta name="msapplication-tooltip" content="Jeremy Davis">
		<meta name="msapplication-starturl" content="/">
		<link rel="manifest" href="/manifest.webmanifest">
		<meta property="og:title" content="Jeremy Davis - Custom Sitemap Files &amp;#x2013; Part Two">
		<meta property="og:image" content="https://blog.jermdavis.dev/img/featured/custom-sitemap-filespart-two-social.jpg">
		<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": "Custom Sitemap Files &#x2013; Part Two",
        "image": [
            "https://blog.jermdavis.dev/img/featured/custom-sitemap-filespart-two-social.jpg"
        ],
        "datePublished": "2014-05-19T00:00:00+00:00",
        "dateModified": "2016-08-25T00:00:00+00:00",
        "author": [{
            "@type": "Person",
            "name": "Jeremy Davis",
            "url": "https://jermdavis.dev/"
        }]
    }
    
		</script>
		<meta property="og:url" content="https://blog.jermdavis.dev/posts/2014/custom-sitemap-filespart-two">
		<meta property="og:type" content="website">
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">
		<link href="/scss/tailwind.css" rel="stylesheet">
		<link href="/vendor/Enlighter/enlighterjs.min.css" rel="stylesheet">
		<link href="/scss/site-theme.css" rel="stylesheet">
		<script src="/vendor/Cookies/cookies.min.js" defer=""></script>
		
		<!-- 14/03/2022 08:57:26 -->
	</head>
	<body class="max-w-7xl mx-auto">
		<div class="relative bg-white" x-data="{ open: false }">
			
			<!-- desktop -->
			<div class="px-4 lg:px-6 bg-gray-100">
				<div class="flex justify-between items-center border-b-2 border-gray-100 py-6 lg:justify-start lg:space-x-10">
					<div class="flex justify-start lg:w-0 flex-1">
						<a href="/">
							<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
						</a>
						<div class="mx-2">
							<div class="text-3xl">Jeremy Davis</div>
							<div class="text-lg">Sitecore, C# and web development</div>
						</div>
					</div>
					<div class="-mr-2 -my-2 lg:hidden">
						<button @click="open = true" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-expanded="false">
							<span class="sr-only">Open menu</span>
							
							<!-- Heroicon name: outline/menu -->
							<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
							</svg>
						</button>
					</div>
					<nav class="hidden lg:flex space-x-10">
						<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/posts">Posts</a>
						<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/tags">Tags</a>
						<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/about">About</a>
						<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/links">Useful Links</a>
						<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/mvp">MVP</a>
					</nav>
				</div>
			</div>
			
			<!--Mobile menu, show/hide based on mobile menu state.-->
			<div class="absolute top-0 inset-x-0 p-2 transition transform origin-top-right lg:hidden z-50">
				<div class="rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 bg-white divide-y-2 divide-gray-50" x-show="open" x-transition="">
					<div class="pt-5 pb-6 px-5">
						<div class="flex items-center justify-between">
							<div class="flex">
								<a href="/">
									<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
								</a>
								<div class="mx-2">
									<div class="text-2xl">Jeremy Davis</div>
									<div class="text-base">Sitecore, C# and web development</div>
								</div>
							</div>
							<div class="-mr-2">
								<button @click="open = false" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
									<span class="sr-only">Close menu</span>
									
									<!-- Heroicon name: outline/x -->
									<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
									</svg>
								</button>
							</div>
						</div>
					</div>
					<div class="py-6 px-5 pt-0">
						<nav class=" gap-x-8">
							<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/posts">Posts</a>
							<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/tags">Tags</a>
							<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/about">About</a>
							<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/links">Useful Links</a>
							<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/mvp">MVP</a>
						</nav>
					</div>
				</div>
			</div>
		</div>
		<header class="bg-gray-300 px-4 py-1 lg:px-6 text-center" style="background-image: url(&amp;quot;/&amp;quot;);">
			<div class="post-heading">
				<h1 class="text-5xl mb-4 pb-1">
					Custom Sitemap Files – Part Two
				</h1>
				<div class="meta">Published 19 May 2014</div>
				<div class="meta">Updated 25 August 2016</div>
				<div class="flex py-1">
					<a href="/tags/c/" class="p-1 mr-1 bg-gray-100 rounded-md">
						C#</a>
					<a href="/tags/sitecore/" class="p-1 mr-1 bg-gray-100 rounded-md">
						Sitecore</a>
				</div>
			</div>
		</header>
		<div class="py-2 lg:pl-3">
			<div class="lg:flex">
				<div class="lg:flex-auto mx-3 lg:min-w-0 content">
					<p>
						<a href="/posts/2014/custom-sitemap-filespart-one" target="_blank">Last week we looked at the stuff to create in Sitecore to configure a custom sitemap generator</a>. This week we'll carry on and look at the basic proof-of-concept code that can be used to process that configuration and generate a sitemaps and sitemap index files. It's another epic post... 
						<!--more-->
					</p>
					<p>The sitemap generation process starts when Sitecore triggers the custom event handler class we defined. When that runs we need to get the configuration defined for the module and iterate it:</p>
					<pre data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public void Publish(object sender, EventArgs args)
{
    Database master = Sitecore.Configuration.Factory.GetDatabase("master");
    Item configRoot = master.GetItem(Identifiers.ConfigItemID);

    string query = string.Format("child::*[@@templateid='{0}' or @@templateid='{1}']", Identifiers.SitemapFileTemplateID, Identifiers.SitemapIndexFileTemplateID);

    foreach (Item siteConfig in configRoot.Axes.SelectItems(query))
    {
        if (siteConfig.TemplateID == Identifiers.SitemapIndexFileTemplateID)
        {
            publishSiteIndex(siteConfig);
        }

        if (siteConfig.TemplateID == Identifiers.SitemapFileTemplateID)
        {
            publishSite(siteConfig);
        }
    }
}

					</pre>
					<p>Here we're fetching a reference to the Master database by using Sitecore's internal configuration factory. This is necessary because there is no context database available here. Then we use that database to load the root configuration item we talked about last week. The ID of the item we need to load is defined in a static class. (It's a common pattern in Sitecore development to define a class in which you put the IDs of items and fields that you will need to reference later. You can generate these using things like Hedgehog TDS and T4 templates, or you can maintain them manually – all of the IDs in this example code will be defined that way) We can then run a query on that item to find all its children which are either Sitemap definitions or Sitemap Index File definitions, and iterate those.</p>
					<p>If we find an item based on the Sitemap Index File template then we need to process it:</p>
					<pre data-enlighter-language="csharp" style="width:100%; overflow:scroll;">private void publishSiteIndex(Item siteIndexConfig)
{
    SiteIndexConfiguration sc = new SiteIndexConfiguration(siteIndexConfig);

    SitemapIndex si = new SitemapIndex();

    var urlOptions = new Sitecore.Links.UrlOptions()
    {
        AlwaysIncludeServerUrl = true,
        LanguageEmbedding = Sitecore.Links.LanguageEmbedding.AsNeeded,
        ShortenUrls = true
    };

    foreach (Item s in sc.SiteConfigurations)
    {
        SiteConfiguration cfg = publishSite(s);

        Item root = cfg.SitemapSourceDatabase.GetItem(cfg.SitemapRootItem);
        string rootUrl = Sitecore.Links.LinkManager.GetItemUrl(root, urlOptions);
        Uri rootUri = new Uri(rootUrl, UriKind.Absolute);

        Uri fileUri = new Uri(rootUri, "/" + cfg.SitemapFilename);

        si.Add(new SitemapIndexItem() { 
            Location = fileUri.ToString(),
            LastModified = DateTime.Now
        });
    }

    string filename = System.Web.Hosting.HostingEnvironment.MapPath("/" + sc.SitemapIndexFilename);
    saveXmlToFile(filename, si.Serialise());
}

					</pre>
					<p>This method gets called passing in the item that represents the Sitemap Index file configuration that an editor has set up. So the first thing to do is parse it, in order to get the configuration into a strongly typed class. In the real world this is best done with a tool like
						<a href="http://glass.lu/" target="_blank" rel="noopener noreferrer">Glass Mapper</a>
						but to keep things simple and avoid dependencies here I've just used a simple model class:</p>
					<pre data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public class SiteIndexConfiguration
{
    public string SitemapIndexFilename { get; private set; }
    public IEnumerable&lt;item&gt; SiteConfigurations { get; private set; }

    public SiteIndexConfiguration(Item cfg)
    {
        SitemapIndexFilename = cfg.Fields[Identifiers.SitemapIndexFilenameFieldID].Value;

        var siteConfigs = cfg.Axes.SelectItems(string.Format("./*[@@templateid='{0}']", Identifiers.SitemapFileTemplateID));
        if (siteConfigs != null &amp;&amp; siteConfigs.Length &gt; 0)
        {
            SiteConfigurations = siteConfigs;
        }
        else
        {
            SiteConfigurations = new List&lt;item&gt;();
        }
    }
}

					</pre>
					<p>It just extracts the relevant fields from the item into properties... This pattern will get reused throughout the rest of the code too.</p>
					<p>With that loaded, next we set up a
						<code>UrlOptions</code>
						object that we'll use to generate some links later, and then iterate each of the Sitemap file configurations that have been set up for inclusion in this index file.</p>
					<p>For each of these configurations the code runs the publish process for that sitemap file (we'll come back to that in a second) and gets back the configuration object from that item. We then use that configuration data to generate the information that will be written into the index file. Normally when you're after a link to an item in Sitecore you just ask
						<code>LinkManager</code>
						– but here we need the URL of something that isn't a Sitecore item. So we use LinkManager to generate the URL of the root item for the site we're indexing, and then we use the the
						<code>Uri</code>
						type to merge the relative Uri for the sitemap file with the absolute Uri of the root item. The absolute URL is necessary here as the Sitemap Index file needs to specify the exact location of the child sitemaps.</p>
					<p>With the correct link generated we can then create a
						<code>SitemapIndexItem</code>
						object to represent this data ready for us to serialise it into the Sitemap index file.</p>
					<p>Finally the code generates the physical file name on the server that the Sitemap file is going to be written into, and we serialise the data. The
						<code>saveXmlToFile()</code>
						method just writes the XML we generate into a UTF8 text file using a
						<code>TextWriter</code>
						and the standard saving behaviour of the Linq to XML classes. We call the
						<code>Serialise()</code>
						method on the SitemapIndex data to generate an
						<code>XElement</code>
						which we can save. Having tried to write this code using the
						<code>XmlSerialiser</code>
						instead initially, I came to the conclusion that the code required to get the namespaces and null-element handling correct wasn't worth the extra effort. Manually serialising the data to exactly the required format turned out simpler. The code for these data classes is as follows:</p>
					<pre data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public class SitemapIndex
{
    private List&lt;sitemapindexitem&gt; _items = new List&lt;sitemapindexitem&gt;();

    public IEnumerable&lt;sitemapindexitem&gt; IndexItems { get { return _items; } }

    public static readonly XNamespace Namespace = "http://www.sitemaps.org/schemas/sitemap/0.9";

    public void Add(SitemapIndexItem itm)
    {
        _items.Add(itm);
    }

    public XElement Serialise()
    {
        XElement root = new XElement("sitemapindex");
        root.Add(new XAttribute("xmlns", Namespace));

        foreach (SitemapIndexItem i in _items)
        {
            root.Add(i.Serialise());
        }

        return root;
    }
}

public class SitemapIndexItem
{
    public string Location { get; set; }
    public DateTime LastModified { get; set; }

    public XElement Serialise()
    {
        XElement root = new XElement("sitemap");

        root.Add(new XElement("loc", Location));
        root.Add(new XElement("lastmod", LastModified.ToString("yyyy-MM-dd")));

        return root;
    }
}

					</pre>
					<p>Again, this pattern of having data classes that know how to serialise themselves will be repeated later...</p>
					<p>So the next bit of code we need is the
						<code>publishSite()</code>
						method mentioned above – to save the data for an individual sitemap. This is a bit more complex, so we'll break it into pieces. First of all, we'll generate the data and store it:</p>
					<pre data-enlighter-language="csharp" style="width:100%; overflow:scroll;">private SiteConfiguration publishSite(Item siteConfig)
{
    SiteConfiguration sc = new SiteConfiguration(siteConfig);

    SitemapUrlSet sitemap = processSite(sc);

    if (sitemap != null)
    {
        string filename = System.Web.Hosting.HostingEnvironment.MapPath("/" + sc.SitemapFilename);
        saveXmlToFile(filename, sitemap.Serialise());
    }

    return sc;
}

					</pre>
					<p>This loads the configuration data that was passed in, calls
						<code>processSite()</code>
						to generate the sitemap data object, serialises it, and then saves the XML to disk in the same way we did before. The config class does a bit more this time:</p>
					<pre data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public class SiteConfiguration
{
    public string SitemapFilename { get; private set; }
    public string SitemapSourceDatabaseName { get; private set; }
    public Database SitemapSourceDatabase { get; private set; }
    public ID SitemapRootItem { get; private set; }
    public IEnumerable&lt;string&gt; SitemapIncludeLanguages { get; private set; }
    public IEnumerable&lt;id&gt; SitemapIncludeTemplates { get; private set; }

    private Language getLanguage(string name)
    {
        Language l;

        if (Language.TryParse(name, out l))
        {
            return l;
        }

        return null;
    }

    public SiteConfiguration(Item siteItem)
    {
        SitemapFilename = siteItem.Fields[Identifiers.SitemapFilenameFieldID].Value;

        SitemapSourceDatabaseName = siteItem.Fields[Identifiers.SitemapSourceDatabaseFieldID].Value;

        SitemapSourceDatabase = Sitecore.Configuration.Factory.GetDatabase(SitemapSourceDatabaseName);

        ID rootItem = ID.Null;
        ID.TryParse(siteItem.Fields[Identifiers.SitemapRootItemFieldID].Value, out rootItem);
        SitemapRootItem = rootItem;

        SitemapIncludeLanguages = siteItem.Fields[Identifiers.SitemapIncludeLanguagesFieldID].Value.Split('|')
            .Where(s =&gt; !string.IsNullOrWhiteSpace(s))
            .Select(s =&gt; ID.Parse(s))
            .Select(i =&gt; SitemapSourceDatabase.GetItem(i))
            .Select(l =&gt; l.Name);

        SitemapIncludeTemplates = siteItem.Fields[Identifiers.SitemapIncludeTemplatesFieldID].Value.Split('|')
            .Where(s =&gt; !string.IsNullOrWhiteSpace(s))
            .Select(s =&gt; ID.Parse(s));
    }
}

					</pre>
					<p>Again, the code is extracting the fields from the configuration template for the sitemap that we defined last week. There's a bit more effort here to get the content database we need, parse out the ID values and extract the lists of languages and templates to include. Linq projections are used to get the data in the appropriate format.</p>
					<p>So the
						<code>processSite()</code>
						method looks like:</p>
					<pre data-enlighter-language="csharp" style="width:100%; overflow:scroll;">private SitemapUrlSet processSite(SiteConfiguration sc)
{
    Item rootItem = sc.SitemapSourceDatabase.GetItem(sc.SitemapRootItem);
    SitemapUrlSet sitemap = new SitemapUrlSet();

    process(sc, sitemap, rootItem);
    
    return sitemap;
}

					</pre>
					<p>This doesn't do a great deal – it fetches the root item from the database, creates an empty
						<code>SitemapUrlSet</code>
						object to gather the data and calls
						<code>process()</code>
						on the root item to start generating data. This code is factored out into a recursive method, as we need to transform the tree of Sitecore content into a list of entries for the sitemap file. That process is broken up into two parts – first we generate the set of URLs for the current item (it can be more than one URL due to language versions). Second we process any children this item has:</p>
					<pre data-enlighter-language="csharp" style="width:100%; overflow:scroll;">private void process(SiteConfiguration sc, SitemapUrlSet urls, Item item)
{
    IEnumerable&lt;sitemapurl&gt; u = buildSitemapUrl(sc, item);
    if (u != null &amp;&amp; u.Count() &gt; 0)
    {
        urls.AddRange(u);
    }

    foreach (Item child in item.Children)
    {
        process(sc, urls, child);
    }
}

					</pre>
					<p>And then we can generate the list of URLs for an individual item:</p>
					<pre data-enlighter-language="csharp" style="width:100%; overflow:scroll;">private IEnumerable&lt;sitemapurl&gt; buildSitemapUrl(SiteConfiguration sc, Item item)
{
    if(sc.SitemapIncludeTemplates.Count() &gt; 0 &amp;&amp; !sc.SitemapIncludeTemplates.Contains(item.TemplateID))
    {
        return null;
    }

    if (item.Fields.Contains(Identifiers.SitemapIncludeFieldID))
    {
        CheckboxField cf = (CheckboxField)item.Fields[Identifiers.SitemapIncludeFieldID];
        if(!cf.Checked)
        {
            return null;
        }
    }

    List&lt;sitemapurl&gt; urls = new List&lt;sitemapurl&gt;();
    foreach (Language l in item.Languages)
    {
        if (sc.SitemapIncludeLanguages.Contains(l.Name))
        {
            Item i = sc.SitemapSourceDatabase.GetItem(item.ID, l);
            if (i.Versions.Count &gt; 0)
            {
                SitemapUrl u = processLanguage(sc, i, l);
                if (u != null)
                {
                    urls.Add(u);
                }
            }
        }
    }
    return urls;
}

					</pre>
					<p>This method starts by checking if the item being processed is based on one of the templates that have been specified for inclusion into the sitemap file. If templates have been specified, but this item is not based on one of them then we skip this item by returning null. Next we check if this item includes our "should this item be included in the sitemap" flag. If it does we check its value. If it says no, then we skip the item.</p>
					<p>Finally we need to process each of the languages our item defines. We test if this language should be included or not. If the language should be included then we re-load the item in that language and check we got a valid version. If so, we process that version to generate the Sitemap file entry data:</p>
					<pre data-enlighter-language="csharp" style="width:100%; overflow:scroll;">private SitemapUrl processLanguage(SiteConfiguration sc, Item item, Language l)
{
    SitemapUrl url = new SitemapUrl();

    var urlOptions = new Sitecore.Links.UrlOptions()
    {
        AlwaysIncludeServerUrl = true,
        LanguageEmbedding = Sitecore.Links.LanguageEmbedding.AsNeeded,
        ShortenUrls = true,
        Language = l
    };

    url.Location = Sitecore.Links.LinkManager.GetItemUrl(item, urlOptions);

    DateField df = (DateField)item.Fields[Identifiers.__UpdatedFieldID];
    url.LastModified = df.DateTime;

    if (item.Fields.Contains(Identifiers.SitemapPriorityFieldID))
    {
        float f;
        if (float.TryParse(item.Fields[Identifiers.SitemapPriorityFieldID].Value, out f))
        {
            url.Priority = f;
        }
    }

    if (item.Fields.Contains(Identifiers.SitemapChangeFrequencyFieldID))
    {
        ChangeFrequency cf;
        if (Enum.TryParse&lt;changefrequency&gt;(item.Fields[Identifiers.SitemapChangeFrequencyFieldID].Value, true, out cf))
        {
            url.ChangeFrequency = cf;
        }
    }

    return url;
}

					</pre>
					<p>As we did with the index file above, we use
						<code>LinkManager</code>
						to generate the correct URL for the item. And we extract all the relevant bits of data out of the website item into our
						<code>SitemapUrl</code>
						data object. We check if some of the fields exist before processing them, in case we're generating data for an item which doesn't provide our custom
						<code>SitemapItemExtensions</code>
						data template.</p>
					<p>So the last thing we need is the code for the
						<code>SitemapUrlSet</code>
						and
						<code>SitemapUrl</code>
						classes that we need to serialise into our sitemap xml data:</p>
					<pre data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public class SitemapUrlSet
{
    private List&lt;sitemapurl&gt; _urls = new List&lt;sitemapurl&gt;();

    public IEnumerable&lt;sitemapurl&gt; SitemapUrls { get { return _urls; } }

    public void Add(SitemapUrl url)
    {
        _urls.Add(url);
    }

    public void AddRange(IEnumerable&lt;sitemapurl&gt; urls)
    {
        _urls.AddRange(urls);
    }

    public static readonly XNamespace Namespace = "http://www.sitemaps.org/schemas/sitemap/0.9";

    public XElement Serialise()
    {
        XElement root = new XElement("urlset");
        root.Add(new XAttribute("xmlns", Namespace));
        root.Add(new XAttribute(XNamespace.Xmlns + "image", SitemapImage.Namespace));

        foreach (SitemapUrl u in _urls)
        {
            root.Add(u.Serialise());
        }

        return root;
    }
}

public enum ChangeFrequency 
{
    Always,
    Hourly,
    Daily,
    Weekly,
    Monthly,
    Yearly,
    Never
}

public class SitemapUrl
{
    public string Location { get; set; }
    public DateTime? LastModified { get; set; }
    public ChangeFrequency? ChangeFrequency { get; set; }
    public Single? Priority { get; set; }

    public XElement Serialise()
    {
        XElement root = new XElement("url");

        root.Add(new XElement("loc", Location));
        
        if(LastModified.HasValue)
        {
            root.Add(new XElement("lastmod", LastModified.Value.ToString("yyyy-MM-dd")));
        }

        if (ChangeFrequency.HasValue)
        {
            root.Add(new XElement("changefreq", ChangeFrequency.Value.ToString().ToLower()));
        }

        if (Priority.HasValue)
        {
            root.Add(new XElement("priority", Priority.Value.ToString("0.0")));
        }

        return root;
    }
}

					</pre>
					<p>And that's it for the code. We can now set up a test, and try building a sitemap. If we set up a Sitemap Index:</p>
					<a target="_blank" rel="noopener noreferrer" href="/img/2014/ExampleSitemapSettings.png">
						<img alt="Example sitemap settings" src="/img/2014/ExampleSitemapSettings.png">
					</a>
					<p>And configure it to contain a single Sitemap file that outputs English and Japanese content stored in the Sample Item template:</p>
					<a target="_blank" rel="noopener noreferrer" href="/img/2014/DefaultSitemapSettings.png">
						<img alt="Default sitemap settings" src="/img/2014/DefaultSitemapSettings.png">
					</a>
					<p>Then we can set up a bit of test content and hit publish. What we find on disk afterwards is two XML files. First, in the index file we find:</p>
					<pre data-enlighter-language="xml" style="width:100%; overflow:scroll;">&lt;sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"&gt;
  &lt;sitemap&gt;
    &lt;loc&gt;http://test/default-sitemap.xml&lt;/loc&gt;
    &lt;lastmod&gt;2014-59-12&lt;/lastmod&gt;
  &lt;/sitemap&gt;
&lt;/sitemapindex&gt;

					</pre>
					<p>And then in the sitemap itself we find:</p>
					<pre data-enlighter-language="xml" style="width:100%; overflow:scroll;">&lt;urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:image="http://www.google.com/schemas/sitemap-image/1.1"&gt;
  &lt;url&gt;
    &lt;loc&gt;http://test/en/sitecore/content/Home&lt;/loc&gt;
    &lt;lastmod&gt;2014-10-05&lt;/lastmod&gt;
    &lt;changefreq&gt;daily&lt;/changefreq&gt;
    &lt;priority&gt;0.7&lt;/priority&gt;
  &lt;/url&gt;
  &lt;url&gt;
    &lt;loc&gt;http://test/ja-JP/sitecore/content/Home&lt;/loc&gt;
    &lt;lastmod&gt;2013-09-11&lt;/lastmod&gt;
    &lt;changefreq&gt;daily&lt;/changefreq&gt;
    &lt;priority&gt;0.7&lt;/priority&gt;
  &lt;/url&gt;
  &lt;url&gt;
    &lt;loc&gt;http://test/en/sitecore/content/Home/Global shared content/Sample&lt;/loc&gt;
    &lt;lastmod&gt;2014-29-21&lt;/lastmod&gt;
  &lt;/url&gt;
  &lt;url&gt;
    &lt;loc&gt;http://test/en/sitecore/content/Home/Sample Page&lt;/loc&gt;
    &lt;lastmod&gt;2014-12-03&lt;/lastmod&gt;
  &lt;/url&gt;
&lt;/urlset&gt;

					</pre>
					<p>Bingo. There's our sitemap data! It shows the appropriate data, as defined by our test items.</p>
					<p>Now there's quite a bit that could be done here to improve this code – but it proves that the approach works. As mentioned, the usual error checking and patterns like Glass could be applied. One other thing that struck me is that if this code was run against a large site it would be creating lots of small objects in memory before serialising them. So a good optimisation would probably be to write the serialised data directly into the output files without the need for the intermediate objects. That would allow much larger sites to be generated more efficiently.</p>
					<p>And next week, we'll take a look at how we can add image data to the sitemap files...</p>
				</div>
				<div class="lg:flex-none lg:w-72 m-0 mt-1 lg:mt-0 lg:p-1 lg:bg-gray-100">
					<section class="mvp">
						<h3 class="bg-gray-300 p-2">Sitecore MVP 2015-2022</h3>
						<div class="bg-white mb-2 p-2">
							<a href="/mvp">
								<img src="/img/mvp/2022.jpg" width="219" height="219" alt="2022 MVP Badge">
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Top Tags</h3>
						<div class="bg-white p-2 flex flex-wrap">
							<a href="/tags/sitecore/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Sitecore (197)</a>
							<a href="/tags/c/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								C# (46)</a>
							<a href="/tags/powershell/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								PowerShell (31)</a>
							<a href="/tags/installation/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Installation (23)</a>
							<a href="/tags/solr/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Solr (15)</a>
							<a href="/tags/ui/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								UI (14)</a>
							<a href="/tags/general/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								General (13)</a>
							<a href="/tags/docker/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Docker (12)</a>
							<a href="/tags/coveo/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Coveo (12)</a>
							<a href="/tags/packages/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Packages (11)</a>
						</div>
						<div class="bg-white mb-2 p-2">
							<a class="" href="/tags" role="button">All Tags
								<i class="fas fa-angle-double-right"></i>
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Recent Months</h3>
						<div class="bg-white p-2">
							<div>
								<a class="text-lg" href="/posts/2022-03">2022 - March</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2022-02">2022 - February</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2022-01">2022 - January</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2021-12">2021 - December</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2021-11">2021 - November</a>
							</div>
						</div>
						<div class="bg-white mb-2 p-2">
							<a class="" href="/posts" role="button">All Posts
								<i class="fas fa-angle-double-right"></i>
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Twitter</h3>
						<div class="bg-white mb-2 p-2">
							<a class="twitter-timeline" data-height="400" data-chrome="noheader nofooter noborders" href="https://twitter.com/jermdavis">Tweets by JermDavis</a>
							<script async="" defer="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
						</div>
					</section>
				</div>
			</div>
		</div>
		<footer class="lg:flex order-1 bg-gray-100 px-4 lg:px-6 py-4">
			<div class="flex-1 lg:flex-1 text-center lg:text-left">
				<div>©
					<a target="_blank" class="font-medium text-gray-500 hover:text-gray-900" rel="noopener" href="https://jermdavis.dev/">Jeremy Davis</a>
					2014-2022</div>
			</div>
			<div class="lg:flex-1 lg:order-3 text-center lg:text-right">
				<a class="font-medium text-gray-500 hover:text-gray-900" href="/tools">Published using Statiq</a>
				<br>
			</div>
			<ul class="list-none lg:flex-1 lg:order-2 p-0 text-center lg:align-middle" style="margin:0px !important">
				<li class="inline-block">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
					</svg>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium text-gray-500 hover:text-gray-900" target="_blank" href="/feed.rss">RSS</a>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium text-gray-500 hover:text-gray-900" target="_blank" href="/feed.atom">Atom</a>
				</li>
			</ul>
		</footer>
		<div class="min-h-screen bg-gray-300 py-6 flex flex-col justify-center sm:py-12" x-data="{ hide_banner: true }" x-init="hide_banner = docCookies.hasItem('hide_banner');" x-bind:class="{ 'hidden': hide_banner, 'fixed': !hide_banner }">
			<div class="border-2 border-gray-600 bg-gray-100 max-w-screen-lg mx-auto fixed bg-white inset-x-5 p-5 bottom-10 rounded-lg drop-shadow-2xl flex gap-4 flex-wrap md:flex-nowrap text-center md:text-left items-center justify-center md:justify-between">
				<div class="w-full text-lg">
					<a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cookie-usage" rel="noreferrer" target="_blank">This website uses Google Analytics, and its cookies.</a>
				</div>
				<button type="button" @click="hide_banner = true; docCookies.setItem('hide_banner', true, 'Fri, 31 Dec 9999 23:59:59 GMT', null, null, null, 'strict');" class="bg-gray-400 px-5 py-2 text-white rounded-md hover:bg-gray-600 focus:outline-none" aria-label="Dismiss">Understood</button>
			</div>
		</div>
		<script src="/vendor/Alpine/alpine.3.7.1.min.js" defer=""></script>
		<script src="/vendor/Enlighter/enlighterjs.min.js"></script>
		<script type="text/javascript">
        EnlighterJS.init('pre', 'code', {
            theme: 'droide',
            indent : 4,
            linehover : false,
            textOverflow: 'scroll',
            toolbarTop: '',
            toolbarBottom: ''
        });
    
		</script>
		<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JQ44ZR47YX"></script>
		<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-JQ44ZR47YX');
    
		</script>
	</body>
</html>