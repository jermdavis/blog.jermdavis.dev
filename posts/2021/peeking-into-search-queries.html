<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' *.twitter.com unpkg.com www.googletagmanager.com *.twimg.com; img-src 'self' data: *;style-src 'self' 'unsafe-inline' *.twitter.com *.twimg.com">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="Sitecore, C# and web development">
        <meta name="author" content="Jeremy Davis">
        <meta name="copyright" content="Jeremy Davis">

    <title>Jeremy Davis - Peeking into search&nbsp;queries</title>

    <link rel="canonical" href="https://blog.jermdavis.dev/posts/2021/peeking-into-search-queries">
    <meta name="robots" content="noindex, nofollow">

            <link type="application/rss+xml" rel="alternate" href="/feed.rss">
            <link type="application/atom+xml" rel="alternate" href="/feed.atom">

    <meta name="application-name" content="Jeremy Davis">
    <meta name="msapplication-tooltip" content="Jeremy Davis">
    <meta name="msapplication-starturl" content="/">
    <link rel="manifest" href="/manifest.json">

    
    <meta property="og:title" content="Jeremy Davis - Peeking into search&nbsp;queries">
        <meta property="og:image" content="/img/featured/peeking-into-search-queries-social.png">
    <meta property="og:description" content="">
<meta property="og:url" content="https://blog.jermdavis.dev/posts/2021/peeking-into-search-queries">
<meta property="og:type" content="website">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">

    <link href="/scss/tailwind.css" rel="stylesheet">

    <link href="/vendor/Enlighter/enlighterjs.min.css" rel="stylesheet">
    <link href="/scss/site-theme.css" rel="stylesheet">


    <script src="/vendor/Cookies/cookies.min.js" defers=""></script>

    

    
</head>

<body class="max-w-7xl mx-auto">
    <div class="relative bg-white" x-data="{ open: false }">

    <!-- desktop -->
    <div class="px-4 lg:px-6 bg-gray-100">
        <div class="flex justify-between items-center border-b-2 border-gray-100 py-6 lg:justify-start lg:space-x-10">

            <div class="flex justify-start lg:w-0 flex-1">
                <a href="/">
                    <img class="h-12 lg:h-14 w-12 lg:w-14 mt-2" src="/img/Profile.jpg" alt="Jeremy Davis">
                </a>
                <div class="mx-2">
                    <div class="text-3xl">Jeremy Davis</div>
                    <div class="text-lg">Sitecore, C# and web development</div>
                </div>
            </div>

            <div class="-mr-2 -my-2 lg:hidden">
                <button @click="open = true" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-expanded="false">
                    <span class="sr-only">Open menu</span>
                    <!-- Heroicon name: outline/menu -->
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>

            <nav class="hidden lg:flex space-x-10">
<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/posts">Posts</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/tags">Tags</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/about">About</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/links">Useful Links</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/mvp">MVP</a>            </nav>

        </div>
    </div>

    <!--Mobile menu, show/hide based on mobile menu state.-->
    <div class="absolute top-0 inset-x-0 p-2 transition transform origin-top-right lg:hidden z-50">

        <div class="rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 bg-white divide-y-2 divide-gray-50" x-show="open" x-transition="">
            <div class="pt-5 pb-6 px-5">
                <div class="flex items-center justify-between">
                    <div class="flex">
                        <a href="/">
                            <img class="h-12 w-12 mt-2" src="/img/Profile.jpg" alt="Jeremy Davis">
                        </a>
                        <div class="mx-2">
                            <div class="text-2xl">Jeremy Davis</div>
                            <div class="text-base">Sitecore, C# and web development</div>
                        </div>
                    </div>

                    <div class="-mr-2">
                        <button @click="open = false" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
                            <span class="sr-only">Close menu</span>
                            <!-- Heroicon name: outline/x -->
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="py-6 px-5 pt-0">
                <nav class=" gap-x-8">
<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/posts">Posts</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/tags">Tags</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/about">About</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/links">Useful Links</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/mvp">MVP</a>                </nav>
            </div>

        </div>
    </div>
</div>

    <header class="bg-gray-300 px-4 py-1 lg:px-6 text-center" style="background-image: url(&quot;/&quot;);">
    <div class="post-heading">
        <h1 class="text-5xl mb-4 pb-1">
        Peeking into search&nbsp;queries
        </h1>
            <div class="meta">Published 20 January 2021</div>
                <div class="meta">Updated 01 February 2021</div>
            <div class="flex py-1">
                    <a href="/tags/contentsearch" class="p-1 mr-1 bg-gray-100 rounded-md"> ContentSearch</a>
                    <a href="/tags/sitecore" class="p-1 mr-1 bg-gray-100 rounded-md"> Sitecore</a>
                    <a href="/tags/solr" class="p-1 mr-1 bg-gray-100 rounded-md"> Solr</a>
            </div>
    </div>
</header>

    <div class="py-2 lg:pl-3">
        <div class="lg:flex">
            <div class="lg:flex-auto mx-3 lg:min-w-0 content">
                <p>An issue I've bumped into a number of times over the years, is that sometimes developers want to be able to look at the query that got generated when they did something with Sitecore's ContentSearch APIs. The traditional answer of "go look in the logs" is one way to deal with this, but some recent project work got me wondering if there were alternatives...<!--more--></p>
<h2>What's the issue?</h2>
<p>When you fire up some code for a query, you're generally using something vaguely along the lines of:</p>
<pre data-enlighter-language="csharp" style="width:100%; overflow:scroll;">ISearchIndex index = ContentSearchManager.GetIndex("your_index_name");
using (var context = index.CreateSearchContext())
{
    var query = context.GetQueryable&lt;SearchResultItem&gt;();
    
    // add some parameters to your filter your query
    // add some sort order
    // add some pagination

    var results = query.GetResults();

    // do somethig with the results
}
</pre>
<p>But what happens if you need to debug this query? A call to <code>GetQueryable&lt;T&gt;()</code> gets you back an <code>IQueryable&lt;T&gt;</code>. And based on that type there's no obvious "here's your query" property. And that makes sense, when you think about it. The <code>IQueryable&lt;T&gt;</code> interface is a generic representation of a query - it doesn't know anything specific about Solr, Azure Search or any other Sitecore provider. But that raw quey must get generated at some point in order to run the search – and we know it turns up in the logs. You can look at any of the <code>Search.log.*.*.txt</code> files that Sitecore writes and see things like:</p>
<pre data-enlighter-theme="droide-text" data-enlighter-highlight="4" data-enlighter-language="text" style="width:100%; overflow:scroll;">3044 15:25:54 INFO  Warming and Caching your search indexes
3044 15:25:54 INFO  /******* Warming Queries ********/
3044 15:25:54 INFO  /*************************/
2780 15:36:15 INFO  Solr Query - ?q=(_name:(item*) OR (_content:(*item*) OR _name:(item) OR (_content:(item) AND _language:(en)))) AND _val_:__boost&amp;start=0&amp;rows=1000000&amp;fq=_indexname:(sitecore_master_index)&amp;wt=xml
</pre>
<p>That's got your debugging needs covered in most scenarios – but it doesn't help when your code wants to know what the query looks like at runtime...</p>
<p>Why might you need that? Well one example might be something like this: My colleagues are working on some fancy search UI which involves grouping. If you look up how to do grouping with Solr and ContentSearch in the Sitecore docs <a href="https://doc.sitecore.com/developers/92/platform-administration-and-architecture/en/using-solr-to-group-search-results.html" rel="noopener" target="_blank">you get this example</a>:</p>
<p><a href="/img/2021/2021-01-solrquery.png" target="_blank"><img alt="Solr Query" src="/img/2021/2021-01-solrquery.png"></a></p>
<p>The grouping code example provided wants the query as text to perform grouping on – not as an <code>IQueryable</code>. And that's how I got wrapped up in this: is it possible to take a query object and extract its query text?</p>
<h2>Working towards an answer...</h2>
<p>When you're looking at your code in Visual Studio, the query you generate by calling <code>GetQueryable&lt;T&gt;()</code> is of type <code>IQuerable&lt;T&gt;</code>. But because that's an interface, it can't be the actual type that's used at runtime. What happens if you look at the query while the code is running?</p>
<p><a href="/img/2021/2021-01-datatype.png" target="_blank"><img alt="Data Type" src="/img/2021/2021-01-datatype.png"></a></p>
<p>Well at runtime has we have <code>GenericQueryable&lt;T, SolrCompositeQuery&gt;</code> as it's concrete type. That looks like it might be more helpful. What does that give us?</p>
<pre data-enlighter-highlight="17" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public class GenericQueryable&lt;TElement, TQuery&gt; : IOrderedQueryable&lt;TElement&gt;, IQueryable&lt;TElement&gt;, IEnumerable&lt;TElement&gt;, IEnumerable, IQueryable, IOrderedQueryable, IQueryProvider, IHasNativeQuery&lt;TQuery&gt;, IHasNativeQuery, IHasTraceWriter, IContentSearchQueryable
{
    public GenericQueryable(Index&lt;TElement, TQuery&gt; index, QueryMapper&lt;TQuery&gt; queryMapper, IQueryOptimizer queryOptimizer, FieldNameTranslator fieldNameTranslator, IExpressionParser parser);
    protected GenericQueryable(Index&lt;TQuery&gt; index, QueryMapper&lt;TQuery&gt; queryMapper, IQueryOptimizer queryOptimizer, Expression expression, Type itemType, FieldNameTranslator fieldNameTranslator, IExpressionParser parser);
    public FieldNameTranslator FieldNameTranslator { get; set; }
    public IQueryOptimizer QueryOptimizer { get; set; }
    public virtual IQueryProvider Provider { get; }
    public virtual Expression Expression { get; }
    public virtual Type ElementType { get; }
    protected Type ItemType { get; set; }
    protected Index&lt;TQuery&gt; Index { get; set; }
    protected IExpressionParser Parser { get; set; }
    protected QueryMapper&lt;TQuery&gt; QueryMapper { get; set; }
    public virtual IQueryable&lt;TElement&gt; CreateQuery&lt;TElement&gt;(Expression expression);
    public virtual TResult Execute&lt;TResult&gt;(Expression expression);
    public virtual IEnumerator&lt;TElement&gt; GetEnumerator();
    public TQuery GetQuery();
    protected virtual TQuery GetQuery(Expression expression);
    protected virtual void Trace(IDumpable dumpable, string title);
    protected virtual void Trace(Expression expression, string title);
}
</pre>
<p>There's a lot going on there... But one thing stands out: the <code>GetQuery()</code> method. It's returning an object of the <code>SolrCompositeQuery</code> type, and poking about inside that shows it has a very interesting looking <code>ToString()</code> method:</p>
<pre data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public override string ToString()
{
	DefaultQuerySerializerEx defaultQuerySerializerEx = new DefaultQuerySerializerEx((ISolrFieldSerializer)(object)new DefaultFieldSerializer());
	return defaultQuerySerializerEx.Serialize(Query);
}
</pre>
<p>A query serialiser seems like exactly what would help...</p>
<p>So what happens if we pull that together into a code snippet and give it a try? Well you need to <a href="https://sitecore.myget.org/feed/sc-packages/package/nuget/Sitecore.ContentSearch.Linq.Solr/10.0.0" rel="noopener" target="_blank">add a reference to <code>Sitecore.ContentSearch.Linq.Solr.dll</code></a> in order to do this, but it works out fairly simply:</p>
<pre data-enlighter-language="csharp" style="width:100%; overflow:scroll;">ISearchIndex index = ContentSearchManager.GetIndex("your_index_name");
using (var context = index.CreateSearchContext())
{
    var q = context.GetQueryable&lt;SearchResultItem&gt;();

    // Set up your query with something appropriate to your work..
    q = q.Where(r =&gt; r.Name == "test");
    // add whatever else is necessary for ordering etc.

    var genericQuery = q as GenericQueryable&lt;SearchResultItem, SolrCompositeQuery&gt;;
    var solrCompositeQuery = genericQuery.GetQuery();
    string queryText = solrCompositeQuery.ToString();

    return queryText;
}
</pre>
<p>And when you run that you do get back something that looks like a query. For example, the test above returns <code>_name:(test) AND _val_:__boost</code>. And pasting that into Solr's UI gives results:</p>
<p><a href="/img/2021/2021-01-querytest.png" target="_blank"><img alt="Query Test" src="/img/2021/2021-01-querytest.png"></a></p>
<p>That looks like success...</p>
<p>I've not tested this with Azure search, but based on a bit of poking around with <a href="https://github.com/icsharpcode/ILSpy" rel="noopener" target="_blank">ILSpy</a> it looks like <code>Sitecore.ContentSearch.Azure.Query.CloudQuery</code> is the equivalent of <code>SolrCompositeQuery</code> if you're not using Solr. That type returns a string that looks like it should be the query text.</p>


            </div>
            <div class="lg:flex-none lg:w-72 m-0 mt-1 lg:mt-0 lg:p-1 lg:bg-gray-100">
                <section class="mvp">
    <h3 class="bg-gray-300 p-2">Sitecore MVP 2015-2021</h3>
    <div class="bg-white mb-2 p-2"><a href="/mvp"><img src="/img/mvp/2021.jpg" width="219" height="219" alt="2021 MVP Badge"></a></div>
</section>

<section>
    <h3 class="bg-gray-300 p-2">Top Tags</h3>
    <div class="bg-white p-2 flex flex-wrap">
                    <a href="/tags/sitecore" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Sitecore (193)</a>
                    <a href="/tags/c" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> C# (45)</a>
                    <a href="/tags/powershell" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> PowerShell (31)</a>
                    <a href="/tags/installation" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Installation (23)</a>
                    <a href="/tags/solr" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Solr (15)</a>
                    <a href="/tags/ui" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> UI (14)</a>
                    <a href="/tags/general" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> General (12)</a>
                    <a href="/tags/coveo" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Coveo (12)</a>
                    <a href="/tags/visual-studio" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Visual Studio (11)</a>
                    <a href="/tags/docker" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Docker (10)</a>
    </div>
    <div class="bg-white mb-2 p-2">
        <a class="" href="/tags" role="button">All Tags <i class="fas fa-angle-double-right"></i></a>
    </div>
</section>

<section>
    <h3 class="bg-gray-300 p-2">Recent Months</h3>
    <div class="bg-white p-2">
                <div><a class="text-lg" href="/posts/2021-11">2021 - November</a></div>
                <div><a class="text-lg" href="/posts/2021-10">2021 - October</a></div>
                <div><a class="text-lg" href="/posts/2021-09">2021 - September</a></div>
                <div><a class="text-lg" href="/posts/2021-08">2021 - August</a></div>
                <div><a class="text-lg" href="/posts/2021-07">2021 - July</a></div>
    </div>
    <div class="bg-white mb-2 p-2">
        <a class="" href="/posts" role="button">All Posts <i class="fas fa-angle-double-right"></i></a>
    </div>
</section>

<section>
    <h3 class="bg-gray-300 p-2">Twitter</h3>
    <div class="bg-white mb-2 p-2">
        <a class="twitter-timeline" data-height="400" data-chrome="noheader nofooter noborders" href="https://twitter.com/jermdavis">Tweets by JermDavis</a>
        <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    </div>
</section>
            </div>
        </div>
    </div>

    <footer class="lg:flex order-1 bg-gray-100 px-4 lg:px-6 py-4">
    <div class="flex-1 lg:flex-1 text-center lg:text-left">
        <div>© <a target="_blank" class="font-medium text-gray-500 hover:text-gray-900" rel="noopener" href="https://jermdavis.dev/">Jeremy Davis</a> 2014-2021</div>
    </div>

    <div class="lg:flex-1 lg:order-3 text-center lg:text-right">
        <a class="font-medium text-gray-500 hover:text-gray-900" href="/tools">Published using Statiq</a><br>
    </div>

    <ul class="list-none lg:flex-1 lg:order-2 p-0 text-center lg:align-middle" style="margin:0px !important">
        <li class="inline-block">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
            </svg>
        </li>
            <li class="inline-block ml-4">
                <a class="font-medium text-gray-500 hover:text-gray-900" target="_blank" href="/feed.rss">RSS</a>
            </li>
            <li class="inline-block ml-4">
                <a class="font-medium text-gray-500 hover:text-gray-900" target="_blank" href="/feed.atom">Atom</a>
            </li>
    </ul>
</footer>

    <div class="min-h-screen bg-gray-300 py-6 flex flex-col justify-center sm:py-12" x-data="{ hide_banner: true }" x-init="hide_banner = docCookies.hasItem('hide_banner');" x-bind:class="{ 'hidden': hide_banner, 'fixed': !hide_banner }">
        <div class="border-2 border-gray-600 bg-gray-100 max-w-screen-lg mx-auto fixed bg-white inset-x-5 p-5 bottom-10 rounded-lg drop-shadow-2xl flex gap-4 flex-wrap md:flex-nowrap text-center md:text-left items-center justify-center md:justify-between">
            <div class="w-full text-lg">
                <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cookie-usage" rel="noreferrer" target="_blank">This website uses Google Analytics, and its cookies.</a>
            </div>
            <button type="button" @click="hide_banner = true; docCookies.setItem('hide_banner', true, (7*24*60*60));" class="bg-gray-400 px-5 py-2 text-white rounded-md hover:bg-gray-600 focus:outline-none" aria-label="Dismiss">Understood</button>
        </div>
    </div>
    
    <script src="https://unpkg.com/alpinejs" defer=""></script>    
    <script src="/vendor/Enlighter/enlighterjs.min.js"></script>

    <script type="text/javascript">
        EnlighterJS.init('pre', 'code', {
            theme: 'droide',
            indent : 4,
            linehover : false,
            textOverflow: 'scroll',
            toolbarTop: '',
            toolbarBottom: ''
        });
    </script>

    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JQ44ZR47YX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-JQ44ZR47YX');
    </script>

    

    



</body></html>