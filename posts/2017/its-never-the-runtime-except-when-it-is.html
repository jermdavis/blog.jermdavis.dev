<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' www.youtube.com *.twitter.com unpkg.com www.googletagmanager.com *.google-analytics.com *.twimg.com; img-src 'self' data: *;style-src 'self' 'unsafe-inline' *.twitter.com *.twimg.com">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="canonical" href="https://blog.jermdavis.dev/posts/2017/its-never-the-runtime-except-when-it-is">
		<meta name="description" content="<a href=&quot;/img/2017/2017-06-bug-162019_640.png&quot; target=&quot;_blank&quot;><img alt=&quot;Bug&quot; src=&quot;/img/2017/2017-06-bug-162019_640.png&quot;></a>Something I've learned over the course of many years working in IT is that when you hit a difficult to explain problem it's very easy to say &quot;it's the runtime's fault!&quot; or &quot;that's a compiler bug&quot; to cover for the lack of explanation for your problem. The vast majority of the time, it's not true though. It's just a subtler bug in your own work that you can't see yet.
Every so often, however, it is true. And it turns out t<a href=&quot;/posts/2017/what-went-wrong-with-my-media&quot; target=&quot;_blank&quot;>he issue I discussed the other week about Sitecore rendering a Razor error when you asked for a media item</a> may well be an example of this.">
		<meta property="og:description" content="<a href=&quot;/img/2017/2017-06-bug-162019_640.png&quot; target=&quot;_blank&quot;><img alt=&quot;Bug&quot; src=&quot;/img/2017/2017-06-bug-162019_640.png&quot;></a>Something I've learned over the course of many years working in IT is that when you hit a difficult to explain problem it's very easy to say &quot;it's the runtime's fault!&quot; or &quot;that's a compiler bug&quot; to cover for the lack of explanation for your problem. The vast majority of the time, it's not true though. It's just a subtler bug in your own work that you can't see yet.
Every so often, however, it is true. And it turns out t<a href=&quot;/posts/2017/what-went-wrong-with-my-media&quot; target=&quot;_blank&quot;>he issue I discussed the other week about Sitecore rendering a Razor error when you asked for a media item</a> may well be an example of this.">
		<meta name="keywords" content=".Net, Bug, Sitecore">
		<meta name="author" content="Jeremy Davis">
		<meta name="copyright" content="Jeremy Davis">
		<title>Jeremy Davis - It's never the runtime... (Except when it&nbsp;is)</title>
		<meta name="robots" content="index, follow">
		<link type="application/rss+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.rss">
		<link type="application/atom+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.atom">
		<meta name="application-name" content="Jeremy Davis">
		<meta name="msapplication-tooltip" content="Jeremy Davis">
		<meta name="msapplication-starturl" content="/">
		<link rel="manifest" href="/manifest.webmanifest">
		<meta property="og:title" content="Jeremy Davis - It&amp;#x27;s never the runtime... (Except when it&amp;#xA0;is)">
		<meta property="og:publish_date" content="2017-06-12T00:00:00+00:00">
		<meta property="og:modified_date" content="2018-06-26T00:00:00+00:00">
		<meta property="og:image" content="https://blog.jermdavis.dev/img/featured/its-never-the-runtime-except-when-it-is-social.jpg?">
		<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": "It&#x27;s never the runtime... (Except when it&#xA0;is)",
        "image": [
            "https://blog.jermdavis.dev/img/featured/its-never-the-runtime-except-when-it-is-social.jpg"
        ],
        "datePublished": "2017-06-12T00:00:00+00:00",
        "dateModified": "2018-06-26T00:00:00+00:00",
        "author": [{
            "@type": "Person",
            "name": "Jeremy Davis",
            "url": "https://jermdavis.dev/"
        }]
    }
    
		</script>
		<meta property="og:url" content="https://blog.jermdavis.dev/posts/2017/its-never-the-runtime-except-when-it-is">
		<meta property="og:type" content="website">
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">
		<link href="/scss/tailwind.css" rel="stylesheet" async="">
		<link href="/vendor/Enlighter/enlighterjs.min.css" rel="stylesheet" async="">
		<link href="/scss/site-theme.css" rel="stylesheet" async="">
		<script src="/vendor/Cookies/cookies.min.js" defer=""></script>
	</head>
	<body class="max-w-7xl mx-auto text-black">
		<div class="relative bg-white" x-data="{ open: false }">
			
			<!-- desktop -->
			<div class="px-4 lg:px-6 bg-gray-100">
				<div class="bannerContainer flex justify-between items-center border-b-2 border-gray-100 py-6 lg:justify-start lg:space-x-10">
					<div class="flex justify-start lg:w-0 flex-1">
						<a href="/">
							<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
						</a>
						<div class="mx-2">
							<div class="text-3xl">Jeremy Davis</div>
							<div class="text-lg">Sitecore, C# and web development</div>
						</div>
					</div>
					<div class="nav -mr-2 -my-2 lg:hidden">
						<button @click="open = true" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-expanded="false">
							<span class="sr-only">Open menu</span>
							
							<!-- Heroicon name: outline/menu -->
							<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
							</svg>
						</button>
					</div>
					<nav class="nav hidden lg:flex space-x-10">
						<a class="text-base font-medium" href="/posts">Posts</a>
						<a class="text-base font-medium" href="/tags">Tags</a>
						<a class="text-base font-medium" href="/about">About</a>
						<a class="text-base font-medium" href="/links">Useful Links</a>
						<a class="text-base font-medium" href="/mvp">MVP</a>
					</nav>
				</div>
			</div>
			
			<!--Mobile menu, show/hide based on mobile menu state.-->
			<div class="absolute top-0 inset-x-0 p-2 transition transform origin-top-right lg:hidden z-50">
				<div class="rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 bg-white divide-y-2 divide-gray-50" x-show="open" x-transition="">
					<div class="pt-5 pb-6 px-5">
						<div class="flex items-center justify-between">
							<div class="flex">
								<a href="/">
									<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
								</a>
								<div class="mx-2">
									<div class="text-2xl">Jeremy Davis</div>
									<div class="text-base">Sitecore, C# and web development</div>
								</div>
							</div>
							<div class="nav -mr-2">
								<button @click="open = false" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
									<span class="sr-only">Close menu</span>
									
									<!-- Heroicon name: outline/x -->
									<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
									</svg>
								</button>
							</div>
						</div>
					</div>
					<div class="nav py-6 px-5 pt-0">
						<nav class=" gap-x-8">
							<a class="block mt-5 text-base font-medium" href="/posts">Posts</a>
							<a class="block mt-5 text-base font-medium" href="/tags">Tags</a>
							<a class="block mt-5 text-base font-medium" href="/about">About</a>
							<a class="block mt-5 text-base font-medium" href="/links">Useful Links</a>
							<a class="block mt-5 text-base font-medium" href="/mvp">MVP</a>
						</nav>
					</div>
				</div>
			</div>
		</div>
		<header class="bg-gray-300 px-4 py-1 lg:px-6 text-center" style="">
			<div class="post-heading">
				<div class="url p-1 bg-gray-100 rounded-md">Article printed from:
					<tt>https://blog.jermdavis.dev/posts/2017/its-never-the-runtime-except-when-it-is</tt>
				</div>
				<h1 class="text-5xl mb-4 pb-1">
					It's never the runtime... (Except when it&nbsp;is)
				</h1>
				<div class="meta">Published 12 June 2017</div>
				<div class="meta">Updated 26 June 2018</div>
				<div class="flex py-1">
					<a href="/tags/net/" class="p-1 mr-1 bg-gray-100 rounded-md">
						.Net</a>
					<a href="/tags/bug/" class="p-1 mr-1 bg-gray-100 rounded-md">
						Bug</a>
					<a href="/tags/sitecore/" class="p-1 mr-1 bg-gray-100 rounded-md">
						Sitecore</a>
				</div>
			</div>
		</header>
		<div class="py-2 lg:pl-3">
			<div class="lg:flex">
				<div class="lg:flex-auto mx-3 lg:min-w-0 content">
					<p>
						<a href="/img/2017/2017-06-bug-162019_640.png" target="_blank">
							<img alt="Bug" src="/img/2017/2017-06-bug-162019_640.png">
						</a>Something I've learned over the course of many years working in IT is that when you hit a difficult to explain problem it's very easy to say "it's the runtime's fault!" or "that's a compiler bug" to cover for the lack of explanation for your problem. The vast majority of the time, it's not true though. It's just a subtler bug in your own work that you can't see yet.</p>
					<p>Every so often, however, it is true. And it turns out t<a href="/posts/2017/what-went-wrong-with-my-media" target="_blank">he issue I discussed the other week about Sitecore rendering a Razor error when you asked for a media item</a>
						may well be an example of this.
						<!--more-->
					</p>
					<h2>Getting to the bottom of the issue...</h2>
					<p>When I wrote my previous post, my colleagues and I had worked out how to resolve the problem we saw, but didn't understand what the underlying issue that caused it actually was. Since then one of my colleagues has spent further time discussing our situation with the team at Sitecore Support and they've provided some really helpful feedback about what the underlying issue might be. And the surprise is that they're pinning it on a .Net Framework bug.</p>
					<p>Their explanation describes a particular set of circumstances.</p>
					<p>Each request you make goes through
						<code>System.Web.WebPages.WebPageHttpModule</code>
						which eventually calls
						<code>System.Web.WebPages.WebPageRoute.MatchRequest()</code>. Part of the logic inside that method calls
						<code>WebPageRoute.FileExists()</code>. That in turn depends on
						<code>System.Web.Util.FileUtil.IsSuspiciousPhysicalPath()</code>
						to look for some common scenarios that might indicate a malicious request. If all that succeeds, our media requests should end up with the custom handler that Sitecore provides for these URLs. But in the scenario we discovered the custom handler wasn't called – but .Net's Razor handler was instead.</p>
					<p>In our particular situation, if the odd file "NOT_A_VALID_FILESYSTEM_PATH" existed in the website root, and the
						<a href="https://msdn.microsoft.com/en-us/library/system.web.configuration.httpruntimesection.relaxedurltofilesystemmapping(v=vs.110).aspx" target="_blank" rel="noopener noreferrer">config setting for "relaxedUrlToFileSystemMapping"</a>
						is set to
						<code>True</code>, then the
						<code>IsSuspiciousPhysicalPath()</code>
						method can mess things up when the path being processed is a certain length.</p>
					<p>Support's example was:</p>
					<blockquote>
						<ul>
							<li>
								<p>The next URL is requested:
									<code>http://a-test-server.local/~/media/Client-Name/print-resource-images/thumbnails/elected-representatives/Campaign-factsheet-Thumbnail-Nov-16-v3.ashx</code>
								</p>
							</li>
							<li>
								<p>CustomHandlers processor modifies the URL. Its current value is
									<code>http://a-test-server.local/~/media/Client-Name/print-resource-images/thumbnails/elected-representatives/sitecore_media.ashx/~/media/Client-Name/print-resource-images/thumbnails/elected-representatives/Campaign-factsheet-Thumbnail-Nov-16-v3.ashx</code>
								</p>
							</li>
							<li>
								<p>
									<code>IsSuspiciousPhysicalPath()</code>
									method is triggered. Physical path is
									<code>C:\Inetpub\wwwroot\a-test-server\Website\~\media\Client-Name\print-resource-images\thumbnails\elected-representatives\sitecore_media.ashx\~\media\Client-Name\print-resource-images\thumbnails\elected-representatives\Campaign-factsheet-Thumbnail-Nov-16-v3.ashx</code>
									Please note that
									<code>/en</code>s are not included in physicalPath even if they are included in your request URL.</p>
							</li>
							<li>
								<p>physicalPath.Length is 258. The value of
									<code>FileExists</code>
									is "false".</p>
							</li>
							<li>
								<p>
									<code>GetRouteLevelMatch(...)</code>
									modifies the URL. Its current value is
									<code>http://a-test-server.local/~/media/Client-Name/print-resource-images/thumbnails/elected-representatives/sitecore_media.ashx/~/media/Client-Name/print-resource-images/thumbnails/elected-representatives/Campaign-factsheet-Thumbnail-Nov-16-v3.ashx.cshtml</code>
								</p>
							</li>
							<li>
								<p>
									<code>IsSuspiciousPhysicalPath()</code>
									method is triggered. Physical path is
									<code>C:\Inetpub\wwwroot\a-test-server\Website\~\media\Client-Name\print-resource-images\thumbnails\elected-representatives\sitecore_media.ashx\~\media\Client-Name\print-resource-images\thumbnails\elected-representatives\Campaign-factsheet-Thumbnail-Nov-16-v3.ashx.cshtml</code>
								</p>
							</li>
							<li>
								<p>physicalPath.Length is 265. The value of
									<code>FileExists</code>
									is "true". The path has a file extension, so the media item (<code>NOT_A_VALID_FILESYSTEM_PATH</code>
									file to be precise) is rendered as a razor view.</p>
							</li>
						</ul>
						<p>If the initial length of "physicalPath" string was 245,
							<code>/default.cshtml</code>
							would be added.</p>
					</blockquote>
					<p>This is a bit complicated, but working through it with the public source for the relevant bits of .Net does seem to explain the odd behaviour we saw. Including the bit where changing the length of the URL could fix the problem, but certain invalid URLs would not return the expected 404.</p>
					<h2>Getting it fixed for the future...</h2>
					<p>Support have
						<a href="https://connect.microsoft.com/VisualStudio/feedback/details/3135079" target="_blank" rel="noopener noreferrer">raised an issue with Microsoft to get the underlying bug investigated</a>
						and resolved – so hopefully that will get sorted in a future update to the .Net runtime. They've also marked this as an issue in Sitecore using the bug number 95341 – so if you hit a similar issue that's the number to report to Support.</p>
					<p>And in the meantime, keep an eye out for
						<code>NOT_A_VALID_FILESYSTEM_PATH</code>
						getting accidentally created if
						<code>Server.MapPath()</code>
						<a href="https://stackoverflow.com/questions/26789048/asp-net-server-mappath-returns-the-string-not-a-valid-filesystem-path" target="_blank" rel="noopener noreferrer">processes URLs with invalid characters in it</a>...</p>
				</div>
				<div class="sidebar lg:flex-none lg:w-64 m-0 mt-1 lg:mt-0 lg:p-1 lg:bg-gray-100">
					<section class="mvp">
						<h3 class="bg-gray-300 p-2">Sitecore MVP 2015-2023</h3>
						<div class="bg-white mb-2 p-2">
							<a href="/mvp">
								<img class="lg:mx-auto" src="/img/mvp/2023.png" width="219" height="219" alt="2023 MVP Badge">
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Top Tags</h3>
						<div class="bg-white p-2 flex flex-wrap">
							<a href="/tags/sitecore/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Sitecore (216)</a>
							<a href="/tags/c/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								C# (53)</a>
							<a href="/tags/powershell/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								PowerShell (31)</a>
							<a href="/tags/installation/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Installation (23)</a>
							<a href="/tags/solr/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Solr (19)</a>
							<a href="/tags/general/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								General (16)</a>
							<a href="/tags/docker/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Docker (16)</a>
							<a href="/tags/ui/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								UI (15)</a>
							<a href="/tags/containers/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Containers (13)</a>
							<a href="/tags/bug/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Bug (12)</a>
						</div>
						<div class="bg-white mb-2 p-2">
							<a class="" href="/tags" role="button">All Tags
								<i class="fas fa-angle-double-right"></i>
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Recent Months</h3>
						<div class="bg-white p-2">
							<div>
								<a class="text-lg" href="/posts/2023-07">2023 - July</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2023-06">2023 - June</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2023-05">2023 - May</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2023-04">2023 - April</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2023-03">2023 - March</a>
							</div>
						</div>
						<div class="bg-white mb-2 p-2">
							<a class="" href="/posts" role="button">All Posts
								<i class="fas fa-angle-double-right"></i>
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Socials</h3>
						<div class="bg-white mb-2 p-2">
							<div>
								<a rel="me" target="_blank" href="https://mastodon.social/@jermdavis">Mastodon</a>
							</div>
							<div>
								<a rel="me" target="_blank" href="https://www.linkedin.com/in/djdavis/">LinkedIn</a>
							</div>
							<div>
								<a rel="me" target="_blank" href="https://twitter.com/jermdavis">Twitter</a>
							</div>
						</div>
					</section>
				</div>
			</div>
		</div>
		<footer class="lg:flex order-1 bg-gray-100 px-4 lg:px-6 py-4">
			<div class="flex-1 lg:flex-1 text-center lg:text-left">
				<div>©
					<a target="_blank" class="font-medium" rel="noopener" href="https://jermdavis.dev/">Jeremy Davis</a>
					2014-2023</div>
			</div>
			<div class="lg:flex-1 lg:order-3 text-center lg:text-right">
				<a class="font-medium" href="/tools">Published using Statiq</a>
				<br>
			</div>
			<ul class="list-none lg:flex-1 lg:order-2 p-0 text-center lg:align-middle" style="margin:0px !important">
				<li class="inline-block">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
					</svg>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium" target="_blank" href="/feed.rss">RSS</a>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium" target="_blank" href="/feed.atom">Atom</a>
				</li>
			</ul>
		</footer>
		<div class="min-h-screen bg-gray-300 py-6 flex flex-col justify-center sm:py-12" x-data="{ hide_banner: true }" x-init="hide_banner = docCookies.hasItem('hide_banner');" x-bind:class="{ 'hidden': hide_banner, 'fixed': !hide_banner }">
			<div class="border-2 border-gray-600 bg-gray-100 max-w-screen-lg mx-auto fixed bg-white inset-x-5 p-5 bottom-10 rounded-lg drop-shadow-2xl flex gap-4 flex-wrap md:flex-nowrap text-center md:text-left items-center justify-center md:justify-between">
				<div class="w-full text-lg">
					<a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cookie-usage" rel="noreferrer" target="_blank">This website uses Google Analytics, and its cookies.</a>
				</div>
				<button type="button" @click="hide_banner = true; docCookies.setItem('hide_banner', true, 'Fri, 31 Dec 9999 23:59:59 GMT', null, null, null, 'strict');" class="bg-gray-400 px-5 py-2 text-white rounded-md hover:bg-gray-600 focus:outline-none" aria-label="Dismiss">Understood</button>
			</div>
		</div>
		<script src="/vendor/Alpine/alpine.3.7.1.min.js" async=""></script>
		<script src="/vendor/Enlighter/enlighterjs.min.js" async=""></script>
		<script type="text/javascript">
            EnlighterJS.init('pre.code', 'code', {
            theme: 'droide',
            indent : 4,
            linehover : false,
            textOverflow: 'scroll',
            toolbarTop: '',
            toolbarBottom: ''
        });
        
		</script>
		<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JQ44ZR47YX"></script>
		<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-JQ44ZR47YX');
    
		</script>
	</body>
</html>