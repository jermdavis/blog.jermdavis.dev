<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' unpkg.com www.googletagmanager.com *.google-analytics.com; img-src 'self' data: *;style-src 'self' 'unsafe-inline'">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="canonical" href="https://blog.jermdavis.dev/posts/2018/a-fast-query-edge-case-that-might-bite-you">
		<meta name="description" content="There's been a bit of discussion (I might even go as far as to say ranting 😉 ) on the subject of <a href=&quot;https://intothecloud.blog/2018/10/21/It-s-time-to-put-fast-query-to-rest/&quot; rel=&quot;noopener&quot; target=&quot;_blank&quot;>not using &quot;fast query&quot; in your website code</a> recently. I'm a supporter of this idea – but I came across an issue recently that points out why it's not always easy to be confident that you're not making use of it indirectly...
So, for the benefit of Google: ">
		<meta property="og:description" content="There's been a bit of discussion (I might even go as far as to say ranting 😉 ) on the subject of <a href=&quot;https://intothecloud.blog/2018/10/21/It-s-time-to-put-fast-query-to-rest/&quot; rel=&quot;noopener&quot; target=&quot;_blank&quot;>not using &quot;fast query&quot; in your website code</a> recently. I'm a supporter of this idea – but I came across an issue recently that points out why it's not always easy to be confident that you're not making use of it indirectly...
So, for the benefit of Google: ">
		<meta name="keywords" content="Bug, Commerce Connect, Fast Query, Sitecore">
		<meta name="author" content="Jeremy Davis">
		<meta name="copyright" content="Jeremy Davis">
		<title>Jeremy Davis - A fast query edge case that might bite&nbsp;you</title>
		<meta name="robots" content="index, follow">
		<link type="application/rss+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.rss">
		<link type="application/atom+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.atom">
		<meta name="application-name" content="Jeremy Davis">
		<meta name="msapplication-tooltip" content="Jeremy Davis">
		<meta name="msapplication-starturl" content="/">
		<link rel="manifest" href="/manifest.webmanifest">
		<meta property="og:title" content="Jeremy Davis - A fast query edge case that might bite&amp;#xA0;you">
		<meta property="og:publish_date" content="2018-11-12T00:00:00+00:00">
		<meta property="og:type" content="article">
		<meta property="og:image" content="https://blog.jermdavis.dev/img/featured/a-fast-query-edge-case-that-might-bite-you-social.jpg">
		<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "article",
        "headline": "A fast query edge case that might bite&#xA0;you",
        "url": "https://blog.jermdavis.dev/posts/2018/a-fast-query-edge-case-that-might-bite-you",
        "image": [
            "https://blog.jermdavis.dev/img/featured/a-fast-query-edge-case-that-might-bite-you-social.jpg"
        ],
        "datePublished": "2018-11-12T00:00:00+00:00",
        "author": [{
            "@type": "Person",
            "name": "Jeremy Davis",
            "url": "https://jermdavis.dev/"
        }]
    }
    
		</script>
		<meta property="og:url" content="https://blog.jermdavis.dev/posts/2018/a-fast-query-edge-case-that-might-bite-you">
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">
		<link href="/scss/tailwind.css" rel="stylesheet">
		<link href="/vendor/Enlighter/enlighterjs.min.css" rel="stylesheet">
		<link href="/scss/site-theme.css" rel="stylesheet">
		<script src="/vendor/Cookies/cookies.min.js" defer=""></script>
	</head>
	<body class="max-w-7xl mx-auto text-black" id="top">
		<div class="relative bg-white" x-data="{ open: false }">
			
			<!-- desktop -->
			<div class="px-4 lg:px-6 bg-gray-100">
				<div class="bannerContainer flex justify-between items-center border-b-2 border-gray-100 py-6 lg:justify-start lg:space-x-10">
					<div class="flex justify-start lg:w-0 flex-1">
						<a href="/">
							<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
						</a>
						<div class="mx-2">
							<div class="text-3xl">Jeremy Davis</div>
							<div class="text-lg">Sitecore, C# and web development</div>
						</div>
					</div>
					<div class="nav -mr-2 -my-2 lg:hidden">
						<button @click="open = true" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-expanded="false">
							<span class="sr-only">Open menu</span>
							
							<!-- Heroicon name: outline/menu -->
							<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
							</svg>
						</button>
					</div>
					<nav class="nav hidden lg:flex space-x-10">
						<a class="text-base font-medium" href="/posts">Posts</a>
						<a class="text-base font-medium" href="/tags">Tags</a>
						<a class="text-base font-medium" href="/about">About</a>
						<a class="text-base font-medium" href="/links">Useful Links</a>
						<a class="text-base font-medium" href="/mvp">MVP</a>
					</nav>
				</div>
			</div>
			
			<!--Mobile menu, show/hide based on mobile menu state.-->
			<div class="absolute top-0 inset-x-0 p-2 transition transform origin-top-right lg:hidden z-50">
				<div class="rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 bg-white divide-y-2 divide-gray-50" x-show="open" x-transition="">
					<div class="pt-5 pb-6 px-5">
						<div class="flex items-center justify-between">
							<div class="flex">
								<a href="/">
									<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
								</a>
								<div class="mx-2">
									<div class="text-2xl">Jeremy Davis</div>
									<div class="text-base">Sitecore, C# and web development</div>
								</div>
							</div>
							<div class="nav -mr-2">
								<button @click="open = false" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
									<span class="sr-only">Close menu</span>
									
									<!-- Heroicon name: outline/x -->
									<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
									</svg>
								</button>
							</div>
						</div>
					</div>
					<div class="nav py-6 px-5 pt-0">
						<nav class=" gap-x-8">
							<a class="block mt-5 text-base font-medium" href="/posts">Posts</a>
							<a class="block mt-5 text-base font-medium" href="/tags">Tags</a>
							<a class="block mt-5 text-base font-medium" href="/about">About</a>
							<a class="block mt-5 text-base font-medium" href="/links">Useful Links</a>
							<a class="block mt-5 text-base font-medium" href="/mvp">MVP</a>
						</nav>
					</div>
				</div>
			</div>
		</div>
		<header class="bg-gray-300 px-4 py-1 lg:px-6 text-center" style="">
			<div class="post-heading">
				<div class="url p-1 bg-gray-100 rounded-md">Article printed from:
					<tt>https://blog.jermdavis.dev/posts/2018/a-fast-query-edge-case-that-might-bite-you</tt>
				</div>
				<h1 class="text-5xl mb-4 pb-1">
					A fast query edge case that might bite&nbsp;you
				</h1>
				<div class="meta">Published 12 November 2018</div>
				<div class="flex py-1">
					<a href="/tags/bug/" class="p-1 mr-1 bg-gray-100 rounded-md">
						Bug</a>
					<a href="/tags/commerce-connect/" class="p-1 mr-1 bg-gray-100 rounded-md">
						Commerce Connect</a>
					<a href="/tags/fast-query/" class="p-1 mr-1 bg-gray-100 rounded-md">
						Fast Query</a>
					<a href="/tags/sitecore/" class="p-1 mr-1 bg-gray-100 rounded-md">
						Sitecore</a>
				</div>
			</div>
		</header>
		<div class="py-2 lg:pl-3">
			<div class="lg:flex">
				<div class="lg:flex-auto mx-3 lg:min-w-0 content">
					<p>There's been a bit of discussion (I might even go as far as to say ranting 😉 ) on the subject of
						<a href="https://intothecloud.blog/2018/10/21/It-s-time-to-put-fast-query-to-rest/" rel="noopener" target="_blank">not using "fast query" in your website code</a>
						recently. I'm a supporter of this idea – but I came across an issue recently that points out why it's not always easy to be confident that you're not making use of it indirectly...</p>
					<p>So, for the benefit of Google: 
						<!--more-->
					</p>
					<h2>The problem:</h2>
					<p>I'm doing some work with a client who's production site makes use of a combination of Sitecore v8.2,
						<a href="https://dev.sitecore.net/Downloads/Sitecore_Publishing_Service.aspx" rel="noopener" target="_blank">Publishing Service</a>
						and
						<a href="https://doc.sitecore.net/sitecore_commerce/commerce_connect_components/commerce_connect_framework_components" rel="noopener" target="_blank">Commerce Connect</a>. They have a very large content tree, and they'd been discussing some publishing performance challenges with Sitecore Support recently. The outcome of that discussion was that Support pointed out they had "<a href="https://kb.sitecore.net/articles/740847" rel="noopener" target="_blank">update the descendants table</a>" enabled in their publishing config. That operation (the rebuild of the descendants table after each publish) was taking five minutes or so even if you published a single page – and was responsible for most of the delay they were seeing.</p>
					<p>After finding this issue in the site's logs, support suggested disabling this operation. Support asked whether the client had any code that made use of fast query, since the descendants table is used by fast queries to find content. But my client was happy that their code didn't include any queries like that.</p>
					<p>The change helped with the performance issue, and everything was fine for a while. However a while later the client published a new "store" to their public site, and immediately noticed that it crashed as soon as you tried to add a product to your shopping basket.</p>
					<p>After some digging they noticed that Commerce Connect's
						<code>EaPlanProvider</code>
						class was the source of their problem. On their newly published site, it was failing to resolve the correct engagement plan for basket operations. After some disassembly and digging through the code behind this, we could see that there were two operations in this code that would fail:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">EngagementPlanItem engagementPlanItem = Tracker.DefinitionDatabase.Automation().EngagementPlans[engagementPlanName];

					</pre>
					<p>where it tries to find the definition item for the engagement plan, and</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">EngagementPlanStateItem engagementPlanStateItem = engagementPlanItem.States[stateName];

					</pre>
					<p>where it tries to find the right state item in that plan.</p>
					<p>Under the surface, both of these lines of code call the
						<code>Sitecore.Analytics.Data.Items.ItemRecords&lt;TItemType&gt;</code>
						object's
						<code>GetName()</code>
						method. And when you look at the innards of that:</p>
					<pre class="code" data-enlighter-highlight="7" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">private TItemType FindByName(string name)
{
    Assert.ArgumentNotNull(name, "name");
    ItemUtil.AssertItemName(name);
    if (root != null)
    {
        string format = deep ? "fast://*[@@id = {0}]//*[@@name = {1}]" : "fast://*[@@id = {0}]/*[@@name = {1}]";
        string query = string.Format(format, EscapeQueryParameter(root.ID.Guid.ToString()), EscapeQueryParameter(name));
        Item[] array = root.Database.SelectItems(query);
        if (array != null &amp;&amp; array.Length &gt; 0)
        {
            Item[] array2 = array;
            foreach (Item item in array2)
            {
                if (templateFilter(item))
                {
                    return Wrap(item);
                }
            }
        }
    }
    return default(TItemType);
}

					</pre>
					<p>It makes a fast query!</p>
					<p>So the client's problem was that publishing a brand new store also published brand new Engagement Plan items to go with the store. And since Publishing Service is now configured not to update the descendants table, this fast query is never going to return the correct items, and you get a null reference exception...</p>
					<h2>The consequences...</h2>
					<p>Since Publishing Service ships with the descendants table update disabled by default, this seems like an issue that could affect other Commerce Connect users too.</p>
					<p>So if you're seeing similar issues when making use of Commerce Connect with publishing service, you'll need to consider one of two work-arounds:</p>
					<ul>
						<li>You may need to change the "don't update descendants" setting so that this table is updated at publish time.</li>
						<li>Or alternatively you may need to remember to manually update the descendants table (via the "cleanup database" operation available via API calls or the Control Panel UI) each time you add new engagement plans.</li>
					</ul>
					<p>I've raise a query with Support about this issue, and they've accepted that it is a bug in the product. Hopefully we'll see a fix for this in the not too distant future. But in the meantime, if you have the same problem and want to hurry the fix along, the bug ticket numbers are 291129 and 291130.</p>
					<a class="gotop" href="#top">↑ Back to top</a>
				</div>
				<div class="sidebar lg:flex-none lg:w-64 m-0 mt-1 lg:mt-0 lg:p-1 lg:bg-gray-100">
					<div class="md:flex-row md:flex lg:flex-col">
						<section class="md:flex-2 md:flex-grow md:flex-shrink">
							<h3 class="bg-gray-300 p-2">Top Tags</h3>
							<div class="bg-white p-2 flex flex-wrap">
								<a href="/tags/sitecore/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Sitecore (218)</a>
								<a href="/tags/c/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									C# (54)</a>
								<a href="/tags/powershell/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									PowerShell (31)</a>
								<a href="/tags/installation/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Installation (23)</a>
								<a href="/tags/solr/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Solr (19)</a>
								<a href="/tags/general/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									General (16)</a>
								<a href="/tags/docker/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Docker (16)</a>
								<a href="/tags/ui/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									UI (15)</a>
								<a href="/tags/containers/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Containers (13)</a>
								<a href="/tags/bug/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Bug (12)</a>
							</div>
							<div class="bg-white mb-2 p-2">
								<a class="text-lg" href="/tags" role="button">All Tags
									<i class="fas fa-angle-double-right"></i>
								</a>
							</div>
						</section>
						<section class="md:flex-2 md:border-l-2 md:border-white lg:border-l-0 md:flex-shrink-0">
							<h3 class="bg-gray-300 p-2">Recent Months</h3>
							<div class="bg-white p-2">
								<div>
									<a class="text-lg" href="/posts/2023-08">2023 - August</a>
								</div>
								<div>
									<a class="text-lg" href="/posts/2023-07">2023 - July</a>
								</div>
								<div>
									<a class="text-lg" href="/posts/2023-06">2023 - June</a>
								</div>
								<div>
									<a class="text-lg" href="/posts/2023-05">2023 - May</a>
								</div>
								<div>
									<a class="text-lg" href="/posts/2023-04">2023 - April</a>
								</div>
							</div>
							<div class="bg-white mb-2 p-2">
								<a class="text-lg" href="/posts" role="button">All Posts
									<i class="fas fa-angle-double-right"></i>
								</a>
							</div>
						</section>
						<section class="md:flex-1 md:border-l-2 md:border-white lg:border-l-0 md:flex-shrink">
							<h3 class="bg-gray-300 p-2">Socials</h3>
							<div class="bg-white mb-2 p-2">
								<div>
									<a class="text-lg" rel="me" target="_blank" href="https://mastodon.social/@jermdavis">Mastodon</a>
								</div>
								<div>
									<a class="text-lg" rel="me" target="_blank" href="https://www.linkedin.com/in/djdavis/">LinkedIn</a>
								</div>
								<div>
									<a class="text-lg" rel="me" target="_blank" href="https://twitter.com/jermdavis">Twitter</a>
								</div>
							</div>
						</section>
						<section class="mvp md:flex-2 md:border-l-2 md:border-white lg:border-l-0 md:flex-shrink-0 lg:order-first">
							<h3 class="bg-gray-300 p-2">Sitecore MVP 2015-2023</h3>
							<div class="bg-white mb-2 p-2">
								<a href="/mvp">
									<img class="lg:mx-auto" src="/img/mvp/2023.png" width="219" height="219" alt="2023 MVP Badge">
								</a>
							</div>
						</section>
					</div>
				</div>
			</div>
		</div>
		<footer class="lg:flex order-1 bg-gray-100 px-4 lg:px-6 py-4">
			<div class="flex-1 lg:flex-1 text-center lg:text-left">
				<div>©
					<a target="_blank" class="font-medium" rel="noopener" href="https://jermdavis.dev/">Jeremy Davis</a>
					2014-2023</div>
			</div>
			<div class="lg:flex-1 lg:order-3 text-center lg:text-right">
				<a class="font-medium" href="/tools">Published using Statiq</a>
				<br>
			</div>
			<ul class="list-none lg:flex-1 lg:order-2 p-0 text-center lg:align-middle" style="margin:0px !important">
				<li class="inline-block">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
					</svg>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium" target="_blank" href="/feed.rss">RSS</a>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium" target="_blank" href="/feed.atom">Atom</a>
				</li>
			</ul>
		</footer>
		<div class="min-h-screen bg-gray-300 py-6 flex flex-col justify-center sm:py-12" x-data="{ hide_banner: true }" x-init="hide_banner = docCookies.hasItem('hide_banner');" x-bind:class="{ 'hidden': hide_banner, 'fixed': !hide_banner }">
			<div class="border-2 border-gray-600 bg-gray-100 max-w-screen-lg mx-auto fixed bg-white inset-x-5 p-5 bottom-10 rounded-lg drop-shadow-2xl flex gap-4 flex-wrap md:flex-nowrap text-center md:text-left items-center justify-center md:justify-between">
				<div class="w-full text-lg">
					<a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cookie-usage" rel="noreferrer" target="_blank">This website uses Google Analytics, and its cookies.</a>
				</div>
				<button type="button" @click="hide_banner = true; docCookies.setItem('hide_banner', true, 'Fri, 31 Dec 9999 23:59:59 GMT', null, null, null, 'strict');" class="bg-gray-400 px-5 py-2 text-white rounded-md hover:bg-gray-600 focus:outline-none" aria-label="Dismiss">Understood</button>
			</div>
		</div>
		<script src="/vendor/Alpine/alpine.3.7.1.min.js" defer=""></script>
		<script src="/vendor/Enlighter/enlighterjs.min.js"></script>
		<script type="text/javascript">
            EnlighterJS.init('pre.code', 'code', {
            theme: 'droide',
            indent : 4,
            linehover : false,
            textOverflow: 'scroll',
            toolbarTop: '',
            toolbarBottom: ''
        });
        
		</script>
		<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JQ44ZR47YX"></script>
		<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-JQ44ZR47YX');
    
		</script>
	</body>
</html>