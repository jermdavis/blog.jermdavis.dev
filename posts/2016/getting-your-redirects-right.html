<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="Sitecore, C# and web development">
        <meta name="author" content="Jeremy Davis">

    <title>Jeremy Davis - Getting your redirects&nbsp;right</title>

    <link rel="canonical" href="https://blog.jermdavis.dev/posts/2016/getting-your-redirects-right">
    <meta name="robots" content="noindex, nofollow">

            <link type="application/rss+xml" rel="alternate" href="/feed.rss">
            <link type="application/atom+xml" rel="alternate" href="/feed.atom">

    <meta name="application-name" content="Jeremy Davis">
    <meta name="msapplication-tooltip" content="Jeremy Davis">
    <meta name="msapplication-starturl" content="/">

    
    <meta property="og:title" content="Jeremy Davis - Getting your redirects&nbsp;right">
        <meta property="og:image" content="/img/featured/getting-your-redirects-right-social.png">
    <meta property="og:description" content="">
<meta property="og:url" content="https://blog.jermdavis.dev/posts/2016/getting-your-redirects-right">
<meta property="og:type" content="website">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <link href="https://unpkg.com/tailwindcss@2.2.11/dist/tailwind.min.css" rel="stylesheet">

    <link href="/vendor/Enlighter/enlighterjs.min.css" rel="stylesheet">
    <link href="/scss/site-theme.css" rel="stylesheet">


    <script src="/vendor/Cookies/cookies.min.js" defers=""></script>

    

    
</head>

<body class="max-w-7xl mx-auto">
    <div class="relative bg-white" x-data="{ open: false }">

    <!-- desktop -->
    <div class="px-4 lg:px-6 bg-gray-100">
        <div class="flex justify-between items-center border-b-2 border-gray-100 py-6 lg:justify-start lg:space-x-10">

            <div class="flex justify-start lg:w-0 flex-1">
                <a href="/">
                    <img class="h-12 mt-2 w-auto lg:h-14" src="/img/Profile.jpg" alt="Jeremy Davis">
                </a>
                <div class="mx-2">
                    <div class="text-3xl">Jeremy Davis</div>
                    <div class="text-lg">Sitecore, C# and web development</div>
                </div>
            </div>

            <div class="-mr-2 -my-2 lg:hidden">
                <button @click="open = true" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-expanded="false">
                    <span class="sr-only">Open menu</span>
                    <!-- Heroicon name: outline/menu -->
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>

            <nav class="hidden lg:flex space-x-10">
<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/posts">Posts</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/tags">Tags</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/about">About</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/links">Useful Links</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/mvp">MVP</a>            </nav>

        </div>
    </div>

    <!--Mobile menu, show/hide based on mobile menu state.-->
    <div class="absolute top-0 inset-x-0 p-2 transition transform origin-top-right lg:hidden z-50">

        <div class="rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 bg-white divide-y-2 divide-gray-50" x-show="open" x-transition="">
            <div class="pt-5 pb-6 px-5">
                <div class="flex items-center justify-between">
                    <div class="flex">
                        <a href="/">
                            <img class="h-12 mt-2 w-auto" src="/img/Profile.jpg" alt="Jeremy Davis">
                        </a>
                        <div class="mx-2">
                            <div class="text-2xl">Jeremy Davis</div>
                            <div class="text-base">Sitecore, C# and web development</div>
                        </div>
                    </div>

                    <div class="-mr-2">
                        <button @click="open = false" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
                            <span class="sr-only">Close menu</span>
                            <!-- Heroicon name: outline/x -->
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="py-6 px-5 pt-0">
                <nav class=" gap-x-8">
<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/posts">Posts</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/tags">Tags</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/about">About</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/links">Useful Links</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/mvp">MVP</a>                </nav>
            </div>

        </div>
    </div>
</div>

    <header class="bg-gray-300 px-4 py-1 lg:px-6 text-center" style="background-image: url(&quot;/&quot;);">
    <div class="post-heading">
        <h1 class="text-5xl mb-1 pb-1">
        Getting your redirects&nbsp;right
        </h1>
            <div class="meta">Published 08 February 2016</div>
                <div class="meta">Updated 25 August 2016</div>
            <div class="flex py-1">
                    <a href="/tags/sitecore" class="p-1 mr-1 bg-gray-100 rounded-md"> Sitecore</a>
            </div>
    </div>
</header>

    <div class="py-2 lg:pl-3">
        <div class="lg:flex">
            <div class="lg:flex-auto mx-3 lg:min-w-0 content">
                <p>I suspect a fairly common scenario for Sitecore developers is launching a new site which replaces an existing one with a shiny new design and content structure. It's a fairly common requirement of these projects that whoever is in charge of SEO will want redirects in place from important old URLs on the site, to new ones. They ensure that users who have bookmarks to the old pages don't see 404s, and try to keep the search engine rankings which had been acquired by the old site.</p>
<p>Another common scenario these days is for new websites to serve all of their pages under HTTPS, rather than just the "sensitive" pages as we might have done in the past.</p>
<p>When you combine these two needs together, you can end up with more complicated redirection rules than you might have needed in the past. If you're planning to make use of the the <a href="https://marketplace.sitecore.net/Modules/Url_Rewrite.aspx" target="_blank" rel="noopener noreferrer">Url Redirect module</a> from the Sitecore Marketplace, my experiences doing this might be of help to you:<!--more--></p>
<h2>Generalising the rules you want</h2>
<p>In an ideal world, we want any redirection the site is going to perform to happen in a single operation. SEO people will tell you that having a chain of redirects is bad for your search rankings – you don't want your pages to look like spam to the search engines. So in this scenario we need to have two distinct groups of rules:</p>
<ul>
<li>Specific redirects: Rules to send HTTP(S) requests for old URLs to HTTPS requests for new URLs.</li>
<li>A Generic redirect: Rule to send any other HTTP request to HTTPS.</li>
</ul>
<p>We need zero or one of these rules to trigger for any request arriving at the server.</p>
<h2>The specific redirect rules</h2>
<p>The rules for matching old URLs need to deal with whatever file extensions are appropriate for the site being replaced. In the case I was working on, the URLs might or might not end with a trailing slash. While I'm keenly aware of the <a href="http://regex.info/blog/2006-09-15/247" target="_blank" rel="noopener noreferrer">usual jokes</a> about <a href="https://xkcd.com/208/" target="_blank" rel="noopener noreferrer">regular expressions</a>, using them in an "Inbound Rule" via the redirect module is the easiest way to get an accurate match here.</p>
<p>In my case, detecting a URL which requires a redirect needs an expression based on the pattern:</p>
<pre data-enlighter-theme="droide-text" data-enlighter-language="text" style="width:100%; overflow:scroll;">^the-url-to-redirect/?$
</pre>
<p>Which translates as:</p>
<ul>
<li>Match the start of the string: `^`</li>
<li>Match the URL required: `the-url-to-redirect`</li>
<li>Optionally match a trailing slash: `/?`</li>
<li>Match the end of the string: `$`</li>
</ul>
<p>When constructing these rules you need to remember that you don't see the protocol, host name or querystring at this point. If you're not confident with regular expressions, a testing tool such as the <a href="http://regexhero.net/tester/" target="_blank" rel="noopener noreferrer">.Net Regex Tester</a> can be very helpful to help you get the syntax right. This is generally easier than trying to debug the expressions by running redirect rules in Sitecore.</p>
<p>Your rule item probably ends up looking a bit like this: (Click to enlarge)</p>
<p><a href="/img/2016/2016-01-specificinboundrule.png" target="_blank"><img alt="Specific Inbound Rule" src="/img/2016/2016-01-specificinboundrule.png"></a></p>
<p>If this matches, you then need a <code>Redirect</code> item to describe what should happen.</p>
<p>Here, we need to specify a few things:</p>
<ul>
<li>The redirection needs to go to HTTPS no matter what the original protocol of the request was.</li>
<li>We need to maintain the same host name as the original request.</li>
<li>We probably want a Permanent (301) redirection.</li>
<li>If this rule is matched, we don't want any other rules to be evaluated.</li>
</ul>
<p>The first two are dealt with by the replacement expression that we define in the <code>Rewrite URL</code> field. This will look something like:</p>
<pre data-enlighter-theme="droide-text" data-enlighter-language="text" style="width:100%; overflow:scroll;">https://HTTP_HOST/my-new-site-url
</pre>
<p>The <code>{HTTP_HOST}</code> token will be replaced with whatever the host was in the original request. Using this approach rather than hard-coding the host allows the rules to be tested on non-production servers prior to deployment.</p>
<p>The third and fourth bullets are dealt with by the <code>Redirect Type</code> field and the <code>Stop processing of subsequent rules</code> checkbox.</p>
<p>So your redirect item will look something like:</p>
<p><a href="/img/2016/2016-01-specificredirect.png" target="_blank"><img alt="Specific Redirect" src="/img/2016/2016-01-specificredirect.png"></a></p>
<p>You'll need to follow that pattern to create a set of rules for redirecting the old URLs that your SEO people require. You may find that using folders to organise the rules for sub-levels of the old site will help keep things neater. Folders are ignored by the logic which processes the rules, so they just help you organise rules.</p>
<h2>The generic redirect rule</h2>
<p>There's only one rule needed here. It's a little more complex to construct, however.</p>
<p>First of all, the <code>Inbound Rule</code> here needs to match everything, as we only get here if no other rule has matched. The example rules that ship with the module use <code>(.*)</code> for this purpose. The brackets here are required to make a "group" in Regular Expression terms – basically some characters we're going to want to be able to fetch later.</p>
<p>Secondly, you need to add a <code>Condition</code> to qualify the <code>Inbound Rule</code>. We've already told it to "match any path" but we only want this rule to trigger if the request is made under HTTP. The data needed for that is as follows:</p>
<p><a href="/img/2016/2016-01-httpscondition.png" target="_blank"><img alt="HTTPS Condition" src="/img/2016/2016-01-httpscondition.png"></a></p>
<p>That means the rule only triggers when the flag saying "is the request under HTTPS" is false.</p>
<p>And finally, we need the redirect:</p>
<p><a href="/img/2016/2016-01-httpsredirect.png" target="_blank"><img alt="HTTPS Redirect" src="/img/2016/2016-01-httpsredirect.png"></a></p>
<p>The only difference here is the use of the <code>{R:1}</code> token in the target URL. This fetches back the group we matched above, so we can paste the original requested URL into our re-written request.</p>
<h2>The ordering conundrum</h2>
<p>With the rules set up like that, you should find that whether you request an old URL or a new URL under HTTPS, you end up at the new URL under HTTPS in a single redirect.</p>
<p>But when I'd finished testing this and deployed it to my QA infrastructure, it stopped working as expected. Suddenly I was seeing the rules firing in such a way that two redirects were required. The generic HTTPS rule would trigger first for my test, followed by the specific rule.</p>
<p>Cue a few hours spent with the <a href="https://github.com/iamandycohen/UrlRewrite" target="_blank" rel="noopener noreferrer">source code from Github</a> and the trusty Visual Studio debugger...</p>
<p>The reason, it turns out is that the rules are fetched by a query when the module starts up, and it's based on the item template not content structure. The order items come back in isn't really defined here, but is most likely related to the order they exist in the underlying database. On my dev machine, I'd created them in the correct order so by luck they were working there, but copying them across to the QA site via a package hadn't maintained that ordering. Hence the list of rules in memory ended up in a different order to the rules in the content tree – because that's always sorted by the <code>__sortorder</code> field.</p>
<p>I ended up solving my problem by adding "sort by <code>__sortorder</code> into the redirect module code, so that each time a rule is updated the cached rule-set in memory is re-sorted. The <a href="https://github.com/jermdavis/UrlRewrite/commit/d48fe176c430054032964a529e8bc754c1dcfab7" target="_blank" rel="noopener noreferrer">change set is available via github</a> if you find yourself in a similar situation, and I've submitted a Pull Request for this and some other minor changes. So hopefully that behaviour (or an improved version of it) can end up in the Marketplace module in the future...</p>
<p>One point worth noting is that because of the way that Sitecore manages the values in the <code>__sortorder</code> field, if you put rules into folders, more than one rule can end up with the same sort order value. Sitecore restarts its numbering from scratch for each folder, so if the rules are fetched from more than one folder you can see duplication. And unsurprisingly, the outcome of the sort operation is undefined for these duplicates. If this is going to be an issue to you, you probably need to manually adjust the values in the sort order field, to make sure their values sort correctly. This field lives in the "Standard Fields" for Sitecore Items, so you'll need to make sure those are visible in Content Editor in order to modify it. Or alternatively you might consider modifying the code to sort by a custom "rule priority" field that you create yourself.</p>


            </div>
            <div class="lg:flex-none lg:w-72 m-0 mt-1 lg:mt-0 lg:p-1 lg:bg-gray-100">
                <section>
    <h3 class="bg-gray-300 p-2">Sitecore MVP 2015-2021</h3>
    <div class="bg-white mb-2 p-2"><img src="/img/mvp/2021.jpg" alt="2021 MVP Badge"></div>
</section>

<section>
    <h3 class="bg-gray-300 p-2">Top Tags</h3>
    <div class="bg-white p-2 flex flex-wrap">
                    <a href="/tags/sitecore" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Sitecore (192)</a>
                    <a href="/tags/c" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> C# (45)</a>
                    <a href="/tags/powershell" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> PowerShell (31)</a>
                    <a href="/tags/installation" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Installation (23)</a>
                    <a href="/tags/solr" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Solr (15)</a>
                    <a href="/tags/ui" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> UI (14)</a>
                    <a href="/tags/general" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> General (12)</a>
                    <a href="/tags/coveo" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Coveo (12)</a>
                    <a href="/tags/visual-studio" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Visual Studio (11)</a>
                    <a href="/tags/docker" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Docker (10)</a>
    </div>
    <div class="bg-white mb-2 p-2">
        <a class="" href="/tags" role="button">All Tags <i class="fas fa-angle-double-right"></i></a>
    </div>
</section>

<section>
    <h3 class="bg-gray-300 p-2">Recent Months</h3>
    <div class="bg-white p-2">
                <div><a class="text-lg" href="/posts/2021-01">2021 - January</a></div>
                <div><a class="text-lg" href="/posts/2021-02">2021 - February</a></div>
                <div><a class="text-lg" href="/posts/2021-03">2021 - March</a></div>
                <div><a class="text-lg" href="/posts/2021-04">2021 - April</a></div>
                <div><a class="text-lg" href="/posts/2021-05">2021 - May</a></div>
    </div>
    <div class="bg-white mb-2 p-2">
        <a class="" href="/posts" role="button">All Posts <i class="fas fa-angle-double-right"></i></a>
    </div>
</section>

<section>
    <h3 class="bg-gray-300 p-2">Twitter</h3>
    <div class="bg-white mb-2 p-2">
        <a class="twitter-timeline" data-height="400" data-chrome="noheader nofooter noborders" href="https://twitter.com/jermdavis">Tweets by JermDavis</a>
        <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    </div>
</section>
            </div>
        </div>
    </div>

    <footer class="lg:flex order-1 bg-gray-100 px-4 lg:px-6 py-4">
    <div class="flex-1 lg:flex-1 text-center lg:text-left">© <a target="_blank" class="font-medium text-gray-500 hover:text-gray-900" href="https://jermdavis.dev/">Jeremy Davis</a> 2014-2021</div>

    <div class="lg:flex-1 lg:order-3 text-center lg:text-right"><a class="font-medium text-gray-500 hover:text-gray-900" href="/tools">Published using Statiq</a></div>

    <ul class="list-none lg:flex-1 lg:order-2 text-center align-middle">
        <li class="inline-block">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
            </svg>
        </li>
            <li class="inline-block ml-4">
                <a class="font-medium text-gray-500 hover:text-gray-900" target="_blank" href="/feed.rss">RSS</a>
            </li>
            <li class="inline-block ml-4">
                <a class="font-medium text-gray-500 hover:text-gray-900" target="_blank" href="/feed.atom">Atom</a>
            </li>
    </ul>
</footer>

    <div class="min-h-screen bg-gray-300 py-6 flex flex-col justify-center sm:py-12" x-data="{ hide_banner: true }" x-init="hide_banner = docCookies.hasItem('hide_banner') ? (docCookies.getItem('hide_banner') == 'true') : false;" x-bind:class="{ 'hidden': hide_banner, 'fixed': !hide_banner }">
        <div class="border-2 border-gray-600 bg-gray-100 max-w-screen-lg mx-auto fixed bg-white inset-x-5 p-5 bottom-10 rounded-lg drop-shadow-2xl flex gap-4 flex-wrap md:flex-nowrap text-center md:text-left items-center justify-center md:justify-between">
            <div class="w-full text-lg">This website uses Google Analytics, and its cookies.
              <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cookie-usage" rel="noreferrer" target="_blank" class="whitespace-nowrap">Learn more</a>
            </div>

            <button type="button" @click="hide_banner = true; docCookies.setItem('hide_banner', true, (7*24*60*60));" class="bg-gray-400 px-5 py-2 text-white rounded-md hover:bg-gray-600 focus:outline-none" aria-label="Dismiss">Understood</button>
        </div>
    </div>
    
    <script src="https://unpkg.com/alpinejs" defer=""></script>    
    <script src="/vendor/Enlighter/enlighterjs.min.js"></script>

    <script type="text/javascript">
        EnlighterJS.init('pre', 'code', {
            theme: 'droide',
            indent : 4,
            linehover : false,
            textOverflow: 'scroll',
            toolbarTop: '{BTN_RAW}{BTN_COPY}',
            toolbarBottom: ''
        });
    </script>

    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JQ44ZR47YX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-JQ44ZR47YX');
    </script>

    

    



</body></html>