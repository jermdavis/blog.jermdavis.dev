<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' *.twitter.com unpkg.com www.googletagmanager.com *.google-analytics.com *.twimg.com; img-src 'self' data: *;style-src 'self' 'unsafe-inline' *.twitter.com *.twimg.com">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="canonical" href="https://blog.jermdavis.dev/posts/2018/why-am-i-missing-my-geoip-data">
		<meta name="description" content="I spent some time this week looking at a client site whose analytics data was missing GeoIP information. Since they had a valid license for Sitecore's GeoIP lookup service, this was a bit confusing. So, continuing my battle to write up all the unexpected scenarios...">
		<meta property="og:description" content="I spent some time this week looking at a client site whose analytics data was missing GeoIP information. Since they had a valid license for Sitecore's GeoIP lookup service, this was a bit confusing. So, continuing my battle to write up all the unexpected scenarios...">
		<meta name="keywords" content="Analytics, Sitecore">
		<meta name="author" content="Jeremy Davis">
		<meta name="copyright" content="Jeremy Davis">
		<title>Jeremy Davis - Why am I missing my GeoIP&nbsp;data?</title>
		<meta name="robots" content="index, follow">
		<link type="application/rss+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.rss">
		<link type="application/atom+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.atom">
		<meta name="application-name" content="Jeremy Davis">
		<meta name="msapplication-tooltip" content="Jeremy Davis">
		<meta name="msapplication-starturl" content="/">
		<link rel="manifest" href="/manifest.webmanifest">
		<meta property="og:title" content="Jeremy Davis - Why am I missing my GeoIP&amp;#xA0;data?">
		<meta property="og:publish_date" content="2018-04-30T00:00:00+00:00">
		<meta property="og:modified_date" content="2018-06-11T00:00:00+00:00">
		<meta property="og:image" content="https://blog.jermdavis.dev/img/featured/why-am-i-missing-my-geoip-data-social.jpg?">
		<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": "Why am I missing my GeoIP&#xA0;data?",
        "image": [
            "https://blog.jermdavis.dev/img/featured/why-am-i-missing-my-geoip-data-social.jpg"
        ],
        "datePublished": "2018-04-30T00:00:00+00:00",
        "dateModified": "2018-06-11T00:00:00+00:00",
        "author": [{
            "@type": "Person",
            "name": "Jeremy Davis",
            "url": "https://jermdavis.dev/"
        }]
    }
    
		</script>
		<meta property="og:url" content="https://blog.jermdavis.dev/posts/2018/why-am-i-missing-my-geoip-data">
		<meta property="og:type" content="website">
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">
		<link href="/scss/tailwind.css" rel="stylesheet">
		<link href="/vendor/Enlighter/enlighterjs.min.css" rel="stylesheet">
		<link href="/scss/site-theme.css" rel="stylesheet">
		<script src="/vendor/Cookies/cookies.min.js" defer=""></script>
	</head>
	<body class="max-w-7xl mx-auto text-black">
		<div class="relative bg-white" x-data="{ open: false }">
			
			<!-- desktop -->
			<div class="px-4 lg:px-6 bg-gray-100">
				<div class="flex justify-between items-center border-b-2 border-gray-100 py-6 lg:justify-start lg:space-x-10">
					<div class="flex justify-start lg:w-0 flex-1">
						<a href="/">
							<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
						</a>
						<div class="mx-2">
							<div class="text-3xl">Jeremy Davis</div>
							<div class="text-lg">Sitecore, C# and web development</div>
						</div>
					</div>
					<div class="nav -mr-2 -my-2 lg:hidden">
						<button @click="open = true" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-expanded="false">
							<span class="sr-only">Open menu</span>
							
							<!-- Heroicon name: outline/menu -->
							<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
							</svg>
						</button>
					</div>
					<nav class="nav hidden lg:flex space-x-10">
						<a class="text-base font-medium" href="/posts">Posts</a>
						<a class="text-base font-medium" href="/tags">Tags</a>
						<a class="text-base font-medium" href="/about">About</a>
						<a class="text-base font-medium" href="/links">Useful Links</a>
						<a class="text-base font-medium" href="/mvp">MVP</a>
					</nav>
				</div>
			</div>
			
			<!--Mobile menu, show/hide based on mobile menu state.-->
			<div class="absolute top-0 inset-x-0 p-2 transition transform origin-top-right lg:hidden z-50">
				<div class="rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 bg-white divide-y-2 divide-gray-50" x-show="open" x-transition="">
					<div class="pt-5 pb-6 px-5">
						<div class="flex items-center justify-between">
							<div class="flex">
								<a href="/">
									<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
								</a>
								<div class="mx-2">
									<div class="text-2xl">Jeremy Davis</div>
									<div class="text-base">Sitecore, C# and web development</div>
								</div>
							</div>
							<div class="nav -mr-2">
								<button @click="open = false" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
									<span class="sr-only">Close menu</span>
									
									<!-- Heroicon name: outline/x -->
									<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
									</svg>
								</button>
							</div>
						</div>
					</div>
					<div class="nav py-6 px-5 pt-0">
						<nav class=" gap-x-8">
							<a class="block mt-5 text-base font-medium" href="/posts">Posts</a>
							<a class="block mt-5 text-base font-medium" href="/tags">Tags</a>
							<a class="block mt-5 text-base font-medium" href="/about">About</a>
							<a class="block mt-5 text-base font-medium" href="/links">Useful Links</a>
							<a class="block mt-5 text-base font-medium" href="/mvp">MVP</a>
						</nav>
					</div>
				</div>
			</div>
		</div>
		<header class="bg-gray-300 px-4 py-1 lg:px-6 text-center" style="">
			<div class="post-heading">
				<div class="url p-1 bg-gray-100 rounded-md">Article printed from:
					<tt>https://blog.jermdavis.dev/posts/2018/why-am-i-missing-my-geoip-data</tt>
				</div>
				<h1 class="text-5xl mb-4 pb-1">
					Why am I missing my GeoIP&nbsp;data?
				</h1>
				<div class="meta">Published 30 April 2018</div>
				<div class="meta">Updated 11 June 2018</div>
				<div class="flex py-1">
					<a href="/tags/analytics/" class="p-1 mr-1 bg-gray-100 rounded-md">
						Analytics</a>
					<a href="/tags/sitecore/" class="p-1 mr-1 bg-gray-100 rounded-md">
						Sitecore</a>
				</div>
			</div>
		</header>
		<div class="py-2 lg:pl-3">
			<div class="lg:flex">
				<div class="lg:flex-auto mx-3 lg:min-w-0 content">
					<p>I spent some time this week looking at a client site whose analytics data was missing GeoIP information. Since they had a valid license for Sitecore's GeoIP lookup service, this was a bit confusing. So, continuing my battle to write up all the unexpected scenarios...
						<!--more-->
					</p>
					<blockquote>
						<i>
							<b>Updated:</b>
							There is
							<a href="/posts/2018/why-am-i-still-missing-some-geoip-data" target="_blank">a follow-up to this post, which points out some extra issues with the way GeoIP configuration is currently documented for v8-era Sitecore setups that change the `Analytics.PerformLookup` setting below</a>. If this setting is of interested to you, please read that too!</i>
					</blockquote>
					<h2>The issue</h2>
					<p>The client site I was asked to look at was running Sitecore 8.2, and they had
						<a href="https://doc.sitecore.net/sitecore_experience_platform/82/setting_up_and_maintaining/ip_geolocation/setting_up_sitecore_ip_geolocation" rel="noopener" target="_blank">used the App Center to set themselves up with a license for GeoIP lookups</a>. Writing code that called the lookup manager directly seemed to be working – and returned valid data about the current user.</p>
					<p>But when you looked at the analytics data visible in the Sitecore UI, none of the users had any location data associated with them.</p>
					<p>
						<a href="/img/2018/2018-04-nolocations.png" target="_blank">
							<img alt="No Locations" src="/img/2018/2018-04-nolocations.png">
						</a>
					</p>
					<p>After seeing this issue, I had a dig around looking for any clues about what was going on. What I noticed was that the raw data in MongoDB was missing for anything relating to GeoIP. The "GeoIPs" collection wasn't present, and none of the records in the "Interactions" collection included the "GeoData" element.</p>
					<p>
						<a href="/img/2018/2018-04-nogeoip.png" target="_blank">
							<img alt="No GeoIP Data" src="/img/2018/2018-04-nogeoip.png">
						</a>
					</p>
					<h2>The fix</h2>
					<p>It took some head-scratching, googling and config file diffing, but eventually I worked out what was up.</p>
					<p>The client's site was running one CM server and two CD servers, which shared the same core config files. Those config files included a change which set the
						<code>Analytics.PerformLookup</code>
						setting to false.</p>
					<p>Documentation (Can't find it specifically for V8 – but
						<a href="https://sdn.sitecore.net/upload/sitecore6/61/analytics_configuration_reference_sc61_usletter.pdf" rel="noopener" target="_blank">it is covered for older versions</a>) says that this setting should be "true" for precisely one server in any deployment – in order to protect against deadlocks, and to avoid chewing up your lookup allocation excessively. (Note that
						<a href="https://doc.sitecore.net/developers/server-role-configuration-reference/core-roles/content-delivery.html" rel="noopener" target="_blank">V9's documentation says you can set it true on multiple servers</a>
						– so that code has clearly changed a bit in more recent releases) Since this site had it set false everywhere, it looked like none of the machines in the cluster were actually performing the asynchronous lookup of IPs that xDB was recording.</p>
					<p>I came across a blog post which
						<a href="https://horizontalintegration.blog/2016/08/28/sitecore-8-geo-ip-lookup-configuration-tips/" rel="noopener" target="_blank">suggested it should be your least loaded server that does these lookups</a>
						– which makes a lot of sense. So I deployed a simple patch to the CM server to make that setting true again:</p>
					<pre data-enlighter-language="xml" style="width:100%; overflow:scroll;">&lt;configuration xmlns:patch="http://www.sitecore.net/xmlconfig/" xmlns:set="http://www.sitecore.net/xmlconfig/set/"&gt;
  &lt;sitecore&gt;
    &lt;settings&gt;
      &lt;setting name="Analytics.PerformLookup" set:value="true"/&gt;
    &lt;/settings&gt;
  &lt;/sitecore&gt;
&lt;/configuration&gt;

					</pre>
					<p>Once that was deployed, the missing MongoDB collection data appeared:</p>
					<p>
						<a href="/img/2018/2018-04-validgeoipdata1.png" target="_blank">
							<img alt="Valid GeoIP Data" src="/img/2018/2018-04-validgeoipdata1.png">
						</a>
					</p>
					<p>And the experience explorer started to show locations for new visits:</p>
					<p>
						<a href="/img/2018/2018-04-visitlocation.png" target="_blank">
							<img alt="Visit Location" src="/img/2018/2018-04-visitlocation.png">
						</a>
					</p>
					<p>Success!</p>
				</div>
				<div class="sidebar lg:flex-none lg:w-72 m-0 mt-1 lg:mt-0 lg:p-1 lg:bg-gray-100">
					<section class="mvp">
						<h3 class="bg-gray-300 p-2">Sitecore MVP 2015-2022</h3>
						<div class="bg-white mb-2 p-2">
							<a href="/mvp">
								<img src="/img/mvp/2022.jpg" width="219" height="219" alt="2022 MVP Badge">
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Top Tags</h3>
						<div class="bg-white p-2 flex flex-wrap">
							<a href="/tags/sitecore/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Sitecore (211)</a>
							<a href="/tags/c/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								C# (48)</a>
							<a href="/tags/powershell/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								PowerShell (31)</a>
							<a href="/tags/installation/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Installation (23)</a>
							<a href="/tags/solr/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Solr (17)</a>
							<a href="/tags/docker/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Docker (15)</a>
							<a href="/tags/ui/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								UI (15)</a>
							<a href="/tags/general/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								General (14)</a>
							<a href="/tags/bug/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Bug (13)</a>
							<a href="/tags/coveo/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Coveo (12)</a>
						</div>
						<div class="bg-white mb-2 p-2">
							<a class="" href="/tags" role="button">All Tags
								<i class="fas fa-angle-double-right"></i>
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Recent Months</h3>
						<div class="bg-white p-2">
							<div>
								<a class="text-lg" href="/posts/2023-01">2023 - January</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2022-12">2022 - December</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2022-11">2022 - November</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2022-10">2022 - October</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2022-09">2022 - September</a>
							</div>
						</div>
						<div class="bg-white mb-2 p-2">
							<a class="" href="/posts" role="button">All Posts
								<i class="fas fa-angle-double-right"></i>
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Socials</h3>
						<div class="bg-white mb-2 p-2">
							<div>
								<a rel="me" target="_blank" href="https://mastodon.social/@jermdavis">Mastodon</a>
							</div>
							<div>
								<a rel="me" target="_blank" href="https://www.linkedin.com/in/djdavis/">LinkedIn</a>
							</div>
							<div>
								<a rel="me" target="_blank" href="https://twitter.com/jermdavis">Twitter</a>
							</div>
						</div>
					</section>
				</div>
			</div>
		</div>
		<footer class="lg:flex order-1 bg-gray-100 px-4 lg:px-6 py-4">
			<div class="flex-1 lg:flex-1 text-center lg:text-left">
				<div>©
					<a target="_blank" class="font-medium" rel="noopener" href="https://jermdavis.dev/">Jeremy Davis</a>
					2014-2023</div>
			</div>
			<div class="lg:flex-1 lg:order-3 text-center lg:text-right">
				<a class="font-medium" href="/tools">Published using Statiq</a>
				<br>
			</div>
			<ul class="list-none lg:flex-1 lg:order-2 p-0 text-center lg:align-middle" style="margin:0px !important">
				<li class="inline-block">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
					</svg>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium" target="_blank" href="/feed.rss">RSS</a>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium" target="_blank" href="/feed.atom">Atom</a>
				</li>
			</ul>
		</footer>
		<div class="min-h-screen bg-gray-300 py-6 flex flex-col justify-center sm:py-12" x-data="{ hide_banner: true }" x-init="hide_banner = docCookies.hasItem('hide_banner');" x-bind:class="{ 'hidden': hide_banner, 'fixed': !hide_banner }">
			<div class="border-2 border-gray-600 bg-gray-100 max-w-screen-lg mx-auto fixed bg-white inset-x-5 p-5 bottom-10 rounded-lg drop-shadow-2xl flex gap-4 flex-wrap md:flex-nowrap text-center md:text-left items-center justify-center md:justify-between">
				<div class="w-full text-lg">
					<a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cookie-usage" rel="noreferrer" target="_blank">This website uses Google Analytics, and its cookies.</a>
				</div>
				<button type="button" @click="hide_banner = true; docCookies.setItem('hide_banner', true, 'Fri, 31 Dec 9999 23:59:59 GMT', null, null, null, 'strict');" class="bg-gray-400 px-5 py-2 text-white rounded-md hover:bg-gray-600 focus:outline-none" aria-label="Dismiss">Understood</button>
			</div>
		</div>
		<script src="/vendor/Alpine/alpine.3.7.1.min.js" defer=""></script>
		<script src="/vendor/Enlighter/enlighterjs.min.js"></script>
		<script type="text/javascript">
        EnlighterJS.init('pre', 'code', {
            theme: 'droide',
            indent : 4,
            linehover : false,
            textOverflow: 'scroll',
            toolbarTop: '',
            toolbarBottom: ''
        });
    
		</script>
		<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JQ44ZR47YX"></script>
		<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-JQ44ZR47YX');
    
		</script>
	</body>
</html>