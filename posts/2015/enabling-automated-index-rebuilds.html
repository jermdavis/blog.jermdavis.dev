<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' www.youtube.com *.twitter.com unpkg.com www.googletagmanager.com *.google-analytics.com *.twimg.com; img-src 'self' data: *;style-src 'self' 'unsafe-inline' *.twitter.com *.twimg.com">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="canonical" href="https://blog.jermdavis.dev/posts/2015/enabling-automated-index-rebuilds">
		<meta name="description" content="Another helpful addition to the &quot;<a href=&quot;/posts/2015/automated-package-installs&quot; target=&quot;_blank&quot;>scripted installs</a>&quot; functions I've been looking at for the last few weeks is the ability to trigger a full rebuild of a search index. Last week we looked at <a href=&quot;/posts/2015/improving-the-automated-package-installs&quot; target=&quot;_blank&quot;>deferring the indexing of items installed by a package</a> to try and help speed up the scripted install of packages. So it makes sense to be able to trigger a build as well... ">
		<meta property="og:description" content="Another helpful addition to the &quot;<a href=&quot;/posts/2015/automated-package-installs&quot; target=&quot;_blank&quot;>scripted installs</a>&quot; functions I've been looking at for the last few weeks is the ability to trigger a full rebuild of a search index. Last week we looked at <a href=&quot;/posts/2015/improving-the-automated-package-installs&quot; target=&quot;_blank&quot;>deferring the indexing of items installed by a package</a> to try and help speed up the scripted install of packages. So it makes sense to be able to trigger a build as well... ">
		<meta name="keywords" content="Lucene, PowerShell, Sitecore">
		<meta name="author" content="Jeremy Davis">
		<meta name="copyright" content="Jeremy Davis">
		<title>Jeremy Davis - Enabling automated index&nbsp;rebuilds</title>
		<meta name="robots" content="index, follow">
		<link type="application/rss+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.rss">
		<link type="application/atom+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.atom">
		<meta name="application-name" content="Jeremy Davis">
		<meta name="msapplication-tooltip" content="Jeremy Davis">
		<meta name="msapplication-starturl" content="/">
		<link rel="manifest" href="/manifest.webmanifest">
		<meta property="og:title" content="Jeremy Davis - Enabling automated index&amp;#xA0;rebuilds">
		<meta property="og:publish_date" content="2015-07-13T00:00:00+00:00">
		<meta property="og:type" content="article">
		<meta property="og:modified_date" content="2016-08-25T00:00:00+00:00">
		<meta property="og:image" content="https://blog.jermdavis.dev/img/featured/enabling-automated-index-rebuilds-social.jpg">
		<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "article",
        "headline": "Enabling automated index&#xA0;rebuilds",
        "url": "https://blog.jermdavis.dev/posts/2015/enabling-automated-index-rebuilds",
        "image": [
            "https://blog.jermdavis.dev/img/featured/enabling-automated-index-rebuilds-social.jpg"
        ],
        "datePublished": "2015-07-13T00:00:00+00:00",
        "dateModified": "2016-08-25T00:00:00+00:00",
        "author": [{
            "@type": "Person",
            "name": "Jeremy Davis",
            "url": "https://jermdavis.dev/"
        }]
    }
    
		</script>
		<meta property="og:url" content="https://blog.jermdavis.dev/posts/2015/enabling-automated-index-rebuilds">
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">
		<link href="/scss/tailwind.css" rel="stylesheet">
		<link href="/vendor/Enlighter/enlighterjs.min.css" rel="stylesheet">
		<link href="/scss/site-theme.css" rel="stylesheet">
		<script src="/vendor/Cookies/cookies.min.js" defer=""></script>
	</head>
	<body class="max-w-7xl mx-auto text-black">
		<div class="relative bg-white" x-data="{ open: false }">
			
			<!-- desktop -->
			<div class="px-4 lg:px-6 bg-gray-100">
				<div class="bannerContainer flex justify-between items-center border-b-2 border-gray-100 py-6 lg:justify-start lg:space-x-10">
					<div class="flex justify-start lg:w-0 flex-1">
						<a href="/">
							<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
						</a>
						<div class="mx-2">
							<div class="text-3xl">Jeremy Davis</div>
							<div class="text-lg">Sitecore, C# and web development</div>
						</div>
					</div>
					<div class="nav -mr-2 -my-2 lg:hidden">
						<button @click="open = true" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-expanded="false">
							<span class="sr-only">Open menu</span>
							
							<!-- Heroicon name: outline/menu -->
							<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
							</svg>
						</button>
					</div>
					<nav class="nav hidden lg:flex space-x-10">
						<a class="text-base font-medium" href="/posts">Posts</a>
						<a class="text-base font-medium" href="/tags">Tags</a>
						<a class="text-base font-medium" href="/about">About</a>
						<a class="text-base font-medium" href="/links">Useful Links</a>
						<a class="text-base font-medium" href="/mvp">MVP</a>
					</nav>
				</div>
			</div>
			
			<!--Mobile menu, show/hide based on mobile menu state.-->
			<div class="absolute top-0 inset-x-0 p-2 transition transform origin-top-right lg:hidden z-50">
				<div class="rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 bg-white divide-y-2 divide-gray-50" x-show="open" x-transition="">
					<div class="pt-5 pb-6 px-5">
						<div class="flex items-center justify-between">
							<div class="flex">
								<a href="/">
									<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
								</a>
								<div class="mx-2">
									<div class="text-2xl">Jeremy Davis</div>
									<div class="text-base">Sitecore, C# and web development</div>
								</div>
							</div>
							<div class="nav -mr-2">
								<button @click="open = false" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
									<span class="sr-only">Close menu</span>
									
									<!-- Heroicon name: outline/x -->
									<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
									</svg>
								</button>
							</div>
						</div>
					</div>
					<div class="nav py-6 px-5 pt-0">
						<nav class=" gap-x-8">
							<a class="block mt-5 text-base font-medium" href="/posts">Posts</a>
							<a class="block mt-5 text-base font-medium" href="/tags">Tags</a>
							<a class="block mt-5 text-base font-medium" href="/about">About</a>
							<a class="block mt-5 text-base font-medium" href="/links">Useful Links</a>
							<a class="block mt-5 text-base font-medium" href="/mvp">MVP</a>
						</nav>
					</div>
				</div>
			</div>
		</div>
		<header class="bg-gray-300 px-4 py-1 lg:px-6 text-center" style="">
			<div class="post-heading">
				<div class="url p-1 bg-gray-100 rounded-md">Article printed from:
					<tt>https://blog.jermdavis.dev/posts/2015/enabling-automated-index-rebuilds</tt>
				</div>
				<h1 class="text-5xl mb-4 pb-1">
					Enabling automated index&nbsp;rebuilds
				</h1>
				<div class="meta">Published 13 July 2015</div>
				<div class="meta">Updated 25 August 2016</div>
				<div class="flex py-1">
					<a href="/tags/lucene/" class="p-1 mr-1 bg-gray-100 rounded-md">
						Lucene</a>
					<a href="/tags/powershell/" class="p-1 mr-1 bg-gray-100 rounded-md">
						PowerShell</a>
					<a href="/tags/sitecore/" class="p-1 mr-1 bg-gray-100 rounded-md">
						Sitecore</a>
				</div>
			</div>
		</header>
		<div class="py-2 lg:pl-3">
			<div class="lg:flex">
				<div class="lg:flex-auto mx-3 lg:min-w-0 content">
					<p>Another helpful addition to the "<a href="/posts/2015/automated-package-installs" target="_blank">scripted installs</a>" functions I've been looking at for the last few weeks is the ability to trigger a full rebuild of a search index. Last week we looked at
						<a href="/posts/2015/improving-the-automated-package-installs" target="_blank">deferring the indexing of items installed by a package</a>
						to try and help speed up the scripted install of packages. So it makes sense to be able to trigger a build as well... 
						<!--more-->
					</p>
					<p>A similar pattern to installing the packages can be used to trigger the index build. We can add a simple
						<code>ASPX</code>
						file with the code to build an index, and then make an HTTP request to trigger it.</p>
					<h2>Running the index build</h2>
					<blockquote>
						<b>NB</b>:
						<i>The code presented here was put together for scripting private development instances. If you were to use it on publicly accessible sites you would have to pay close attention to security, as it presents an opportunity for denial of service attacks against your site. As mentioned in the comments, you should probably consider IP Address restrictions.</i>
					</blockquote>
					<p>Sitecore exposes an API for index building, but it changes between v6.6 and v7.0 due to the way the infrastructure for search changes between these versions. Only one line needs to change here, so the code below includes both, with the v7 version commented out Based on modifying the package install endpoint we've looked at before, the code is as follows:</p>
					<pre class="code" data-enlighter-language="xml" style="width:100%; overflow:scroll;">&lt;%@ Assembly Name="Sitecore.Client" %&gt;
&lt;%@ Import Namespace="System.IO" %&gt;
&lt;%@ Import Namespace="System" %&gt;
&lt;%@ Import Namespace="System.Text.RegularExpressions" %&gt;
&lt;%@ Import Namespace="System.Configuration" %&gt;
&lt;%@ Import Namespace="log4net" %&gt;
&lt;%@ Import Namespace="Sitecore.Web" %&gt;

&lt;%@ Language="C#" %&gt;
&lt;html&gt;
&lt;script runat="server" language="C#"&gt;
    public void Page_Load(object sender, EventArgs e)
    {
        var indexes = WebUtil.GetQueryString("indexes").Split('|');
        if (indexes.Length == 0)
        {
            Response.Write("No Indexes specified");
            return;
        }
        Sitecore.Context.SetActiveSite("shell");
        foreach(var index in indexes)
        {
            if(!string.IsNullOrWhiteSpace(index))
            {
                Response.Write("Index: " + index + "&lt;br/&gt;");
                bool result = Update(index);
                if(result)
                {
                    Response.Write("Updated Index: " + index + "&lt;br/&gt;");
                }
            }
        }
    }

    protected static bool Update(string index)
    {
        // Include this line for Sitecore v6.6
        var idx = Sitecore.Search.SearchManager.GetIndex(index);

        // Include this line for Sitecore v7.0 and up
        // var idx = Sitecore.ContentSearch.ContentSearchManager.GetIndex(index);

        if(idx != null)
        {
            idx.Rebuild();
            
            return true;
        }

        return false;
    }

    protected String GetTime()
    {
        return DateTime.Now.ToString("t");
    }
&lt;/script&gt;
&lt;body&gt;
    &lt;form id="MyForm" runat="server"&gt;
    &lt;div&gt;
        This rebuilds Sitecore 6.x search indexes.&lt;/div&gt;
    Current server time is
    &lt;% =GetTime()%&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;

					</pre>
					<p>You can call this by making a request to whatever you called this page and passing a querystring that names the indexes to build. For example
						<code>/IndexRebuild.aspx?indexes=indexNameOne|indexNameTwo</code>
						will start a build for two indexes.</p>
					<h2>Triggering the rebuild from script</h2>
					<p>To make use of this, it's necessary to add a couple of functions to the PowerShell script. As with the automated package install, we need to be able to add the code above to the target Sitecore instance, and then call it.</p>
					<p>First we need to tell the config for the instance we're installing where to find the
						<code>.ASPX</code>
						file for building the index. We can also add some configuration</p>
					<pre class="code" data-enlighter-language="xml" style="width:100%; overflow:scroll;">&lt;config&gt;
  &lt;params&gt;

    &lt;param name="IndexBuildTool"&gt;.\files\IndexRebuild.aspx&lt;/param&gt;

  &lt;/params&gt;

  &lt;indexes&gt;
    &lt;index&gt;MyCustomIndex&lt;/index&gt;
  &lt;/indexes&gt;

&lt;/config&gt;

					</pre>
					<p>The set of indexes can be retrieved with a bit of PowerShell similar to the way we're extracting packages to install:</p>
					<pre class="code" data-enlighter-language="powershell" style="width:100%; overflow:scroll;">function Get-ConfigIndexes() {
    return Select-XML "/config/indexes/index/text()" $xml
}

					</pre>
					<p>The
						<code>.ASPX</code>
						can then be copied to the new Sitecore instance:</p>
					<pre class="code" data-enlighter-language="powershell" style="width:100%; overflow:scroll;">function Add-IndexBuild() {
    $siteName = Get-ConfigParam "InstanceName"
    $sitecoreFolder = "C:\Inetpub\wwwroot\$($siteName)\Website"
    
    $buildTool = Get-ConfigParam "IndexBuildTool"
    
    Write-Host "Adding index build tool to Sitecore..."
    Copy-Item $buildTool $sitecoreFolder -force
}

					</pre>
					<p>And then the config can be processed to update the indexes:</p>
					<pre class="code" data-enlighter-language="powershell" style="width:100%; overflow:scroll;">function Rebuild-Indexes() {
    $siteName = Get-ConfigParam "InstanceName"
    $sitecoreFolder = "C:\Inetpub\wwwroot\$($siteName)\Data\packages"   
    
    foreach($index in Get-ConfigIndexes) {             
        Write-Host "Updating search index $index"
    
        # call tool
        $url = "http://$siteNameIndexRebuild.aspx?indexes=$index"
        $result = Invoke-WebRequest -Uri $url -TimeoutSec 600 -OutFile ".\$siteName-IndexBuild-$index.log" -PassThru
        
        if($result.StatusCode -ne 200) {
            Write-Host "StatusCode: $($result.StatusCode)"
            throw "Index build failed for $($index)"
        }
    }

    write-host "Index build done..."
}

					</pre>
					<p>Since this is re-worked from the package install code, it generates an HTTP request for each index in configuration for performance in order to try and avoid any timeouts for these calls. But the code could just issue one request for all the configured indexes if this was more appropriate.</p>
					<blockquote>
						<b>Edited to add</b>: I've been writing this series of posts from the perspective of automating Sitecore v6.6. However if you're working with newer releases you may well want to look into the work that
						<a href="http://michaellwest.blogspot.co.uk/2015/07/sitecore-powershell-extensions-remoting.html" target="_blank" rel="noopener noreferrer">the team behind the Sitecore PowerShell Extensions have been doing on Remoting</a>. This provides an interesting alternative approach to triggering things like index rebuilds from outside Sitecore.
					</blockquote>
				</div>
				<div class="sidebar lg:flex-none lg:w-64 m-0 mt-1 lg:mt-0 lg:p-1 lg:bg-gray-100">
					<section class="mvp">
						<h3 class="bg-gray-300 p-2">Sitecore MVP 2015-2023</h3>
						<div class="bg-white mb-2 p-2">
							<a href="/mvp">
								<img class="lg:mx-auto" src="/img/mvp/2023.png" width="219" height="219" alt="2023 MVP Badge">
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Top Tags</h3>
						<div class="bg-white p-2 flex flex-wrap">
							<a href="/tags/sitecore/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Sitecore (217)</a>
							<a href="/tags/c/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								C# (53)</a>
							<a href="/tags/powershell/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								PowerShell (31)</a>
							<a href="/tags/installation/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Installation (23)</a>
							<a href="/tags/solr/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Solr (19)</a>
							<a href="/tags/general/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								General (16)</a>
							<a href="/tags/docker/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Docker (16)</a>
							<a href="/tags/ui/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								UI (15)</a>
							<a href="/tags/containers/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Containers (13)</a>
							<a href="/tags/bug/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Bug (12)</a>
						</div>
						<div class="bg-white mb-2 p-2">
							<a class="" href="/tags" role="button">All Tags
								<i class="fas fa-angle-double-right"></i>
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Recent Months</h3>
						<div class="bg-white p-2">
							<div>
								<a class="text-lg" href="/posts/2023-07">2023 - July</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2023-06">2023 - June</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2023-05">2023 - May</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2023-04">2023 - April</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2023-03">2023 - March</a>
							</div>
						</div>
						<div class="bg-white mb-2 p-2">
							<a class="" href="/posts" role="button">All Posts
								<i class="fas fa-angle-double-right"></i>
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Socials</h3>
						<div class="bg-white mb-2 p-2">
							<div>
								<a rel="me" target="_blank" href="https://mastodon.social/@jermdavis">Mastodon</a>
							</div>
							<div>
								<a rel="me" target="_blank" href="https://www.linkedin.com/in/djdavis/">LinkedIn</a>
							</div>
							<div>
								<a rel="me" target="_blank" href="https://twitter.com/jermdavis">Twitter</a>
							</div>
						</div>
					</section>
				</div>
			</div>
		</div>
		<footer class="lg:flex order-1 bg-gray-100 px-4 lg:px-6 py-4">
			<div class="flex-1 lg:flex-1 text-center lg:text-left">
				<div>©
					<a target="_blank" class="font-medium" rel="noopener" href="https://jermdavis.dev/">Jeremy Davis</a>
					2014-2023</div>
			</div>
			<div class="lg:flex-1 lg:order-3 text-center lg:text-right">
				<a class="font-medium" href="/tools">Published using Statiq</a>
				<br>
			</div>
			<ul class="list-none lg:flex-1 lg:order-2 p-0 text-center lg:align-middle" style="margin:0px !important">
				<li class="inline-block">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
					</svg>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium" target="_blank" href="/feed.rss">RSS</a>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium" target="_blank" href="/feed.atom">Atom</a>
				</li>
			</ul>
		</footer>
		<div class="min-h-screen bg-gray-300 py-6 flex flex-col justify-center sm:py-12" x-data="{ hide_banner: true }" x-init="hide_banner = docCookies.hasItem('hide_banner');" x-bind:class="{ 'hidden': hide_banner, 'fixed': !hide_banner }">
			<div class="border-2 border-gray-600 bg-gray-100 max-w-screen-lg mx-auto fixed bg-white inset-x-5 p-5 bottom-10 rounded-lg drop-shadow-2xl flex gap-4 flex-wrap md:flex-nowrap text-center md:text-left items-center justify-center md:justify-between">
				<div class="w-full text-lg">
					<a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cookie-usage" rel="noreferrer" target="_blank">This website uses Google Analytics, and its cookies.</a>
				</div>
				<button type="button" @click="hide_banner = true; docCookies.setItem('hide_banner', true, 'Fri, 31 Dec 9999 23:59:59 GMT', null, null, null, 'strict');" class="bg-gray-400 px-5 py-2 text-white rounded-md hover:bg-gray-600 focus:outline-none" aria-label="Dismiss">Understood</button>
			</div>
		</div>
		<script src="/vendor/Alpine/alpine.3.7.1.min.js" defer=""></script>
		<script src="/vendor/Enlighter/enlighterjs.min.js"></script>
		<script type="text/javascript">
            EnlighterJS.init('pre.code', 'code', {
            theme: 'droide',
            indent : 4,
            linehover : false,
            textOverflow: 'scroll',
            toolbarTop: '',
            toolbarBottom: ''
        });
        
		</script>
		<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JQ44ZR47YX"></script>
		<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-JQ44ZR47YX');
    
		</script>
	</body>
</html>