<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' *.twitter.com unpkg.com www.googletagmanager.com www.google-analytics.com *.twimg.com; img-src 'self' data: *;style-src 'self' 'unsafe-inline' *.twitter.com *.twimg.com">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="me" href="https://mastodon.social/@jermdavis">
		<link rel="canonical" href="https://blog.jermdavis.dev/posts/2014/publishing-restrictions-and-search">
		<meta name="description" content="I had to deal with a bug report in some Sitecore 6.6 / <a href=&quot;http://sitecorian.github.io/SitecoreSearchContrib/&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;>Advanced Database Crawler</a> search code recently, relating to items with publishing restrictions not disappearing from search results until another publish occurred. It struck me that there's not much written about how publishing restrictions interact with search, so I figured I should take a bit of time to write down what I'd found while sorting the bug.">
		<meta property="og:description" content="I had to deal with a bug report in some Sitecore 6.6 / <a href=&quot;http://sitecorian.github.io/SitecoreSearchContrib/&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;>Advanced Database Crawler</a> search code recently, relating to items with publishing restrictions not disappearing from search results until another publish occurred. It struck me that there's not much written about how publishing restrictions interact with search, so I figured I should take a bit of time to write down what I'd found while sorting the bug.">
		<meta name="keywords" content="Lucene, Sitecore">
		<meta name="author" content="Jeremy Davis">
		<meta name="copyright" content="Jeremy Davis">
		<title>Jeremy Davis - Publishing restrictions and&nbsp;search</title>
		<meta name="robots" content="index, follow">
		<link type="application/rss+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.rss">
		<link type="application/atom+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.atom">
		<meta name="application-name" content="Jeremy Davis">
		<meta name="msapplication-tooltip" content="Jeremy Davis">
		<meta name="msapplication-starturl" content="/">
		<link rel="manifest" href="/manifest.webmanifest">
		<meta property="og:title" content="Jeremy Davis - Publishing restrictions and&amp;#xA0;search">
		<meta property="og:image" content="https://blog.jermdavis.dev/img/featured/publishing-restrictions-and-search-social.jpg">
		<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": "Publishing restrictions and&#xA0;search",
        "image": [
            "https://blog.jermdavis.dev/img/featured/publishing-restrictions-and-search-social.jpg"
        ],
        "datePublished": "2014-11-17T00:00:00+00:00",
        "dateModified": "2016-08-25T00:00:00+00:00",
        "author": [{
            "@type": "Person",
            "name": "Jeremy Davis",
            "url": "https://jermdavis.dev/"
        }]
    }
    
		</script>
		<meta property="og:url" content="https://blog.jermdavis.dev/posts/2014/publishing-restrictions-and-search">
		<meta property="og:type" content="website">
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">
		<link href="/scss/tailwind.css" rel="stylesheet">
		<link href="/vendor/Enlighter/enlighterjs.min.css" rel="stylesheet">
		<link href="/scss/site-theme.css" rel="stylesheet">
		<script src="/vendor/Cookies/cookies.min.js" defer=""></script>
	</head>
	<body class="max-w-7xl mx-auto">
		<div class="relative bg-white" x-data="{ open: false }">
			
			<!-- desktop -->
			<div class="px-4 lg:px-6 bg-gray-100">
				<div class="flex justify-between items-center border-b-2 border-gray-100 py-6 lg:justify-start lg:space-x-10">
					<div class="flex justify-start lg:w-0 flex-1">
						<a href="/">
							<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
						</a>
						<div class="mx-2">
							<div class="text-3xl">Jeremy Davis</div>
							<div class="text-lg">Sitecore, C# and web development</div>
						</div>
					</div>
					<div class="nav -mr-2 -my-2 lg:hidden">
						<button @click="open = true" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-expanded="false">
							<span class="sr-only">Open menu</span>
							
							<!-- Heroicon name: outline/menu -->
							<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
							</svg>
						</button>
					</div>
					<nav class="nav hidden lg:flex space-x-10">
						<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/posts">Posts</a>
						<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/tags">Tags</a>
						<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/about">About</a>
						<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/links">Useful Links</a>
						<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/mvp">MVP</a>
					</nav>
				</div>
			</div>
			
			<!--Mobile menu, show/hide based on mobile menu state.-->
			<div class="absolute top-0 inset-x-0 p-2 transition transform origin-top-right lg:hidden z-50">
				<div class="rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 bg-white divide-y-2 divide-gray-50" x-show="open" x-transition="">
					<div class="pt-5 pb-6 px-5">
						<div class="flex items-center justify-between">
							<div class="flex">
								<a href="/">
									<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
								</a>
								<div class="mx-2">
									<div class="text-2xl">Jeremy Davis</div>
									<div class="text-base">Sitecore, C# and web development</div>
								</div>
							</div>
							<div class="nav -mr-2">
								<button @click="open = false" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
									<span class="sr-only">Close menu</span>
									
									<!-- Heroicon name: outline/x -->
									<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
									</svg>
								</button>
							</div>
						</div>
					</div>
					<div class="nav py-6 px-5 pt-0">
						<nav class=" gap-x-8">
							<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/posts">Posts</a>
							<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/tags">Tags</a>
							<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/about">About</a>
							<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/links">Useful Links</a>
							<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/mvp">MVP</a>
						</nav>
					</div>
				</div>
			</div>
		</div>
		<header class="bg-gray-300 px-4 py-1 lg:px-6 text-center" style="background-image: url(&amp;quot;/&amp;quot;);">
			<div class="post-heading">
				<div class="url p-1 bg-gray-100 rounded-md">Article printed from:
					<tt>https://blog.jermdavis.dev/posts/2014/publishing-restrictions-and-search</tt>
				</div>
				<h1 class="text-5xl mb-4 pb-1">
					Publishing restrictions and&nbsp;search
				</h1>
				<div class="meta">Published 17 November 2014</div>
				<div class="meta">Updated 25 August 2016</div>
				<div class="flex py-1">
					<a href="/tags/lucene/" class="p-1 mr-1 bg-gray-100 rounded-md">
						Lucene</a>
					<a href="/tags/sitecore/" class="p-1 mr-1 bg-gray-100 rounded-md">
						Sitecore</a>
				</div>
			</div>
		</header>
		<div class="py-2 lg:pl-3">
			<div class="lg:flex">
				<div class="lg:flex-auto mx-3 lg:min-w-0 content">
					<p>I had to deal with a bug report in some Sitecore 6.6 /
						<a href="http://sitecorian.github.io/SitecoreSearchContrib/" target="_blank" rel="noopener noreferrer">Advanced Database Crawler</a>
						search code recently, relating to items with publishing restrictions not disappearing from search results until another publish occurred. It struck me that there's not much written about how publishing restrictions interact with search, so I figured I should take a bit of time to write down what I'd found while sorting the bug.
						<!--more-->
					</p>
					<h2>How publishing restrictions work</h2>
					<p>There's a fair bit
						<a href="http://www.sitecore.net/en-gb/learn/blogs/technical-blogs/john-west-sitecore-blog/posts/2013/01/all-about-publishing-restrictions-in-the-sitecore-aspnet-cms.aspx" title="Publishing Restrictions" target="_blank" rel="noopener noreferrer">written about publishing restrictions in general</a>, but the idea is that you can define a time and date range during which either the whole item, or a specific version of the item is valid for publishing. The settings are made via a dialog in Page Editor:</p>
					<p>
						<a href="/img/2014/2014-11-restrictions.png" target="_blank">
							<img alt="Restrictions" src="/img/2014/2014-11-restrictions.png">
						</a>
					</p>
					<p>Clicking the "Change" button on the "Publish" ribbon opens the dialog. The editor can choose between the "version" and "item" tabs depending on which sort of restriction they wish to set. In both cases, the editor can choose if the item should ever be published (with the checkbox) or set a date/time range for publishing with the date and time selectors.</p>
					<h2>How this interacts with search</h2>
					<p>Lucene indexes items as a result of events which update the Sitecore databases. This can be when you click "save" in the Content Editor (to index the Master version) or when a publish operation copies the data to the Web database (or potentially another publishing target).</p>
					<p>If you set "do not publish" on an item via the Publishing Restrictions dialog then you will not get a version in the Web Database – hence you won't get an index entry for that item. Also, items with future publishing dates appear to be ignored by the indexer.</p>
					<p>The items that are added to an index can also be affected by the configuration for indexing – you may set up an index to receive items from only one database for example.</p>
					<p>When indexing is applied, the restriction fields get indexed into the following Lucene fields:</p>
					<ul>
						<li>Version, Pubishable From: `__valid from`</li>
						<li>Version, Publishable To: `__valid to`</li>
						<li>Item, Publishable From: `__publish`</li>
						<li>Item, Publishable To: `__unpublish`</li>
					</ul>
					Another important thing to remember is that the default configuration of indexing does not index the times set in publishing restrictions. For example, if you set restrictions like so:
					<p>
						<a href="/img/2014/2014-11-timerestrictions.png" target="_blank">
							<img alt="TimeRestrictions" src="/img/2014/2014-11-timerestrictions.png">
						</a>
					</p>
					<p>the indexed data looks like:</p>
					<p>
						<a href="/img/2014/2014-11-timeindex.png" target="_blank">
							<img alt="TimeIndex" src="/img/2014/2014-11-timeindex.png">
						</a>
					</p>
					<p>No times go into Lucene - so you can only filter search results on a "per day" basis. It's also worth noting that if you don't set a value for a publishing restriction then the value added to the index is "00010101" – which is 01/01/0001 in Lucene's format.</p>
					<h2>Filtering results on Publishing Restriction</h2>
					<p>If you need code to filter out results that have passed their unpublish date, you can extra clauses to your search query. Something along these lines:</p>
					<pre data-enlighter-language="csharp" style="width:100%; overflow:scroll;">string _unpublishedField = "__unpublish";
string _validToField = "__valid to";
        
string _noDate = Lucene.Net.Documents.DateTools.DateToString(new DateTime(0001, 01, 01), Lucene.Net.Documents.DateTools.Resolution.DAY);
string _futureDate = Lucene.Net.Documents.DateTools.DateToString(new DateTime(2100, 01, 01), Lucene.Net.Documents.DateTools.Resolution.DAY);

public void AddPublishingRestrictionsTerm(this BooleanQuery query)
{
    string today = Lucene.Net.Documents.DateTools.DateToString(DateTime.Now, Lucene.Net.Documents.DateTools.Resolution.DAY);

    BooleanQuery clause = new BooleanQuery();

    // clause for __unpublish
    BooleanQuery unpubTerm = new BooleanQuery();
    unpubTerm.Add(new TermQuery(new Term(_unpublishedField, _noDate)), BooleanClause.Occur.SHOULD);
    unpubTerm.Add(new TermRangeQuery(_unpublishedField, today, _futureDate, false, true), BooleanClause.Occur.SHOULD);
    clause.Add(unpubTerm, BooleanClause.Occur.MUST);

    // clause for __valid to
    BooleanQuery validToTerm = new BooleanQuery();
    validToTerm.Add(new TermQuery(new Term(_validToField, _noDate)), BooleanClause.Occur.SHOULD);
    validToTerm.Add(new TermRangeQuery(_validToField, today, _futureDate, false, true), BooleanClause.Occur.SHOULD);
    clause.Add(validToTerm, BooleanClause.Occur.MUST);

    query.Add(clause, BooleanClause.Occur.MUST);
}

					</pre>
					<p>The
						<code>_noDate</code>
						and
						<code>_futureDate</code>
						fields declare two values that will be used for comparisons later. As mentioned before, Lucene stores "no date" as 01/01/01, and we can format that appropriately with the
						<code>DateTools.DateToString()</code>
						method. The future date is an arbitrary value in the far future.</p>
					<p>In the
						<code>AddPublishingRestrictionsTerm()</code>
						method, we add two new clauses to the search. Both must evaluate as true for a result to be returned. Both clauses follow the same code pattern, but refer to different index fields. To cover both Item and Version expiries, we need to look at both the
						<code>__unpublish</code>
						and
						<code>__valid to</code>
						fields.</p>
					<p>For each of these we test two things. Firstly, is the value of the field equal to the "no date" value. Secondly, is the value of the field between today and our "future" date. If either of these is true this field is valid for display.</p>
					<p>Applying these clauses should mean that once an item or version's publishing restrictions expire, it will no longer be included in search results.</p>
				</div>
				<div class="sidebar lg:flex-none lg:w-72 m-0 mt-1 lg:mt-0 lg:p-1 lg:bg-gray-100">
					<section class="mvp">
						<h3 class="bg-gray-300 p-2">Sitecore MVP 2015-2022</h3>
						<div class="bg-white mb-2 p-2">
							<a href="/mvp">
								<img src="/img/mvp/2022.jpg" width="219" height="219" alt="2022 MVP Badge">
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Top Tags</h3>
						<div class="bg-white p-2 flex flex-wrap">
							<a href="/tags/sitecore/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Sitecore (207)</a>
							<a href="/tags/c/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								C# (47)</a>
							<a href="/tags/powershell/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								PowerShell (31)</a>
							<a href="/tags/installation/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Installation (23)</a>
							<a href="/tags/solr/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Solr (16)</a>
							<a href="/tags/ui/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								UI (15)</a>
							<a href="/tags/general/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								General (14)</a>
							<a href="/tags/docker/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Docker (13)</a>
							<a href="/tags/bug/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Bug (12)</a>
							<a href="/tags/coveo/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Coveo (12)</a>
						</div>
						<div class="bg-white mb-2 p-2">
							<a class="" href="/tags" role="button">All Tags
								<i class="fas fa-angle-double-right"></i>
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Recent Months</h3>
						<div class="bg-white p-2">
							<div>
								<a class="text-lg" href="/posts/2022-10">2022 - October</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2022-09">2022 - September</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2022-08">2022 - August</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2022-07">2022 - July</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2022-06">2022 - June</a>
							</div>
						</div>
						<div class="bg-white mb-2 p-2">
							<a class="" href="/posts" role="button">All Posts
								<i class="fas fa-angle-double-right"></i>
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Twitter</h3>
						<div class="bg-white mb-2 p-2">
							<a class="twitter-timeline" data-height="400" data-chrome="noheader nofooter noborders" href="https://twitter.com/jermdavis">Tweets by JermDavis</a>
							<script async="" defer="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
						</div>
					</section>
				</div>
			</div>
		</div>
		<footer class="lg:flex order-1 bg-gray-100 px-4 lg:px-6 py-4">
			<div class="flex-1 lg:flex-1 text-center lg:text-left">
				<div>©
					<a target="_blank" class="font-medium text-gray-500 hover:text-gray-900" rel="noopener" href="https://jermdavis.dev/">Jeremy Davis</a>
					2014-2022</div>
			</div>
			<div class="lg:flex-1 lg:order-3 text-center lg:text-right">
				<a class="font-medium text-gray-500 hover:text-gray-900" href="/tools">Published using Statiq</a>
				<br>
			</div>
			<ul class="list-none lg:flex-1 lg:order-2 p-0 text-center lg:align-middle" style="margin:0px !important">
				<li class="inline-block">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
					</svg>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium text-gray-500 hover:text-gray-900" target="_blank" href="/feed.rss">RSS</a>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium text-gray-500 hover:text-gray-900" target="_blank" href="/feed.atom">Atom</a>
				</li>
			</ul>
		</footer>
		<div class="min-h-screen bg-gray-300 py-6 flex flex-col justify-center sm:py-12" x-data="{ hide_banner: true }" x-init="hide_banner = docCookies.hasItem('hide_banner');" x-bind:class="{ 'hidden': hide_banner, 'fixed': !hide_banner }">
			<div class="border-2 border-gray-600 bg-gray-100 max-w-screen-lg mx-auto fixed bg-white inset-x-5 p-5 bottom-10 rounded-lg drop-shadow-2xl flex gap-4 flex-wrap md:flex-nowrap text-center md:text-left items-center justify-center md:justify-between">
				<div class="w-full text-lg">
					<a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cookie-usage" rel="noreferrer" target="_blank">This website uses Google Analytics, and its cookies.</a>
				</div>
				<button type="button" @click="hide_banner = true; docCookies.setItem('hide_banner', true, 'Fri, 31 Dec 9999 23:59:59 GMT', null, null, null, 'strict');" class="bg-gray-400 px-5 py-2 text-white rounded-md hover:bg-gray-600 focus:outline-none" aria-label="Dismiss">Understood</button>
			</div>
		</div>
		<script src="/vendor/Alpine/alpine.3.7.1.min.js" defer=""></script>
		<script src="/vendor/Enlighter/enlighterjs.min.js"></script>
		<script type="text/javascript">
        EnlighterJS.init('pre', 'code', {
            theme: 'droide',
            indent : 4,
            linehover : false,
            textOverflow: 'scroll',
            toolbarTop: '',
            toolbarBottom: ''
        });
    
		</script>
		<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JQ44ZR47YX"></script>
		<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-JQ44ZR47YX');
    
		</script>
	</body>
</html>