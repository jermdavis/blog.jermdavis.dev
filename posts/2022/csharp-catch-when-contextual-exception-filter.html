<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' *.twitter.com unpkg.com www.googletagmanager.com *.google-analytics.com *.twimg.com; img-src 'self' data: *;style-src 'self' 'unsafe-inline' *.twitter.com *.twimg.com">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="canonical" href="https://blog.jermdavis.dev/posts/2022/csharp-catch-when-contextual-exception-filter">
		<meta name="description" content="Using contextual exception filters in C# catch statements">
		<meta property="og:description" content="Using contextual exception filters in C# catch statements">
		<meta name="keywords" content=".Net, C#">
		<meta name="author" content="Jeremy Davis">
		<meta name="copyright" content="Jeremy Davis">
		<title>Jeremy Davis - Discovering C# exception filters</title>
		<meta name="robots" content="index, follow">
		<link type="application/rss+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.rss">
		<link type="application/atom+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.atom">
		<meta name="application-name" content="Jeremy Davis">
		<meta name="msapplication-tooltip" content="Jeremy Davis">
		<meta name="msapplication-starturl" content="/">
		<link rel="manifest" href="/manifest.webmanifest">
		<meta property="og:title" content="Jeremy Davis - Discovering C# exception filters">
		<meta property="og:publish_date" content="2022-11-21T00:00:00+00:00">
		<meta property="og:image" content="https://blog.jermdavis.dev/img/featured/csharp-catch-when-contextual-exception-filter-social.jpg?">
		<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": "Discovering C# exception filters",
        "image": [
            "https://blog.jermdavis.dev/img/featured/csharp-catch-when-contextual-exception-filter-social.jpg"
        ],
        "datePublished": "2022-11-21T00:00:00+00:00",
        "author": [{
            "@type": "Person",
            "name": "Jeremy Davis",
            "url": "https://jermdavis.dev/"
        }]
    }
    
		</script>
		<meta property="og:url" content="https://blog.jermdavis.dev/posts/2022/csharp-catch-when-contextual-exception-filter">
		<meta property="og:type" content="website">
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">
		<link href="/scss/tailwind.css" rel="stylesheet">
		<link href="/vendor/Enlighter/enlighterjs.min.css" rel="stylesheet">
		<link href="/scss/site-theme.css" rel="stylesheet">
		<script src="/vendor/Cookies/cookies.min.js" defer=""></script>
	</head>
	<body class="max-w-7xl mx-auto text-black">
		<div class="relative bg-white" x-data="{ open: false }">
			
			<!-- desktop -->
			<div class="px-4 lg:px-6 bg-gray-100">
				<div class="flex justify-between items-center border-b-2 border-gray-100 py-6 lg:justify-start lg:space-x-10">
					<div class="flex justify-start lg:w-0 flex-1">
						<a href="/">
							<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
						</a>
						<div class="mx-2">
							<div class="text-3xl">Jeremy Davis</div>
							<div class="text-lg">Sitecore, C# and web development</div>
						</div>
					</div>
					<div class="nav -mr-2 -my-2 lg:hidden">
						<button @click="open = true" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-expanded="false">
							<span class="sr-only">Open menu</span>
							
							<!-- Heroicon name: outline/menu -->
							<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
							</svg>
						</button>
					</div>
					<nav class="nav hidden lg:flex space-x-10">
						<a class="text-base font-medium" href="/posts">Posts</a>
						<a class="text-base font-medium" href="/tags">Tags</a>
						<a class="text-base font-medium" href="/about">About</a>
						<a class="text-base font-medium" href="/links">Useful Links</a>
						<a class="text-base font-medium" href="/mvp">MVP</a>
					</nav>
				</div>
			</div>
			
			<!--Mobile menu, show/hide based on mobile menu state.-->
			<div class="absolute top-0 inset-x-0 p-2 transition transform origin-top-right lg:hidden z-50">
				<div class="rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 bg-white divide-y-2 divide-gray-50" x-show="open" x-transition="">
					<div class="pt-5 pb-6 px-5">
						<div class="flex items-center justify-between">
							<div class="flex">
								<a href="/">
									<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
								</a>
								<div class="mx-2">
									<div class="text-2xl">Jeremy Davis</div>
									<div class="text-base">Sitecore, C# and web development</div>
								</div>
							</div>
							<div class="nav -mr-2">
								<button @click="open = false" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
									<span class="sr-only">Close menu</span>
									
									<!-- Heroicon name: outline/x -->
									<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
									</svg>
								</button>
							</div>
						</div>
					</div>
					<div class="nav py-6 px-5 pt-0">
						<nav class=" gap-x-8">
							<a class="block mt-5 text-base font-medium" href="/posts">Posts</a>
							<a class="block mt-5 text-base font-medium" href="/tags">Tags</a>
							<a class="block mt-5 text-base font-medium" href="/about">About</a>
							<a class="block mt-5 text-base font-medium" href="/links">Useful Links</a>
							<a class="block mt-5 text-base font-medium" href="/mvp">MVP</a>
						</nav>
					</div>
				</div>
			</div>
		</div>
		<header class="bg-gray-300 px-4 py-1 lg:px-6 text-center" style="background-image: url(&amp;quot;/&amp;quot;);">
			<div class="post-heading">
				<div class="url p-1 bg-gray-100 rounded-md">Article printed from:
					<tt>https://blog.jermdavis.dev/posts/2022/csharp-catch-when-contextual-exception-filter</tt>
				</div>
				<h1 class="text-5xl mb-4 pb-1">
					Discovering C# exception filters
				</h1>
				<h2 class="text-2xl">An older language feature I'd not noticed</h2>
				<div class="meta">Published 21 November 2022</div>
				<div class="flex py-1">
					<a href="/tags/net/" class="p-1 mr-1 bg-gray-100 rounded-md">
						.Net</a>
					<a href="/tags/c/" class="p-1 mr-1 bg-gray-100 rounded-md">
						C#</a>
				</div>
			</div>
		</header>
		<div class="py-2 lg:pl-3">
			<div class="lg:flex">
				<div class="lg:flex-auto mx-3 lg:min-w-0 content">
					<p>There's been a lot going on with language development in C# over the last couple of years. But despite all the current change for things like
						<a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/record" target="_blank" rel="noopener">record</a>
						types and
						<a href="https://devblogs.microsoft.com/dotnet/preview-features-in-net-6-generic-math/" target="_blank" rel="noopener">generic maths</a>, there are some changes from older versions that I somehow missed. This week social media put me on to the concept of contextual filters for exception handling. What's that? Read on...</p>
					
					<!--more-->
					<h2 id="what-are-these-filters">What are these filters?</h2>
					<p>When you need to catch an exception, the standard approach is that you decide what exception types you want to handle with your
						<code>catch</code>
						statement(s):</p>
					<pre data-enlighter-highlight="5" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">try
{
    // do something
}
catch(SpecifcExceptionType ex)
{
    // handle the error
}

					</pre>
					<p>So if a
						<code>SpecificTypeException</code>
						gets throw, the handler code here will be triggered, but if a
						<code>DifferentException</code>
						got thrown it would not. And that's all great most of the time, but what happens if you need to make decisions on what to handle based on more than just the type? Maybe the exception has a property you want to test before you decide to catch it or not?</p>
					<p>You could write this as:</p>
					<pre data-enlighter-highlight="7" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">try
{
    // do something
}
catch(SpecifcExceptionType ex)
{
    if(ex.SomeParameter == true)
    {
        // handle the error
    }
}

					</pre>
					<p>That works, but it doesn't really fit with the style that the language designers have been going for in C# of late. And it turns out there's a specific language feature that can be used for this with
						<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/dotnet/csharp/whats-new/csharp-version-history#c-version-60">C# 6 and better</a>: The
						<a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/when" target="_blank" rel="noopener">'when' execption filter</a>. And using that you can rewrite this bit of code as:</p>
					<pre data-enlighter-highlight="5" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">try
{
    // do something
}
catch(SpecifcExceptionType ex) when (ex.SomeParameter == true)
{
    // handle the error
}

					</pre>
					<p>One interesting thing that works here is that doesn't work with the more basic pattern from before is that you can have multiple catch/when statements for the same exception type if you need to. For example:</p>
					<pre data-enlighter-highlight="5,9" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">try
{
    // do something
}
catch(SpecifcExceptionType ex) when (ex.SomeParameter == 1)
{
    // handle the error one way
}
catch(SpecifcExceptionType ex) when (ex.SomeParameter == 2)
{
    // handle the error another way
}

					</pre>
					<h2 id="an-interesting-use-for-this">An interesting use for this...</h2>
					<p>Over the years, I think I've written this a few times when I'm debugging an error:</p>
					<pre data-enlighter-language="csharp" style="width:100%; overflow:scroll;">try
{
    // do something
}
catch(Exception ex)
{
    int i = 3;
}

					</pre>
					<p>And stuck a breakpoint onto the
						<code>int</code>
						declaration... So when I run the code, the debugger will break if an exception is throws.</p>
					<p>But it's a pretty obvious hack, which I always need to get rid of it before I commit anything.</p>
					<p>But it turns out there's a better way to write this. Alongside the
						<code>when</code>
						clause above, .Net also has a
						<code>Debugger</code>
						static class which can be used to detect and interact with an attached debugger. So you can write this instead:</p>
					<pre data-enlighter-highlight="5,7" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">try
{
    // do something
}
catch(Exception ex) when (Debugger.IsAttached)
{
    Debugger.Break();
}

					</pre>
					<p>If the debugger is attached to the process, this code will catch and break when the exception occurs. But if the debugger is not attached it will let the exception propagate up the call tree.</p>
					<p>Though what you'll note here is that the compiler will raise a warning on the declaration of
						<code>ex</code>
						because it's never used. I used to think I needed this to be able to see the exception. But there are two different things that can be done to get rid of that warning. One is to explicitly get rid of
						<code>ex</code>
						using another rarer language feature, and change the catch block to:</p>
					<pre data-enlighter-highlight="7" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">try
{
    // do something
}
catch(Exception ex) when (Debugger.IsAttached)
{
    _ = ex;
    Debugger.Break();
}

					</pre>
					<p>The
						<code>_</code>
						in C# 7 and later is the "<a href="https://learn.microsoft.com/en-us/dotnet/csharp/fundamentals/functional/discards" target="_blank" rel="noopener">discard operator</a>". That means "a variable that I don't care about, so you can throw it away". Using that is enough to make the compiler think you have made use of the
						<code>ex</code>
						variable, and hence get rid of the warning.</p>
					<p>But it turns out you don't need
						<code>ex</code>
						at all in VS2022 (and maybe earlier - I've not checked other versions). If you declare the code as:</p>
					<pre data-enlighter-highlight="5" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">try
{
    // do something
}
catch when (Debugger.IsAttached)
{
    Debugger.Break();
}

					</pre>
					<p>Then the debugger still keeps an "local" variable in the watches panel which can be used to look at the exception:</p>
					<p>
						<a target="_blank" href="/img/2022/11-AutoExceptionVariable.png">
							<img alt="The VS debugger showing an automatic variable for a caught exception" src="/img/2022/11-AutoExceptionVariable.png">
						</a>
					</p>
					<p>And you can also write something like
						<code>catch(NetworkException) when (Debugger.IsAttached)</code>
						if you want to filter by exception type but not bother declaring a variable.</p>
					<div style="margin-top:2em">So I may not be at the cutting edge of C#, but I feel like I learned a few things this week...</div>
				</div>
				<div class="sidebar lg:flex-none lg:w-72 m-0 mt-1 lg:mt-0 lg:p-1 lg:bg-gray-100">
					<section class="mvp">
						<h3 class="bg-gray-300 p-2">Sitecore MVP 2015-2022</h3>
						<div class="bg-white mb-2 p-2">
							<a href="/mvp">
								<img src="/img/mvp/2022.jpg" width="219" height="219" alt="2022 MVP Badge">
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Top Tags</h3>
						<div class="bg-white p-2 flex flex-wrap">
							<a href="/tags/sitecore/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Sitecore (211)</a>
							<a href="/tags/c/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								C# (48)</a>
							<a href="/tags/powershell/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								PowerShell (31)</a>
							<a href="/tags/installation/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Installation (23)</a>
							<a href="/tags/solr/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Solr (17)</a>
							<a href="/tags/docker/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Docker (15)</a>
							<a href="/tags/ui/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								UI (15)</a>
							<a href="/tags/general/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								General (14)</a>
							<a href="/tags/bug/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Bug (13)</a>
							<a href="/tags/coveo/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Coveo (12)</a>
						</div>
						<div class="bg-white mb-2 p-2">
							<a class="" href="/tags" role="button">All Tags
								<i class="fas fa-angle-double-right"></i>
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Recent Months</h3>
						<div class="bg-white p-2">
							<div>
								<a class="text-lg" href="/posts/2023-01">2023 - January</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2022-12">2022 - December</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2022-11">2022 - November</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2022-10">2022 - October</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2022-09">2022 - September</a>
							</div>
						</div>
						<div class="bg-white mb-2 p-2">
							<a class="" href="/posts" role="button">All Posts
								<i class="fas fa-angle-double-right"></i>
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Socials</h3>
						<div class="bg-white mb-2 p-2">
							<div>
								<a rel="me" target="_blank" href="https://mastodon.social/@jermdavis">Mastodon</a>
							</div>
							<div>
								<a rel="me" target="_blank" href="https://www.linkedin.com/in/djdavis/">LinkedIn</a>
							</div>
							<div>
								<a rel="me" target="_blank" href="https://twitter.com/jermdavis">Twitter</a>
							</div>
						</div>
					</section>
				</div>
			</div>
		</div>
		<footer class="lg:flex order-1 bg-gray-100 px-4 lg:px-6 py-4">
			<div class="flex-1 lg:flex-1 text-center lg:text-left">
				<div>©
					<a target="_blank" class="font-medium" rel="noopener" href="https://jermdavis.dev/">Jeremy Davis</a>
					2014-2023</div>
			</div>
			<div class="lg:flex-1 lg:order-3 text-center lg:text-right">
				<a class="font-medium" href="/tools">Published using Statiq</a>
				<br>
			</div>
			<ul class="list-none lg:flex-1 lg:order-2 p-0 text-center lg:align-middle" style="margin:0px !important">
				<li class="inline-block">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
					</svg>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium" target="_blank" href="/feed.rss">RSS</a>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium" target="_blank" href="/feed.atom">Atom</a>
				</li>
			</ul>
		</footer>
		<div class="min-h-screen bg-gray-300 py-6 flex flex-col justify-center sm:py-12" x-data="{ hide_banner: true }" x-init="hide_banner = docCookies.hasItem('hide_banner');" x-bind:class="{ 'hidden': hide_banner, 'fixed': !hide_banner }">
			<div class="border-2 border-gray-600 bg-gray-100 max-w-screen-lg mx-auto fixed bg-white inset-x-5 p-5 bottom-10 rounded-lg drop-shadow-2xl flex gap-4 flex-wrap md:flex-nowrap text-center md:text-left items-center justify-center md:justify-between">
				<div class="w-full text-lg">
					<a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cookie-usage" rel="noreferrer" target="_blank">This website uses Google Analytics, and its cookies.</a>
				</div>
				<button type="button" @click="hide_banner = true; docCookies.setItem('hide_banner', true, 'Fri, 31 Dec 9999 23:59:59 GMT', null, null, null, 'strict');" class="bg-gray-400 px-5 py-2 text-white rounded-md hover:bg-gray-600 focus:outline-none" aria-label="Dismiss">Understood</button>
			</div>
		</div>
		<script src="/vendor/Alpine/alpine.3.7.1.min.js" defer=""></script>
		<script src="/vendor/Enlighter/enlighterjs.min.js"></script>
		<script type="text/javascript">
        EnlighterJS.init('pre', 'code', {
            theme: 'droide',
            indent : 4,
            linehover : false,
            textOverflow: 'scroll',
            toolbarTop: '',
            toolbarBottom: ''
        });
    
		</script>
		<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JQ44ZR47YX"></script>
		<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-JQ44ZR47YX');
    
		</script>
	</body>
</html>