<!DOCTYPE html>
<html lang="en">
	<head>
		<script src="/js/theme.js"></script>
		<meta charset="utf-8">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' unpkg.com www.googletagmanager.com *.google-analytics.com; img-src 'self' data: *;style-src 'self' 'unsafe-inline'; frame-src https://www.youtube.com/">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="canonical" href="https://blog.jermdavis.dev/posts/2017/an-experiment-with-automatic-tests">
		<meta name="description" content="I spent some time working with some code recently, which had some annoying habits of failing oddly in scenarios where nulls got passed into constructors. While I was trying to work around some of these issues, it struck me that tests for parameter handling for constructors are one of those annoying things that tend to make unit testing frustrating. They're annoying boiler-plate to write if you need them, and then a constructor signature changes, you end up with a lot of make-work test changes to do.
So as an exercise in &quot;learning something new&quot;, wondered whether I could automate them in a reasonable way...">
		<meta property="og:description" content="I spent some time working with some code recently, which had some annoying habits of failing oddly in scenarios where nulls got passed into constructors. While I was trying to work around some of these issues, it struck me that tests for parameter handling for constructors are one of those annoying things that tend to make unit testing frustrating. They're annoying boiler-plate to write if you need them, and then a constructor signature changes, you end up with a lot of make-work test changes to do.
So as an exercise in &quot;learning something new&quot;, wondered whether I could automate them in a reasonable way...">
		<meta name="keywords" content="T4 Templates, Unit Test">
		<meta name="author" content="Jeremy Davis">
		<meta name="copyright" content="Jeremy Davis">
		<title>Jeremy Davis - An experiment with automatic&nbsp;tests</title>
		<meta name="robots" content="index, follow">
		<link type="application/rss+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.rss">
		<link type="application/atom+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.atom">
		<meta name="application-name" content="Jeremy Davis">
		<meta name="msapplication-tooltip" content="Jeremy Davis">
		<meta name="msapplication-starturl" content="/">
		<link rel="manifest" href="/manifest.webmanifest">
		<meta name="fediverse:creator" content="@jermdavis@mastodon.social">
		<meta property="og:type" content="article">
		<meta property="og:title" content="An experiment with automatic&nbsp;tests [by Jeremy Davis]">
		<meta property="og:publish_date" content="2017-09-18T00:00:00+0000">
		<meta property="article:published_time" content="2017-09-18T00:00:00+0000">
		<meta property="og:image" content="https://blog.jermdavis.dev/img/featured/an-experiment-with-automatic-tests-social.jpg">
		<meta property="og:image:alt" content="Logo image showing post title 'An experiment with automatic&nbsp;tests' and author 'Jeremy Davis'">
		<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "article",
        "headline": "An experiment with automatic tests",
        "url": "https://blog.jermdavis.dev/posts/2017/an-experiment-with-automatic-tests",
        "image": [
            {
                "@type": "ImageObject",
                "contentUrl": "https://blog.jermdavis.dev/img/featured/an-experiment-with-automatic-tests-social.jpg",
                "caption": "Logo image showing post title 'An experiment with automatic tests' and author 'Jeremy Davis'"
            }
        ],
        "datePublished": "2017-09-18T00:00:00+0000",
        "author": [{
            "@type": "Person",
            "name": "Jeremy Davis",
            "url": "https://jermdavis.dev/"
        }]
    }
    
		</script>
		<meta property="og:url" content="https://blog.jermdavis.dev/posts/2017/an-experiment-with-automatic-tests">
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">
		<link href="/vendor/Enlighter/enlighterjs.min.css" rel="stylesheet">
		<link href="/dist/main.css" rel="stylesheet">
		<script src="/vendor/Cookies/cookies.min.js" defer=""></script>
		<script type="module" src="/vendor/snow/snow-fall.js"></script>
	</head>
	<body class="blog" x-bind:class="dk ? 'dark' : ''" id="top">
		<snow-fall text="❄️"></snow-fall>
		<div id="rp-bar"></div>
		<div class="blogNavContainer" x-data="{ open: false }">
			<div class="blogNav">
				<div class="bannerContainer">
					<div class="bannerRow">
						<a href="/">
							<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
						</a>
						<div class="mx-2">
							<div class="text-3xl">Jeremy Davis</div>
							<div class="text-lg">Sitecore, C# and web development</div>
						</div>
					</div>
					<div class="nav navBurger">
						<button @click="open = true" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-expanded="false">
							<span class="sr-only">Open menu</span>
							<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
							</svg>
						</button>
					</div>
					<nav class="nav navItemSet">
						<a href="/posts">Posts</a>
						<a href="/tags">Tags</a>
						<a href="/about">About</a>
						<a href="/links">Useful Links</a>
						<a href="/mvp">MVP</a>
						<a href="/search">Search</a>
						<button x-cloak="" x-on:click="Clicked('2')" x-show="$store.theme == '1'">
							<img src="/img/Auto.png" width="32" height="32" alt="Auto" title="Automatic theme">
						</button>
						<button x-cloak="" x-on:click="Clicked('3')" x-show="$store.theme == '2'">
							<img src="/img/Light.png" width="32" height="32" alt="Auto" title="Light theme">
						</button>
						<button x-cloak="" x-on:click="Clicked('1')" x-show="$store.theme == '3'">
							<img src="/img/Dark.png" width="32" height="32" alt="Auto" title="Dark theme">
						</button>
					</nav>
				</div>
			</div>
			<div class="mobileContainer">
				<div style="display:none;" class="popupBox" x-show="open" x-transition="">
					<div class="popupHead">
						<div class="popupHeadInner">
							<div class="titleRow">
								<a href="/">
									<img width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
								</a>
								<div class="mx-2">
									<div class="text-2xl">Jeremy Davis</div>
									<div class="text-base">Sitecore, C# and web development</div>
								</div>
							</div>
							<div class="nav menuRow">
								<button @click="open = false" type="button">
									<span class="sr-only">Close menu</span>
									
									<!-- Heroicon name: outline/x -->
									<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
									</svg>
								</button>
							</div>
						</div>
					</div>
					<div class="nav popupItemsOuter">
						<nav class="gap-x-8">
							<a href="/posts">Posts</a>
							<a href="/tags">Tags</a>
							<a href="/about">About</a>
							<a href="/links">Useful Links</a>
							<a href="/mvp">MVP</a>
							<a href="/search">Search</a>
							<button x-cloak="" x-on:click="Clicked('2')" x-show="$store.theme == '1'">
								<img src="/img/Auto.png" width="32" height="32" alt="Auto" title="Automatic theme">
							</button>
							<button x-cloak="" x-on:click="Clicked('3')" x-show="$store.theme == '2'">
								<img src="/img/Light.png" width="32" height="32" alt="Auto" title="Light theme">
							</button>
							<button x-cloak="" x-on:click="Clicked('1')" x-show="$store.theme == '3'">
								<img src="/img/Dark.png" width="32" height="32" alt="Auto" title="Dark theme">
							</button>
						</nav>
					</div>
				</div>
			</div>
		</div>
		<header class="headerContainer" style="">
			<div class="post-heading">
				<div class="url printBanner">Article printed from:
					<tt>https://blog.jermdavis.dev/posts/2017/an-experiment-with-automatic-tests</tt>
				</div>
				<h1>
					An experiment with automatic&nbsp;tests
				</h1>
				<div class="meta">Published 18 September 2017</div>
				<div class="tagList">
					<a href="/tags/t4-templates/">
						T4 Templates</a>
					<a href="/tags/unit-test/">
						Unit Test</a>
					<span>~10 min. read</span>
				</div>
			</div>
		</header>
		<div class="blogContainerOuter">
			<div class="blogContainerInner">
				<div class="leftCol content">
					<p>I spent some time working with some code recently, which had some annoying habits of failing oddly in scenarios where nulls got passed into constructors. While I was trying to work around some of these issues, it struck me that tests for parameter handling for constructors are one of those annoying things that tend to make unit testing frustrating. They're annoying boiler-plate to write if you need them, and then a constructor signature changes, you end up with a lot of make-work test changes to do.</p>
					<p>So as an exercise in "learning something new", wondered whether I could automate them in a reasonable way...
						<!--more-->
					</p>
					<h2 x-data="" class="anchor">What do we want to test?<a title="click to copy url" x-on:click.prevent="copy($event.target)" href="#heading1" name="heading1">
							<img src="/img/link.png">
						</a>
						<span>url copied!</span>
					</h2>
					For the sake of a simple example, lets assume we want to validate that any reference parameters passed into a constructor will throw an `ArgumentNullException` if a null is supplied, and that we want to test any public constructor taking more than one parameter. Based on experience there may be some types we explicitly want to exclude from tests, but by default all public classes should be included.
					<p>Ideally these tests should also look like (and get run in the same way) as the standard unit tests for the rest of the code.</p>
					<h2 x-data="" class="anchor">One way to achieve this...<a title="click to copy url" x-on:click.prevent="copy($event.target)" href="#heading2" name="heading2">
							<img src="/img/link.png">
						</a>
						<span>url copied!</span>
					</h2>
					If we want to generate unit tests that look and feel like "normal" tests, then a fairly obvious way to achieve this is to generate the source code for those tests via the
					<a href="https://msdn.microsoft.com/en-us/library/bb126445.aspx" target="_blank" rel="noopener noreferrer">T4 Template engine in Visual Studio</a>. Reflection over the assembly we want to generate tests for will allow us to find the constructors to test, and extract data about their parameters for the purpose of generating code.
					<p>Then the code needs to generate a test for each parameter that is a reference type, where it sets one parameter to
						<code>null</code>
						while supplying valid defaults for the others. We expect the test to throw, so the
						<code>ExpectedException</code>
						attribute needs adding to each test.</p>
					<h2 x-data="" class="anchor">Implementing all that...<a title="click to copy url" x-on:click.prevent="copy($event.target)" href="#heading3" name="heading3">
							<img src="/img/link.png">
						</a>
						<span>url copied!</span>
					</h2>
					The first step then, is to be able to find the set of types we want to process to make tests. That's fairly easy to achieve with reflection. You want a list of all the public classes that aren't abstract. It also seems useful to exclude any classes marked as "don't test this one". That's easy to do by tagging them with a custom attribute. That can be defined simply enough:
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">[AttributeUsage(AttributeTargets.Class)]
public class NoAutomaticTestAttribute : Attribute
{
}

					</pre>
					<p>Having spent some time experimenting with this code, I've come to the conclusion that (much like Razor or ASPX files) you should keep logic and code to a minimum in T4 files, so I'm trying to make as much of the logic as possible into functions that the T4 file can call. The function to fetch the relevant types can be something like:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public static IEnumerable&lt;Type&gt; FetchTypesToTest(Assembly assembly)
{
    return assembly.GetTypes()
        .Where(t =&gt; t.IsClass &amp;&amp; t.IsPublic &amp;&amp; !t.IsAbstract)
        .Where(t =&gt; t.CustomAttributes.Where(a =&gt; a.AttributeType== typeof(NoAutomaticTestAttribute)).Any() == false)
        .AsEnumerable();
}

					</pre>
					<p>Calling that code requires an assembly. For the sake of completeness that can be returned via a function too:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public static Assembly FetchAssembly(string path)
{
    return Assembly.LoadFrom(path);
}

					</pre>
					<p>That lets you generate tests for any DLL – but how do you reliably get the path to the one you want? You could hard-code it into your T4 file, but that's fragile – if someone clones your code to a different path then it can break. What may be easier is to make use of the T4 Engine's ability to ask Visual Studio to work out the values of the same path macros you can use in Post-Build Events. That requires two things. First you need to declare your template as being "aware of its hosting environment". That means
						<a href="https://stackoverflow.com/questions/15406506/what-does-hostspecific-signify-in-a-t4-template" target="_blank" rel="noopener noreferrer">setting the
							<code>hostspecific</code>
							attribute</a>
						in the template decoration to true:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">&lt;#@ template debug="false" hostspecific="true" language="C#" #&gt;

					</pre>
					<p>(Note that this may cause issues with hosted builds – since they don't include Visual Studio)</p>
					<p>And secondly you need to write your template code to ask for the values of the macros:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">string path = this.Host.ResolveAssemblyReference(@"$(ProjectDir)bin\$(ConfigurationName)");

					</pre>
					<p>To make use of the helper code in the test assembly, you need to make a reference to the DLL containing that code in your T4 file. For my test project that was:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">&lt;#@ assembly name="$(ProjectDir)bin\$(ConfigurationName)\AutoConstructorTest.Tests.dll" #&gt;

					</pre>
					<p>Note that these assembly reference declarations can make use of the path macros without need for the host-awareness change above. That is only needed if you're using the macros in the code of the T4 file.</p>
					<p>With that in place, the basic generation of test classes in the T4 file can look like:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">// **
// ** Generated code - do not edit
// **
using System;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Moq;

namespace AutoConstructorTest.Tests
{
&lt;#
	string path = this.Host.ResolveAssemblyReference(@"$(ProjectDir)bin\$(ConfigurationName)");
	var assembly = ConstructorTestHelper.FetchAssembly(path + @"\AutoConstructorTest.Examples.dll");
	var types = ConstructorTestHelper.FetchTypesToTest(assembly);
	foreach(var typeToTest in types)
        {
#&gt;

	[TestClass]
	[TestCategory("AutoGenerated")]
	public class &lt;#= typeToTest.Name #&gt;_GeneratedTests
	{
        }
&lt;#
        }    
#&gt;

					</pre>
					<p>At this point I realised two things about T4 that irritate me. First is that it's really hard to format a T4 template so that the indenting looks right in both the template and in the generated output. I kind of gave up there, and accepted that the template file looks a bit odd. The second is a bit more of a challenge: this code works, but the reflection load of the target assembly puts a lock on it. That means you find yourself restarting Visual Studio a lot while you're working through writing code like this. Pretty much every time you hit build. And that gets frustrating.</p>
					<p>An alternative here is to use a "<a href="https://msdn.microsoft.com/en-us/library/system.reflection.assembly.reflectiononlyloadfrom(v=vs.110).aspx" target="_blank" rel="noopener noreferrer">Reflection Only Load</a>" for the assembly you're going to process. That doesn't take the same locks, but requires slightly different code.</p>
					<p>First up, loading the DLL to process needs adjusting to look like this:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public static Assembly FetchAssembly(string path)
{
    return Assembly.ReflectionOnlyLoadFrom(path);
}

					</pre>
					<p>Making that change may cause an error though. A reflection-only load uses a different memory scope, and dependent assemblies aren't loaded automatically. I'd put my "exclude from test" attribute into a separate assembly, and that wasn't automatically loaded into the reflection-only scope. So that needed a new initialisation method before loading the assembly to be tested:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public static void InitialiseTestHelper(string path)
{
    Assembly.ReflectionOnlyLoadFrom(path + @"\AutoConstructorTest.dll");
}

					</pre>
					<p>(Different code may need other things loaded here – it depends on what your target dll needs in memory)<br>
						And the new method needs calling in the template as well:</p>
					<pre class="code" data-enlighter-highlight="12" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">// **
// ** Generated code - do not edit
// **
using System;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Moq;

namespace AutoConstructorTest.Tests
{
&lt;#
        string path = this.Host.ResolveAssemblyReference(@"$(ProjectDir)bin\$(ConfigurationName)");
        ConstructorTestHelper.InitialiseTestHelper(path);
        var assembly = ConstructorTestHelper.FetchAssembly(path + @"\AutoConstructorTest.Examples.dll");
        var types = ConstructorTestHelper.FetchTypesToTest(assembly);
        foreach(var typeToTest in types)
        {
#&gt;

        [TestClass]
        [TestCategory("AutoGenerated")]
        public class &lt;#= typeToTest.Name #&gt;_GeneratedTests
        {
        }
&lt;#
        }    
#&gt;

					</pre>
					<p>This code worked, and allowed the build and generation to run without locking the target assembly every time. But it raised a new issue. The code for filtering out assemblies with the "don't test this" attribute stopped working, and it returned all types, whether they included the custom attribute or not.</p>
					<p>A bit of head scratching about that lead me to two things. First, attaching the debugger to the T4 Template still locks the target DLL. So you probably still need to re-start Visual Studio after you've done that and before you do a rebuild of your code. But the other thing was subtler. The test for "does the class being examined have the custom attribute" is comparing the type data for the attribute found on the class to
						<code>typeof(NoAutomaticTestAttribute)</code>. A type loaded into a reflection-only scope
						<i>is not the same thing</i>
						as a type loaded into the normal execution scope. So that test can't work any more. There may well be a better way to address this, but the easiest change to make is to compare the names of the types, rather than their type objects directly:</p>
					<pre class="code" data-enlighter-highlight="3" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">            var x = assembly.GetTypes()
                .Where(t =&gt; t.IsClass &amp;&amp; t.IsPublic &amp;&amp; !t.IsAbstract)
                .Where(t =&gt; t.CustomAttributes.Where(a =&gt; a.AttributeType.Name == typeof(NoAutomaticTestAttribute).Name).Any() == false)
                .AsEnumerable();

					</pre>
					<p>With that change made, the code worked again.</p>
					<p>Next step then, is to generate a test for each of the constructor parameters we want to check. Given a type, we can extract the set of constructors easily enough. We just want any public constructors for instances of the type:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public static IEnumerable&lt;ConstructorInfo&gt; FetchConstructorsToTest(Type type)
{
    return type
        .GetConstructors(BindingFlags.Public | BindingFlags.Instance)
        .AsEnumerable();
}

					</pre>
					<p>The template can then iterate all the constructors, and for each one iterate all of the constructor parameters, ignoring any ones which take value types. (As they won't accept null) And for each of these it can generate variables for the set of parameters and a call to the class we want to test:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">    [TestClass]
    [TestCategory("AutoGenerated")]
    public class &lt;#= typeToTest.Name #&gt;_GeneratedTests
    {

&lt;#
        var constructors = ConstructorTestHelper.FetchConstructorsToTest(typeToTest);
        foreach(var constructor in constructors)
        {
            var parameters = constructor.GetParameters();
            foreach(var nullParameter in parameters)
            {
                if(nullParameter.ParameterType.IsValueType) continue;
#&gt;
        [TestMethod]
        [ExpectedException(typeof(ArgumentNullException))]
        public void &lt;#= typeToTest.Name #&gt;_Constructor_&lt;#= parameters.Count() #&gt;Params_&lt;#= nullParameter.Name #&gt;_IsNull_Throws()
        {
&lt;#
                foreach(var parameter in parameters)
                {
                    if(parameter.Name == nullParameter.Name)
                    {
#&gt;
                &lt;#= ConstructorTestHelper.GenerateTypeName(parameter.ParameterType) #&gt; &lt;#= parameter.Name #&gt; = null;
&lt;#
                    }
                    else
                    {
#&gt;
                var &lt;#= parameter.Name #&gt; = &lt;#= ConstructorTestHelper.FetchDefaultValue(parameter) #&gt;;
&lt;#
                    }
                }
#&gt;

                var sut = new &lt;#= typeToTest.FullName #&gt;(&lt;#= ConstructorTestHelper.GenerateConstructorParameterList(parameters) #&gt;);
        }

&lt;#
            }
        }
#&gt;
    }
&lt;#
    }

					</pre>
					<p>That looks a bit complicated, but that's mostly down to mixing the T4 logic with its output. For each constructor found, it grabs the set of parameters. It iterates these and generates a
						<code>TestMethod</code>
						for each one that is not a value type. These get named based on what they represent - "a test that nulling the nth parameter throws an exception". Inside that test the code iterates the set of parameters again. For each one it checks if this is the parameter we're going to set to null. If it is, it outputs a variable with the right type and a null value. If not, it calls a function to fetch a sensible default value for the variable. Finally it generates a call to the constructor of the type being tested, passing in the variables it has created.</p>
					<p>The constructor parameters can be generated very simply – by concatenating a list of parameter names:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public static string GenerateConstructorParameterList(IEnumerable&lt;ParameterInfo&gt; parameters)
{
    return String.Join(", ", parameters.Select(p =&gt; p.Name));
}

					</pre>
					<p>You also need the names of the types you're creating. The simplest approach to that is just to use
						<code>parameter.FullName</code>. But that only works for simple types. If you try that with something generic you'll end up code that doesn't compile. The .Net formal name for a generic type uses back-ticks numbers and square brackets to describe it. Things a bit like
						<code>List</code>1[Int32]` – and that's not valid C#. There may be a better way of handling this, but my first stab was to generate the C#-friendly name from the type data like so:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public static string GenerateTypeName(Type t)
{
    if (t.IsGenericType)
    {
        string name = t.FullName.Substring(0, t.FullName.IndexOf('`'));

        return name + "&lt;" + String.Join(", ", t.GetGenericArguments().Select(a =&gt; GenerateTypeName(a))) + "&gt;";
    }
    else
    {
        return t.FullName;
    }
}

					</pre>
					<p>That handles both cases.</p>
					<p>Generating the default values for the constructor parameters needed a bit more thought. For the purposes of my experiment I've only addressed strings, simple value types like ints and the reference types the tests really care about. But code for other types wouldn't be too hard to add if you needed to.</p>
					<p>Any string paramters can take the value
						<code>string.Empty</code>. Anything that's a simple value type can be initialised to a sensible default with the runtime's
						<code>&lt;a href="https://msdn.microsoft.com/en-us/library/system.activator.createinstance(v=vs.110).aspx" target="_blank" rel="noopener noreferrer"&gt;Activator.CreateInstance()&lt;/a&gt;</code>
						method. And whatever's left is a reference type that we can create a test mock for with
						<code>new Mock()</code>. (I'm using the
						<a href="https://github.com/moq/moq4" target="_blank" rel="noopener noreferrer">moq</a>
						framework here – but other mocking tools would work as well)</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public static string FetchDefaultValue(ParameterInfo parameter)
{
    string defaultValue = null;
    if (parameter.ParameterType.Name == "String")
    {
        defaultValue = "String.Empty";
    }
    else if (parameter.ParameterType.IsValueType)
    {
        var v = Activator.CreateInstance(parameter.ParameterType);
        defaultValue = v.ToString().ToLower();
    }
    else
    {
        defaultValue = "new Mock&lt;" + GenerateTypeName(parameter.ParameterType) + "&gt;().Object";
    }

    return defaultValue;
}

					</pre>
					<p>With that in place, you can generate tests for quite a wide spread of classes. They come out looking like this:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">[TestClass]
[TestCategory("AutoGenerated")]
public class ValidClass2_GeneratedTests
{

    [TestMethod]
    [ExpectedException(typeof(ArgumentNullException))]
    public void ValidClass2_Constructor_2Params_s1_IsNull_Throws()
    {
            System.String s1 = null;
            var i = new Mock&lt;AutoConstructorTest.Examples.ISomeInterface&gt;().Object;

            var sut = new AutoConstructorTest.Examples.ValidClass2(s1, i);
    }

    [TestMethod]
    [ExpectedException(typeof(ArgumentNullException))]
    public void ValidClass2_Constructor_2Params_i_IsNull_Throws()
    {
            var s1 = String.Empty;
            AutoConstructorTest.Examples.ISomeInterface i = null;

            var sut = new AutoConstructorTest.Examples.ValidClass2(s1, i);
    }

    [TestMethod]
    [ExpectedException(typeof(ArgumentNullException))]
    public void ValidClass2_Constructor_3Params_s1_IsNull_Throws()
    {
            System.String s1 = null;
            var s2 = String.Empty;
            var i = new Mock&lt;AutoConstructorTest.Examples.ISomeInterface&gt;().Object;

            var sut = new AutoConstructorTest.Examples.ValidClass2(s1, s2, i);
    }

    [TestMethod]
    [ExpectedException(typeof(ArgumentNullException))]
    public void ValidClass2_Constructor_3Params_s2_IsNull_Throws()
    {
            var s1 = String.Empty;
            System.String s2 = null;
            var i = new Mock&lt;AutoConstructorTest.Examples.ISomeInterface&gt;().Object;

            var sut = new AutoConstructorTest.Examples.ValidClass2(s1, s2, i);
    }

    [TestMethod]
    [ExpectedException(typeof(ArgumentNullException))]
    public void ValidClass2_Constructor_3Params_i_IsNull_Throws()
    {
            var s1 = String.Empty;
            var s2 = String.Empty;
            AutoConstructorTest.Examples.ISomeInterface i = null;

            var sut = new AutoConstructorTest.Examples.ValidClass2(s1, s2, i);
    }

}

					</pre>
					<p>And the Visual Studio test explorer can run them:</p>
					<p>
						<a href="/img/2017/2017-08-passedtests.png" target="_blank">
							<img alt="Passed Tests" src="/img/2017/2017-08-passedtests.png">
						</a>
					</p>
					<h2 x-data="" class="anchor">Conclusions<a title="click to copy url" x-on:click.prevent="copy($event.target)" href="#heading4" name="heading4">
							<img src="/img/link.png">
						</a>
						<span>url copied!</span>
					</h2>
					Well it works – you can indeed generate these boilerplate tests.
					<p>If you want a working example,
						<a href="https://github.com/jermdavis/AutoConstructorTest" target="_blank" rel="noopener noreferrer">the solution that the snippets above are taken from is available on GitHub</a>
						for you to play with.</p>
					<p>But it would be fair to say that the T4 templating experience isn't that fantastic while you write stuff like this. You can make it a bit better by installing an add-on like the "<a href="http://t4-editor.tangible-engineering.com/T4-Editor-Visual-T4-Editing.html" target="_blank" rel="noopener noreferrer">Tangible T4 Editor</a>" to get some syntax highlighting and other editor features. However the issues around assembly locking still cause a lot of "click build, wait for the compiler to time out while trying to overwrite a locked assembly, grumble, close Visual Studio, open it again and re-try the build" issues. (Which is as annoying to experience as it is to type out...)</p>
					<p>There's also the problem that if you get something wrong in your T4 template it can generate bad C#. That can be a subtle issue, say missing a semi-colon or a brace – which can be quite hard to spot with the noise of code and data in a template. Or it can be a bigger issue. Sometimes the T4 engine will generate half a file and stop on an error – leaving a wholly invalid fragment of C# in the file. Or if the error prevents the engine doing any templating you get a file that just contains
						<code>ErrorGeneratingOutput</code>. All of these will prevent the build of your solution until you tidy them up. But if the T4 error is caused by an issue in your ordinary C# code (like messing up one of the helper functions) then you're stuck in a vicious circle of not being able to compile your helper because the T4 generated code is broken because of the helper.... etc.... etc....</p>
					<p>Either that means I'm a bit mad for trying to factor out the logic into more readable (and testable) code, or it means that you really need to put that stuff into a separate DLL to allow it to be compiled individually. I'm musing on the idea that maybe the helper functions should just be declared at the top of the T4 file.</p>
					<p>Doing this has taught me some interesting stuff, but were I to address this sort if issue again then I'll probably try googling for a pre-existing library for automatic test generation, and ignore the desire to have these tests look like my other ones.</p>
					<p>
						<a href="https://en.wikipedia.org/wiki/Not_invented_here" target="_blank" rel="noopener noreferrer">Not Invented Here Syndrome</a>
						can help you learn – but it's still not a good thing...</p>
					<a class="gotop" href="#top">↑ Back to top</a>
					<ul class="shares">
						<li>
							<b>Feel like sharing?</b>
						</li>
						<li>⇒
							<a target="_blank" rel="nofollow noreferrer" href="https://bsky.app/intent/compose?text=An experiment with automatic&nbsp;tests+https%3A%2F%2Fblog.jermdavis.dev%2Fposts%2F2017%2Fan-experiment-with-automatic-tests">On BlueSky</a>
						</li>
						<li>⇒
							<a target="_blank" rel="nofollow noreferrer" href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fblog.jermdavis.dev%2Fposts%2F2017%2Fan-experiment-with-automatic-tests">On LinkedIn</a>
						</li>
						<li>⇒
							<a target="_blank" rel="nofollow noreferrer" href="https://mastodonshare.com/?text=An experiment with automatic&nbsp;tests&amp;url=https%3A%2F%2Fblog.jermdavis.dev%2Fposts%2F2017%2Fan-experiment-with-automatic-tests">On Mastodon</a>
						</li>
						<li>⇒
							<a target="_blank" rel="nofollow noreferrer" data-no-validate="data-no-validate" href="mailto:someone@somewhere&amp;body=An experiment with automatic&nbsp;tests%20https%3A%2F%2Fblog.jermdavis.dev%2Fposts%2F2017%2Fan-experiment-with-automatic-tests">On Email</a>
						</li>
						<li></li>
					</ul>
				</div>
				<div class="rightCol sidebar">
					<div class="barContainer">
						<section class="headingSummary">
							<h3>Post Headings</h3>
							<div>
								<ol class="headings">
									<li>
										<a href="#heading1">What do we want to test?</a>
									</li>
									<li>
										<a href="#heading2">One way to achieve this...</a>
									</li>
									<li>
										<a href="#heading3">Implementing all that...</a>
									</li>
									<li>
										<a href="#heading4">Conclusions</a>
									</li>
								</ol>
							</div>
						</section>
						<section class="mvp">
							<h3>Sitecore MVP 2015-2025</h3>
							<div>
								<a href="/mvp">
									<img class="l" src="/img/mvp/program.png" width="219" height="219" alt="2025 MVP Badge">
									<img class="d" src="/img/mvp/program_d.png" width="219" height="219" alt="2025 MVP Badge">
								</a>
							</div>
						</section>
						<section class="recentTags">
							<h3>Recent Tags</h3>
							<div>
								<a href="/tags/text-games/">
									Text Games
								</a>
								<a href="/tags/c/">
									C#
								</a>
								<a href="/tags/symposium/">
									Symposium
								</a>
								<a href="/tags/sitecore/">
									Sitecore
								</a>
								<a href="/tags/saas/">
									SaaS
								</a>
								<a href="/tags/platform-dxp/">
									Platform DXP
								</a>
								<a href="/tags/search/">
									Search
								</a>
								<a href="/tags/presentation/">
									Presentation
								</a>
								<a href="/tags/mvc/">
									MVC
								</a>
								<a href="/tags/razor/">
									Razor
								</a>
							</div>
						</section>
						<section class="topTags">
							<h3>Top Tags</h3>
							<div class="list">
								<a href="/tags/sitecore/">
									Sitecore (250)</a>
								<a href="/tags/platform-dxp/">
									Platform DXP (217)</a>
								<a href="/tags/c/">
									C# (74)</a>
								<a href="/tags/powershell/">
									PowerShell (33)</a>
								<a href="/tags/installation/">
									Installation (23)</a>
								<a href="/tags/docker/">
									Docker (20)</a>
								<a href="/tags/general/">
									General (19)</a>
								<a href="/tags/solr/">
									Solr (19)</a>
								<a href="/tags/containers/">
									Containers (17)</a>
								<a href="/tags/net/">
									.Net (15)</a>
							</div>
							<div class="link">
								<a href="/tags" role="button">All Tags &gt;</a>
							</div>
						</section>
						<section class="months">
							<h3>Recent Months</h3>
							<div class="list">
								<a href="/posts/2025-12">2025 - December</a>
								<a href="/posts/2025-11">2025 - November</a>
								<a href="/posts/2025-10">2025 - October</a>
								<a href="/posts/2025-09">2025 - September</a>
								<a href="/posts/2025-08">2025 - August</a>
							</div>
							<div class="link">
								<a href="/posts" role="button">All Months &gt;</a>
							</div>
						</section>
						<section class="socials">
							<h3>Socials</h3>
							<div>
								<table>
									<tbody>
										<tr>
											<td class="icon">
												<a rel="me" target="_blank" href="https://bsky.app/profile/jermdavis.dev">
													<img src="/img/bluesky.png" width="32" height="32" alt="Bluesky Logo">
												</a>
											</td>
											<td class="title">
												<a rel="me" target="_blank" href="https://bsky.app/profile/jermdavis.dev">
													Bluesky
												</a>
											</td>
										</tr>
										<tr>
											<td class="icon">
												<a rel="me" target="_blank" href="https://www.linkedin.com/in/djdavis/">
													<img src="/img/linkedin.png" width="32" height="32" alt="LinkedIn Logo">
												</a>
											</td>
											<td class="title">
												<a rel="me" target="_blank" href="https://www.linkedin.com/in/djdavis/">
													LinkedIn
												</a>
											</td>
										</tr>
										<tr>
											<td class="icon">
												<a rel="me" target="_blank" href="https://sitecorechat.slack.com/team/U73KL641G">
													<img src="/img/slack.png" width="32" height="32" alt="Sitecore Slack Logo">
												</a>
											</td>
											<td class="title">
												<a rel="me" target="_blank" href="https://sitecorechat.slack.com/team/U73KL641G">
													Sitecore Slack
												</a>
											</td>
										</tr>
										<tr>
											<td class="icon">
												<a rel="me" target="_blank" href="https://mastodon.social/@jermdavis">
													<img src="/img/mastodon.png" width="32" height="32" alt="Mastodon Logo">
												</a>
											</td>
											<td class="title">
												<a rel="me" target="_blank" href="https://mastodon.social/@jermdavis">
													Mastodon
												</a>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</section>
					</div>
				</div>
			</div>
		</div>
		<footer class="footerContainer">
			<div class="copyright">
				<div>©
					<a target="_blank" rel="noopener" href="https://jermdavis.dev/">Jeremy Davis</a>
					2014-2025</div>
			</div>
			<div class="statiq">
				<a href="/tools">Published using Statiq</a>
				<br>
			</div>
			<ul class="feeds">
				<li>
					<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
					</svg>
				</li>
				<li>
					<a target="_blank" href="/feed.rss">RSS</a>
				</li>
				<li>
					<a target="_blank" href="/feed.atom">Atom</a>
				</li>
			</ul>
		</footer>
		<div x-cloak="" class="cookieContainer" x-data="{ hide_banner: true }" x-init="hide_banner = docCookies.hasItem('hide_banner');" x-bind:class="{ 'hidden': hide_banner, 'fixed': !hide_banner }">
			<div class="panel">
				<div class="link">
					<a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cookie-usage" rel="noreferrer" target="_blank">This website uses Google Analytics, and its cookies.</a>
				</div>
				<button type="button" @click="hide_banner = true; docCookies.setItem('hide_banner', true, 'Fri, 31 Dec 9999 23:59:59 GMT', null, null, null, 'strict');" class="btn" aria-label="Dismiss">
					Understood
				</button>
			</div>
		</div>
		<script src="/vendor/Alpine/alpine.3.13.3.min.js" defer=""></script>
		<script src="/vendor/Enlighter/enlighterjs.min.js"></script>
		<script type="text/javascript">
            EnlighterJS.init('pre.code', 'code', {
            theme: 'droide',
            indent : 4,
            linehover : false,
            textOverflow: 'scroll',
            toolbarTop: '',
            toolbarBottom: ''
        });
        
		</script>
		<script defer="" src="/vendor/rp/rpbar-1.0.js"></script>
		<script defer="" src="/js/post.js"></script>
		<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JQ44ZR47YX"></script>
		<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-JQ44ZR47YX');
    
		</script>
	</body>
</html>