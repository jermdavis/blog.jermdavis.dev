<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' www.youtube.com *.twitter.com unpkg.com www.googletagmanager.com *.google-analytics.com *.twimg.com; img-src 'self' data: *;style-src 'self' 'unsafe-inline' *.twitter.com *.twimg.com">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="canonical" href="https://blog.jermdavis.dev/posts/2014/multilist-fields-with-source-queries-in-parameter-templates">
		<meta name="description" content="I've talked previously about how you can improve your content editors' understanding of where things live inside your Sitecore content tree by making use of relative queries to specify where the editing UI finds things. You can do it <a href=&quot;/posts/2014/next-step-relative-data-sources&quot; target=&quot;_blank&quot;>Data Sources</a>.
Logically, you'd assume that if a relative query works for a Multilist field in a normal template, it should work in a Parameter Template too? Well, if you set up something like this:">
		<meta property="og:description" content="I've talked previously about how you can improve your content editors' understanding of where things live inside your Sitecore content tree by making use of relative queries to specify where the editing UI finds things. You can do it <a href=&quot;/posts/2014/next-step-relative-data-sources&quot; target=&quot;_blank&quot;>Data Sources</a>.
Logically, you'd assume that if a relative query works for a Multilist field in a normal template, it should work in a Parameter Template too? Well, if you set up something like this:">
		<meta name="keywords" content="C#, Sitecore, UI">
		<meta name="author" content="Jeremy Davis">
		<meta name="copyright" content="Jeremy Davis">
		<title>Jeremy Davis - Multilist fields with source queries in Parameter&nbsp;Templates</title>
		<meta name="robots" content="index, follow">
		<link type="application/rss+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.rss">
		<link type="application/atom+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.atom">
		<meta name="application-name" content="Jeremy Davis">
		<meta name="msapplication-tooltip" content="Jeremy Davis">
		<meta name="msapplication-starturl" content="/">
		<link rel="manifest" href="/manifest.webmanifest">
		<meta property="og:title" content="Jeremy Davis - Multilist fields with source queries in Parameter&amp;#xA0;Templates">
		<meta property="og:publish_date" content="2014-07-14T00:00:00+00:00">
		<meta property="og:modified_date" content="2016-08-25T00:00:00+00:00">
		<meta property="og:image" content="https://blog.jermdavis.dev/img/featured/multilist-fields-with-source-queries-in-parameter-templates-social.jpg?">
		<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": "Multilist fields with source queries in Parameter&#xA0;Templates",
        "image": [
            "https://blog.jermdavis.dev/img/featured/multilist-fields-with-source-queries-in-parameter-templates-social.jpg"
        ],
        "datePublished": "2014-07-14T00:00:00+00:00",
        "dateModified": "2016-08-25T00:00:00+00:00",
        "author": [{
            "@type": "Person",
            "name": "Jeremy Davis",
            "url": "https://jermdavis.dev/"
        }]
    }
    
		</script>
		<meta property="og:url" content="https://blog.jermdavis.dev/posts/2014/multilist-fields-with-source-queries-in-parameter-templates">
		<meta property="og:type" content="website">
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">
		<link href="/scss/tailwind.css" rel="stylesheet">
		<link href="/vendor/Enlighter/enlighterjs.min.css" rel="stylesheet">
		<link href="/scss/site-theme.css" rel="stylesheet">
		<script src="/vendor/Cookies/cookies.min.js" defer=""></script>
	</head>
	<body class="max-w-7xl mx-auto text-black">
		<div class="relative bg-white" x-data="{ open: false }">
			
			<!-- desktop -->
			<div class="px-4 lg:px-6 bg-gray-100">
				<div class="bannerContainer flex justify-between items-center border-b-2 border-gray-100 py-6 lg:justify-start lg:space-x-10">
					<div class="flex justify-start lg:w-0 flex-1">
						<a href="/">
							<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
						</a>
						<div class="mx-2">
							<div class="text-3xl">Jeremy Davis</div>
							<div class="text-lg">Sitecore, C# and web development</div>
						</div>
					</div>
					<div class="nav -mr-2 -my-2 lg:hidden">
						<button @click="open = true" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-expanded="false">
							<span class="sr-only">Open menu</span>
							
							<!-- Heroicon name: outline/menu -->
							<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
							</svg>
						</button>
					</div>
					<nav class="nav hidden lg:flex space-x-10">
						<a class="text-base font-medium" href="/posts">Posts</a>
						<a class="text-base font-medium" href="/tags">Tags</a>
						<a class="text-base font-medium" href="/about">About</a>
						<a class="text-base font-medium" href="/links">Useful Links</a>
						<a class="text-base font-medium" href="/mvp">MVP</a>
					</nav>
				</div>
			</div>
			
			<!--Mobile menu, show/hide based on mobile menu state.-->
			<div class="absolute top-0 inset-x-0 p-2 transition transform origin-top-right lg:hidden z-50">
				<div class="rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 bg-white divide-y-2 divide-gray-50" x-show="open" x-transition="">
					<div class="pt-5 pb-6 px-5">
						<div class="flex items-center justify-between">
							<div class="flex">
								<a href="/">
									<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
								</a>
								<div class="mx-2">
									<div class="text-2xl">Jeremy Davis</div>
									<div class="text-base">Sitecore, C# and web development</div>
								</div>
							</div>
							<div class="nav -mr-2">
								<button @click="open = false" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
									<span class="sr-only">Close menu</span>
									
									<!-- Heroicon name: outline/x -->
									<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
									</svg>
								</button>
							</div>
						</div>
					</div>
					<div class="nav py-6 px-5 pt-0">
						<nav class=" gap-x-8">
							<a class="block mt-5 text-base font-medium" href="/posts">Posts</a>
							<a class="block mt-5 text-base font-medium" href="/tags">Tags</a>
							<a class="block mt-5 text-base font-medium" href="/about">About</a>
							<a class="block mt-5 text-base font-medium" href="/links">Useful Links</a>
							<a class="block mt-5 text-base font-medium" href="/mvp">MVP</a>
						</nav>
					</div>
				</div>
			</div>
		</div>
		<header class="bg-gray-300 px-4 py-1 lg:px-6 text-center" style="">
			<div class="post-heading">
				<div class="url p-1 bg-gray-100 rounded-md">Article printed from:
					<tt>https://blog.jermdavis.dev/posts/2014/multilist-fields-with-source-queries-in-parameter-templates</tt>
				</div>
				<h1 class="text-5xl mb-4 pb-1">
					Multilist fields with source queries in Parameter&nbsp;Templates
				</h1>
				<div class="meta">Published 14 July 2014</div>
				<div class="meta">Updated 25 August 2016</div>
				<div class="flex py-1">
					<a href="/tags/c/" class="p-1 mr-1 bg-gray-100 rounded-md">
						C#</a>
					<a href="/tags/sitecore/" class="p-1 mr-1 bg-gray-100 rounded-md">
						Sitecore</a>
					<a href="/tags/ui/" class="p-1 mr-1 bg-gray-100 rounded-md">
						UI</a>
				</div>
			</div>
		</header>
		<div class="py-2 lg:pl-3">
			<div class="lg:flex">
				<div class="lg:flex-auto mx-3 lg:min-w-0 content">
					<p>I've talked previously about how you can improve your content editors' understanding of where things live inside your Sitecore content tree by making use of relative queries to specify where the editing UI finds things. You can do it
						<a href="/posts/2014/next-step-relative-data-sources" target="_blank">Data Sources</a>.</p>
					<p>Logically, you'd assume that if a relative query works for a Multilist field in a normal template, it should work in a Parameter Template too? Well, if you set up something like this:
						<!--more-->
					</p>
					<p>
						<a href="/img/2014/2014-06-schema.png" target="_blank">
							<img alt="Schema" src="/img/2014/2014-06-schema.png">
						</a>
					</p>
					<p>Then you'll find your query returns no items when it is used to display the properties of your component:</p>
					<p>
						<a href="/img/2014/2014-06-empty.png" target="_blank">
							<img alt="Empty" src="/img/2014/2014-06-empty.png">
						</a>
					</p>
					<p>What's going on here then? Should it not be showing the items "A" and "B" here, because they're the children of the current content item...</p>
					<p>A colleague of mine hit this issue on a project recently, tried a solution and suggested I write it up. (So hat tip to
						<a href="https://twitter.com/Dr_Zoidberg78" target="_blank" rel="noopener noreferrer">Joe Dearsley</a>
						for the inspiration for this post) He pointed out the key issue to me: That if your query is part of a Parameter Template, then when it runs the context item is not the content item that this dynamic binding is part of – it's the Parameter Template's Standard Values item instead. Hence you don't get back the results you expected from your query.</p>
					<p>But never fear, it's not difficult to fix, if you find yourself with this issue.</p>
					<p>When Sitecore is processing the Source property of your fields, it runs a pipeline to sort out any queries or processing necessary before acting on the data. This deals with the process of transforming your
						<code>query:./*</code>
						into a set of items to be displayed. So we can amend the pipeline and insert a bit of code to resolve this situation for us.</p>
					<p>Poking around with Reflector, you can discover that the
						<code>getLookupSourceItems</code>
						pipeline contains two steps by default. And one of them already deals with translating a query into the correct set of items. All that's wrong is that in this case it's using the wrong context item. So lets insert a new pipeline processor to resolve this. The config is as follows:</p>
					<pre class="code" data-enlighter-language="xml" style="width:100%; overflow:scroll;">&lt;configuration xmlns:patch="http://www.sitecore.net/xmlconfig/"&gt;
  &lt;sitecore&gt;
    &lt;pipelines&gt;

      &lt;getLookupSourceItems&gt;
        &lt;processor patch:before="*[@type='Sitecore.Pipelines.GetLookupSourceItems.ProcessQuerySource, Sitecore.Kernel']"
            type="Testing.ParameterTemplateSourceQueries, Testing" /&gt;
      &lt;/getLookupSourceItems&gt;
      
    &lt;/pipelines&gt;
  &lt;/sitecore&gt;
&lt;/configuration&gt;

					</pre>
					<p>The code for a quick fix is also pretty simple:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public class ParameterTemplateSourceQueries
{
    private ID BaseParameterTemplate = new ID("{8CA06D6A-B353-44E8-BC31-B528C7306971}");

    public void Process(GetLookupSourceItemsArgs args)
    {
        if (!args.Source.StartsWith("query:"))
        {
            return;
        }

        if (!args.Item.Template.BaseTemplates.Where(bt =&gt; bt.ID == BaseParameterTemplate).Any())
        {
            return;
        }

        string url = WebUtil.GetQueryString();
        if (string.IsNullOrWhiteSpace(url))
        {
            return;
        }

        FieldEditorParameters parameters = FieldEditorOptions.Parse(new UrlString(url)).Parameters;

        var currentItemId = parameters["contentitem"];
        if (string.IsNullOrEmpty(currentItemId))
        {
            return;
        }

        Sitecore.Data.ItemUri contentItemUri = new Sitecore.Data.ItemUri(currentItemId);
        Item contextItem = Sitecore.Data.Database.GetItem(contentItemUri);

        args.Item = contextItem;
    }
}

					</pre>
					<p>The arguments passed in describe the field being processed. If the Source property doesn't start with the phrase "query:" then we don't need to process the data, and can let the pipeline continue. (In the real world, this code should probably also handle fast queries too though)</p>
					<p>Next we need to check if we're being called for the right reasons. We only want this code to run if the current context item is based on the "Standard Rendering Parameters" template. So we check the base templates of the item to ensure that at least one of them matches this. If not, we can stop.</p>
					<p>Now we can assume that the user is looking at the "Control Properties" dialog, and we can grab the querystring data for the web request that displayed the dialog. This should contain some useful data we need. So if it's empty, again we can stop processing.</p>
					<p>The querystring can then be parsed into a
						<code>FieldEditorParameters</code>
						object. Amongst other things, this can give us the full Sitecore ID of the context content item. So we grab that and check it's not empty for some reason, and if not, parse it and load it.</p>
					<p>And that item is the thing we want to be our real context item – so we assign it to the pipeline arguments'
						<code>Item</code>
						property, and let the pipeline carry on and deal with the query expansion.</p>
					<p>So with that in place, if we repeat our previous test we see:</p>
					<p>
						<a href="/img/2014/2014-06-full.png" target="_blank">
							<img alt="Now it works..." src="/img/2014/2014-06-full.png">
						</a>
					</p>
					<p>Which is the correct answer. Bingo.</p>
				</div>
				<div class="sidebar lg:flex-none lg:w-64 m-0 mt-1 lg:mt-0 lg:p-1 lg:bg-gray-100">
					<section class="mvp">
						<h3 class="bg-gray-300 p-2">Sitecore MVP 2015-2023</h3>
						<div class="bg-white mb-2 p-2">
							<a href="/mvp">
								<img class="lg:mx-auto" src="/img/mvp/2023.png" width="219" height="219" alt="2023 MVP Badge">
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Top Tags</h3>
						<div class="bg-white p-2 flex flex-wrap">
							<a href="/tags/sitecore/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Sitecore (214)</a>
							<a href="/tags/c/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								C# (51)</a>
							<a href="/tags/powershell/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								PowerShell (31)</a>
							<a href="/tags/installation/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Installation (23)</a>
							<a href="/tags/solr/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Solr (19)</a>
							<a href="/tags/docker/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Docker (16)</a>
							<a href="/tags/general/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								General (15)</a>
							<a href="/tags/ui/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								UI (15)</a>
							<a href="/tags/containers/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Containers (12)</a>
							<a href="/tags/bug/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Bug (12)</a>
						</div>
						<div class="bg-white mb-2 p-2">
							<a class="" href="/tags" role="button">All Tags
								<i class="fas fa-angle-double-right"></i>
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Recent Months</h3>
						<div class="bg-white p-2">
							<div>
								<a class="text-lg" href="/posts/2023-04">2023 - April</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2023-03">2023 - March</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2023-02">2023 - February</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2023-01">2023 - January</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2022-12">2022 - December</a>
							</div>
						</div>
						<div class="bg-white mb-2 p-2">
							<a class="" href="/posts" role="button">All Posts
								<i class="fas fa-angle-double-right"></i>
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Socials</h3>
						<div class="bg-white mb-2 p-2">
							<div>
								<a rel="me" target="_blank" href="https://mastodon.social/@jermdavis">Mastodon</a>
							</div>
							<div>
								<a rel="me" target="_blank" href="https://www.linkedin.com/in/djdavis/">LinkedIn</a>
							</div>
							<div>
								<a rel="me" target="_blank" href="https://twitter.com/jermdavis">Twitter</a>
							</div>
						</div>
					</section>
				</div>
			</div>
		</div>
		<footer class="lg:flex order-1 bg-gray-100 px-4 lg:px-6 py-4">
			<div class="flex-1 lg:flex-1 text-center lg:text-left">
				<div>©
					<a target="_blank" class="font-medium" rel="noopener" href="https://jermdavis.dev/">Jeremy Davis</a>
					2014-2023</div>
			</div>
			<div class="lg:flex-1 lg:order-3 text-center lg:text-right">
				<a class="font-medium" href="/tools">Published using Statiq</a>
				<br>
			</div>
			<ul class="list-none lg:flex-1 lg:order-2 p-0 text-center lg:align-middle" style="margin:0px !important">
				<li class="inline-block">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
					</svg>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium" target="_blank" href="/feed.rss">RSS</a>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium" target="_blank" href="/feed.atom">Atom</a>
				</li>
			</ul>
		</footer>
		<div class="min-h-screen bg-gray-300 py-6 flex flex-col justify-center sm:py-12" x-data="{ hide_banner: true }" x-init="hide_banner = docCookies.hasItem('hide_banner');" x-bind:class="{ 'hidden': hide_banner, 'fixed': !hide_banner }">
			<div class="border-2 border-gray-600 bg-gray-100 max-w-screen-lg mx-auto fixed bg-white inset-x-5 p-5 bottom-10 rounded-lg drop-shadow-2xl flex gap-4 flex-wrap md:flex-nowrap text-center md:text-left items-center justify-center md:justify-between">
				<div class="w-full text-lg">
					<a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cookie-usage" rel="noreferrer" target="_blank">This website uses Google Analytics, and its cookies.</a>
				</div>
				<button type="button" @click="hide_banner = true; docCookies.setItem('hide_banner', true, 'Fri, 31 Dec 9999 23:59:59 GMT', null, null, null, 'strict');" class="bg-gray-400 px-5 py-2 text-white rounded-md hover:bg-gray-600 focus:outline-none" aria-label="Dismiss">Understood</button>
			</div>
		</div>
		<script src="/vendor/Alpine/alpine.3.7.1.min.js" defer=""></script>
		<script src="/vendor/Enlighter/enlighterjs.min.js"></script>
		<script type="text/javascript">
            EnlighterJS.init('pre.code', 'code', {
            theme: 'droide',
            indent : 4,
            linehover : false,
            textOverflow: 'scroll',
            toolbarTop: '',
            toolbarBottom: ''
        });
        
		</script>
		<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JQ44ZR47YX"></script>
		<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-JQ44ZR47YX');
    
		</script>
	</body>
</html>