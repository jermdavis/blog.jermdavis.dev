<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' *.twitter.com unpkg.com www.googletagmanager.com www.google-analytics.com *.twimg.com; img-src 'self' data: *;style-src 'self' 'unsafe-inline' *.twitter.com *.twimg.com">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
        <link rel="canonical" href="https://blog.jermdavis.dev/posts/2019/bitten-by-alwayson-replication">
        <meta name="description" content="I am no DBA. In fact I&amp;#x27;m happy to admit that I know just enough SQL to be dangerous. So when database problems come up, they can be tricky. I recently helped a client work through an issue with analytics databases, which wasn&amp;#x27;t easy to google &amp;#x2013; so it&amp;#x27;s time to help future developers find it...">
        <meta property="og:description" content="I am no DBA. In fact I&amp;#x27;m happy to admit that I know just enough SQL to be dangerous. So when database problems come up, they can be tricky. I recently helped a client work through an issue with analytics databases, which wasn&amp;#x27;t easy to google &amp;#x2013; so it&amp;#x27;s time to help future developers find it...">
            <meta name="keywords" content="Sitecore, SQL Server">
        <meta name="author" content="Jeremy Davis">
        <meta name="copyright" content="Jeremy Davis">

    <title>Jeremy Davis - Bitten by AlwaysOn&#xA0;replication</title> 

        <meta name="robots" content="index, follow">

            <link type="application/rss+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.rss">
            <link type="application/atom+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.atom">

    <meta name="application-name" content="Jeremy Davis">
    <meta name="msapplication-tooltip" content="Jeremy Davis">
    <meta name="msapplication-starturl" content="/">
    <link rel="manifest" href="/manifest.webmanifest">

    
    <meta property="og:title" content="Jeremy Davis - Bitten by AlwaysOn&amp;#xA0;replication">
        <meta property="og:image" content="https://blog.jermdavis.dev/img/featured/bitten-by-alwayson-replication-social.jpg">
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": "Bitten by AlwaysOn&#xA0;replication",
        "image": [
            "https://blog.jermdavis.dev/img/featured/bitten-by-alwayson-replication-social.jpg"
        ],
        "datePublished": "2019-12-23T00:00:00+00:00",
        "author": [{
            "@type": "Person",
            "name": "Jeremy Davis",
            "url": "https://jermdavis.dev/"
        }]
    }
    </script>
<meta property="og:url" content="https://blog.jermdavis.dev/posts/2019/bitten-by-alwayson-replication">
<meta property="og:type" content="website">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">

    <link href="/scss/tailwind.css" rel="stylesheet">

    <link href="/vendor/Enlighter/enlighterjs.min.css" rel="stylesheet">
    <link href="/scss/site-theme.css" rel="stylesheet">


    <script src="/vendor/Cookies/cookies.min.js" defer=""></script>

    

    
    <!-- 18/07/2022 07:56:21 -->
</head>

<body class="max-w-7xl mx-auto">
    <div class="relative bg-white" x-data="{ open: false }">

    <!-- desktop -->
    <div class="px-4 lg:px-6 bg-gray-100">
        <div class="flex justify-between items-center border-b-2 border-gray-100 py-6 lg:justify-start lg:space-x-10">

            <div class="flex justify-start lg:w-0 flex-1">
                <a href="/">
                    <img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
                </a>
                <div class="mx-2">
                    <div class="text-3xl">Jeremy Davis</div>
                    <div class="text-lg">Sitecore, C# and web development</div>
                </div>
            </div>

            <div class="nav -mr-2 -my-2 lg:hidden">
                <button @click="open = true" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-expanded="false">
                    <span class="sr-only">Open menu</span>
                    <!-- Heroicon name: outline/menu -->
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>

            <nav class="nav hidden lg:flex space-x-10">
<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/posts">Posts</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/tags">Tags</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/about">About</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/links">Useful Links</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/mvp">MVP</a>            </nav>

        </div>
    </div>

    <!--Mobile menu, show/hide based on mobile menu state.-->
    <div class="absolute top-0 inset-x-0 p-2 transition transform origin-top-right lg:hidden z-50">

        <div class="rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 bg-white divide-y-2 divide-gray-50" x-show="open" x-transition="">
            <div class="pt-5 pb-6 px-5">
                <div class="flex items-center justify-between">
                    <div class="flex">
                        <a href="/">
                            <img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
                        </a>
                        <div class="mx-2">
                            <div class="text-2xl">Jeremy Davis</div>
                            <div class="text-base">Sitecore, C# and web development</div>
                        </div>
                    </div>

                    <div class="nav -mr-2">
                        <button @click="open = false" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
                            <span class="sr-only">Close menu</span>
                            <!-- Heroicon name: outline/x -->
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="nav py-6 px-5 pt-0">
                <nav class=" gap-x-8">
<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/posts">Posts</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/tags">Tags</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/about">About</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/links">Useful Links</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/mvp">MVP</a>                </nav>
            </div>

        </div>
    </div>
</div>

    <header class="bg-gray-300 px-4 py-1 lg:px-6 text-center" style="background-image: url(&amp;quot;/&amp;quot;);">
    <div class="post-heading">
        <div class="url p-1 bg-gray-100 rounded-md">Article printed from: <tt>https://blog.jermdavis.dev/posts/2019/bitten-by-alwayson-replication</tt></div>
        <h1 class="text-5xl mb-4 pb-1">
        Bitten by AlwaysOn replication
        </h1>
            <div class="meta">Published 23 December 2019</div>
            <div class="flex py-1">
                    <a href="/tags/sitecore/" class="p-1 mr-1 bg-gray-100 rounded-md"> Sitecore</a>
                    <a href="/tags/sql-server/" class="p-1 mr-1 bg-gray-100 rounded-md"> SQL Server</a>
            </div>
    </div>
</header>

    <div class="py-2 lg:pl-3">
        <div class="lg:flex">
            <div class="lg:flex-auto mx-3 lg:min-w-0 content">
                <p>I am no DBA. In fact I'm happy to admit that I know just enough SQL to be dangerous. So when database problems come up, they can be tricky. I recently helped a client work through an issue with analytics databases, which wasn't easy to google – so it's time to help future developers find it...<!--more--></p>
<h2>The issue</h2>
<p>A while back I'd been invoved in rolling out some infrastructure for a Sitecore v9.1 instance. At the point the deployment was done the AlwaysOn configuration for SQL Server wasn't in place – but it was going to be fitted in afterwards. Initially, everything was working ok – but after the client did work to get the AlwaysOn configuration enabled, issues started to occur. Lots of stuff to do with Analytics stopped working. Working through the issues, the key one was that analytics data stopped being recorded, because the xConnect collection role started recording errors:</p>
<pre><code class="language-text">2019-11-25 03:07:05.630 +01:00 [Error] [&quot;XdbContextLoggingPlugin&quot;] XdbContext Batch Execution Exception
Sitecore.XConnect.Operations.DependencyFailedException: One or more dependencies failed ---&gt;
Sitecore.Xdb.Collection.Failures.DataProviderException: Store Error:
Cannot open database &quot;ClientSite_Xdb.Collection.ShardMapManager&quot; requested by the login.
The login failed.
</code></pre>
<p>The connectionstrings for this user appeared correct. You could log on to the servers via SQL Management Studio with the account, despite the error. But, oddly, on one of the two servers you could not browse the three databases for analytics that <code>collectionuser</code> is supposed to access. However when you looked at those databases, they did have <code>collectionuser</code> listed in their security details:</p>
<p><a href="/img/2019/2019-12-collectionuser.png" target="_blank"><img alt="collectionuser rights" src="/img/2019/2019-12-collectionuser.png"></a></p>
<p>Cue head scratching and googling...</p>
<h2>An explanation</h2>
<p>There were two parts to this issue. The first was understanding how AlwaysOn's configuration was synchronising things. It happily syncronises databases (and any contained users they have) but it was not synchronising server-level things, like the <code>collectionuser</code> account itself. The xConnect shard databases aren't accessed by contained user accounts, because Sitecore needs the same user for all three – hence <code>collectionuser</code> is a server-level account instead.</p>
<p>And the second thing was that internally, SQL Server seems to wire up server-level logins to the rights on databases using &quot;Security IDs&quot; (SIDs) rather than usernames.</p>
<p>So what had happened was this:</p>
<p>There had been an issue with the process of setting up AlwaysOn. To try and fix it, <code>collectionuser</code> account had been deleted and recreated on both of the AlwaysOn machines. The rights for it had been put back on the primary machine, and a synchronisation performed to push them over to the second machine.</p>
<p>But under the surface there were now actually two different <code>collectionuser</code> accounts. On server #1 we had <code>collectionuser</code> with SID #1″ and on sever #2 we had <code>collectionuser</code> with SID #2″.</p>
<p>When you look at that via SQL Management Studio, initially everything looks ok. For your collection shard databases on both machines you see they have <code>collectionuser</code> attached, with apparently sensible rights. When you look at the server-level login, on the primary machine you see a user who has rights to the shard databases. But on the secondary you see a user who has no rights to anything - because of that difference in SIDs hiding under the surface.</p>
<h2>The resolution</h2>
<p>The trick to making this work is that you need to have both of your machines have a user with the same SID. A pile of googling lead to a blog post <a href="https://blog.sqlauthority.com/2015/04/18/sql-server-create-login-with-sid-way-to-synchronize-logins-on-secondary-server/" rel="noopener" target="_blank">which describes how you should approach to that</a>: You can create a user with a known SID, using:</p>
<pre><code class="language-sql">CREATE LOGIN collectionuser WITH
password = 'password&#64;123', SID = 0x59B662112A43D24585BFE2BF80D9BE19
</code></pre>
<p>So you can either make up your own SID and create the user on both machines using it, or you can create it normally on one machine, and then read the SID it used back via:</p>
<pre><code class="language-sql">SELECT name, sid FROM sys.sysusers WHERE name = 'collectionuser'
</code></pre>
<p>and use that value.</p>
<p>And once both machines have the same SID for the user, the &quot;can't log in&quot; error will stop happening.</p>


            </div>
            <div class="sidebar lg:flex-none lg:w-72 m-0 mt-1 lg:mt-0 lg:p-1 lg:bg-gray-100">
                <section class="mvp">
    <h3 class="bg-gray-300 p-2">Sitecore MVP 2015-2022</h3>
    <div class="bg-white mb-2 p-2"><a href="/mvp"><img src="/img/mvp/2022.jpg" width="219" height="219" alt="2022 MVP Badge"></a></div>
</section>

<section>
    <h3 class="bg-gray-300 p-2">Top Tags</h3>
    <div class="bg-white p-2 flex flex-wrap">
                    <a href="/tags/sitecore/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Sitecore (203)</a>
                    <a href="/tags/c/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> C# (47)</a>
                    <a href="/tags/powershell/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> PowerShell (31)</a>
                    <a href="/tags/installation/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Installation (23)</a>
                    <a href="/tags/solr/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Solr (15)</a>
                    <a href="/tags/general/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> General (14)</a>
                    <a href="/tags/ui/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> UI (14)</a>
                    <a href="/tags/docker/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Docker (12)</a>
                    <a href="/tags/coveo/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Coveo (12)</a>
                    <a href="/tags/packages/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Packages (11)</a>
    </div>
    <div class="bg-white mb-2 p-2">
        <a class="" href="/tags" role="button">All Tags <i class="fas fa-angle-double-right"></i></a>
    </div>
</section>

<section>
    <h3 class="bg-gray-300 p-2">Recent Months</h3>
    <div class="bg-white p-2">
                <div><a class="text-lg" href="/posts/2022-07">2022 - July</a></div>
                <div><a class="text-lg" href="/posts/2022-06">2022 - June</a></div>
                <div><a class="text-lg" href="/posts/2022-05">2022 - May</a></div>
                <div><a class="text-lg" href="/posts/2022-04">2022 - April</a></div>
                <div><a class="text-lg" href="/posts/2022-03">2022 - March</a></div>
    </div>
    <div class="bg-white mb-2 p-2">
        <a class="" href="/posts" role="button">All Posts <i class="fas fa-angle-double-right"></i></a>
    </div>
</section>

<section>
    <h3 class="bg-gray-300 p-2">Twitter</h3>
    <div class="bg-white mb-2 p-2">
        <a class="twitter-timeline" data-height="400" data-chrome="noheader nofooter noborders" href="https://twitter.com/jermdavis">Tweets by JermDavis</a>
        <script async="" defer="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    </div>
</section>
            </div>
        </div>
    </div>

    <footer class="lg:flex order-1 bg-gray-100 px-4 lg:px-6 py-4">
    <div class="flex-1 lg:flex-1 text-center lg:text-left">
        <div>&copy; <a target="_blank" class="font-medium text-gray-500 hover:text-gray-900" rel="noopener" href="https://jermdavis.dev/">Jeremy Davis</a> 2014-2022</div>
    </div>

    <div class="lg:flex-1 lg:order-3 text-center lg:text-right">
        <a class="font-medium text-gray-500 hover:text-gray-900" href="/tools">Published using Statiq</a><br>
    </div>

    <ul class="list-none lg:flex-1 lg:order-2 p-0 text-center lg:align-middle" style="margin:0px !important">
        <li class="inline-block">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
            </svg>
        </li>
            <li class="inline-block ml-4">
                <a class="font-medium text-gray-500 hover:text-gray-900" target="_blank" href="/feed.rss">RSS</a>
            </li>
            <li class="inline-block ml-4">
                <a class="font-medium text-gray-500 hover:text-gray-900" target="_blank" href="/feed.atom">Atom</a>
            </li>
    </ul>
</footer>

    <div class="min-h-screen bg-gray-300 py-6 flex flex-col justify-center sm:py-12" x-data="{ hide_banner: true }" x-init="hide_banner = docCookies.hasItem('hide_banner');" x-bind:class="{ 'hidden': hide_banner, 'fixed': !hide_banner }">
        <div class="border-2 border-gray-600 bg-gray-100 max-w-screen-lg mx-auto fixed bg-white inset-x-5 p-5 bottom-10 rounded-lg drop-shadow-2xl flex gap-4 flex-wrap md:flex-nowrap text-center md:text-left items-center justify-center md:justify-between">
            <div class="w-full text-lg">
                <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cookie-usage" rel="noreferrer" target="_blank">This website uses Google Analytics, and its cookies.</a>
            </div>
            <button type="button" @click="hide_banner = true; docCookies.setItem('hide_banner', true, 'Fri, 31 Dec 9999 23:59:59 GMT', null, null, null, 'strict');" class="bg-gray-400 px-5 py-2 text-white rounded-md hover:bg-gray-600 focus:outline-none" aria-label="Dismiss">Understood</button>
        </div>
    </div>
    
    <script src="/vendor/Alpine/alpine.3.7.1.min.js" defer=""></script>
    <script src="/vendor/Enlighter/enlighterjs.min.js"></script>

    <script type="text/javascript">
        EnlighterJS.init('pre', 'code', {
            theme: 'droide',
            indent : 4,
            linehover : false,
            textOverflow: 'scroll',
            toolbarTop: '',
            toolbarBottom: ''
        });
    </script>

    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JQ44ZR47YX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-JQ44ZR47YX');
    </script>

    

    



</body></html>