<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' unpkg.com www.googletagmanager.com *.google-analytics.com; img-src 'self' data: *;style-src 'self' 'unsafe-inline'">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="canonical" href="https://blog.jermdavis.dev/posts/2016/graphing-activity-with-a-raspberry-pi">
		<meta name="description" content="I've had a Raspberry Pi sitting under my desk for some time now, but things keep getting in the way of me doing much with it. But in honour of the whole &quot;<a href=&quot;http://www.marchisformakers.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;>March is for Makers</a>&quot; thing, I decided I needed to finally do something more than boot it up and let my son tinker with <a href=&quot;https://scratch.mit.edu/&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;>Scratch</a> on it. I'd also acquired a &quot;<a href=&quot;https://www.raspberrypi.org/products/sense-hat/&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;>Sense Hat</a>&quot; add-on recently, and something about the matrix display on that made me think of animated graphs. Now that the <a href=&quot;https://dev.windows.com/en-us/iot&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;>Windows 10 IoT build</a> is gaining features, I thought I'd try installing that and building something that would let me graph website activity – with a view to how it might get connected to Sitecore...">
		<meta property="og:description" content="I've had a Raspberry Pi sitting under my desk for some time now, but things keep getting in the way of me doing much with it. But in honour of the whole &quot;<a href=&quot;http://www.marchisformakers.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;>March is for Makers</a>&quot; thing, I decided I needed to finally do something more than boot it up and let my son tinker with <a href=&quot;https://scratch.mit.edu/&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;>Scratch</a> on it. I'd also acquired a &quot;<a href=&quot;https://www.raspberrypi.org/products/sense-hat/&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;>Sense Hat</a>&quot; add-on recently, and something about the matrix display on that made me think of animated graphs. Now that the <a href=&quot;https://dev.windows.com/en-us/iot&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;>Windows 10 IoT build</a> is gaining features, I thought I'd try installing that and building something that would let me graph website activity – with a view to how it might get connected to Sitecore...">
		<meta name="keywords" content="IoT, Hardware, Sitecore">
		<meta name="author" content="Jeremy Davis">
		<meta name="copyright" content="Jeremy Davis">
		<title>Jeremy Davis - Graphing activity with a Raspberry&nbsp;Pi</title>
		<meta name="robots" content="index, follow">
		<link type="application/rss+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.rss">
		<link type="application/atom+xml" rel="alternate" title="Jeremy Davis - Sitecore, C# and web development" href="/feed.atom">
		<meta name="application-name" content="Jeremy Davis">
		<meta name="msapplication-tooltip" content="Jeremy Davis">
		<meta name="msapplication-starturl" content="/">
		<link rel="manifest" href="/manifest.webmanifest">
		<meta property="og:type" content="article">
		<meta property="og:title" content="Graphing activity with a Raspberry&nbsp;Pi [by Jeremy Davis]">
		<meta property="og:publish_date" content="2016-03-21T00:00:00+0000">
		<meta property="article:published_time" content="2016-03-21T00:00:00+0000">
		<meta property="og:modified_date" content="2016-08-25T00:00:00+0000">
		<meta property="article:modified_time" content="2016-08-25T00:00:00+0000">
		<meta property="og:image" content="https://blog.jermdavis.dev/img/featured/graphing-activity-with-a-raspberry-pi-social.jpg">
		<meta property="og:image:alt" content="Logo image showing post title 'Graphing activity with a Raspberry&nbsp;Pi' and author 'Jeremy Davis'">
		<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "article",
        "headline": "Graphing activity with a Raspberry Pi",
        "url": "https://blog.jermdavis.dev/posts/2016/graphing-activity-with-a-raspberry-pi",
        "image": [
            {
                "@type": "ImageObject",
                "contentUrl": "https://blog.jermdavis.dev/img/featured/graphing-activity-with-a-raspberry-pi-social.jpg",
                "caption": "Logo image showing post title 'Graphing activity with a Raspberry Pi' and author 'Jeremy Davis'"
            }
        ],
        "datePublished": "2016-03-21T00:00:00+0000",
        "dateModified": "2016-08-25T00:00:00+0000",
        "author": [{
            "@type": "Person",
            "name": "Jeremy Davis",
            "url": "https://jermdavis.dev/"
        }]
    }
    
		</script>
		<meta property="og:url" content="https://blog.jermdavis.dev/posts/2016/graphing-activity-with-a-raspberry-pi">
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">
		<link href="/scss/tailwind.css" rel="stylesheet">
		<link href="/vendor/Enlighter/enlighterjs.min.css" rel="stylesheet">
		<link href="/scss/site-theme.css" rel="stylesheet">
		<script src="/vendor/Cookies/cookies.min.js" defer=""></script>
	</head>
	<body class="max-w-7xl mx-auto text-black" id="top">
		<div id="rp-bar"></div>
		<div class="relative bg-white" x-data="{ open: false }">
			
			<!-- desktop -->
			<div class="px-4 lg:px-6 bg-gray-100">
				<div class="bannerContainer flex justify-between items-center border-b-2 border-gray-100 py-6 lg:justify-start lg:space-x-10">
					<div class="flex justify-start lg:w-0 flex-1">
						<a href="/">
							<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
						</a>
						<div class="mx-2">
							<div class="text-3xl">Jeremy Davis</div>
							<div class="text-lg">Sitecore, C# and web development</div>
						</div>
					</div>
					<div class="nav -mr-2 -my-2 lg:hidden">
						<button @click="open = true" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-expanded="false">
							<span class="sr-only">Open menu</span>
							
							<!-- Heroicon name: outline/menu -->
							<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
							</svg>
						</button>
					</div>
					<nav class="nav hidden lg:flex space-x-10">
						<a class="text-base font-medium" href="/posts">Posts</a>
						<a class="text-base font-medium" href="/tags">Tags</a>
						<a class="text-base font-medium" href="/about">About</a>
						<a class="text-base font-medium" href="/links">Useful Links</a>
						<a class="text-base font-medium" href="/mvp">MVP</a>
						<a class="text-base font-medium" href="/search">Search</a>
					</nav>
				</div>
			</div>
			
			<!--Mobile menu, show/hide based on mobile menu state.-->
			<div class="absolute top-0 inset-x-0 p-2 transition transform origin-top-right lg:hidden z-50">
				<div style="display:none;" class="rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 bg-white divide-y-2 divide-gray-50" x-show="open" x-transition="">
					<div class="pt-5 pb-6 px-5">
						<div class="flex items-center justify-between">
							<div class="flex">
								<a href="/">
									<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
								</a>
								<div class="mx-2">
									<div class="text-2xl">Jeremy Davis</div>
									<div class="text-base">Sitecore, C# and web development</div>
								</div>
							</div>
							<div class="nav -mr-2">
								<button @click="open = false" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
									<span class="sr-only">Close menu</span>
									
									<!-- Heroicon name: outline/x -->
									<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
									</svg>
								</button>
							</div>
						</div>
					</div>
					<div class="nav py-6 px-5 pt-0">
						<nav class=" gap-x-8">
							<a class="block mt-5 text-base font-medium" href="/posts">Posts</a>
							<a class="block mt-5 text-base font-medium" href="/tags">Tags</a>
							<a class="block mt-5 text-base font-medium" href="/about">About</a>
							<a class="block mt-5 text-base font-medium" href="/links">Useful Links</a>
							<a class="block mt-5 text-base font-medium" href="/mvp">MVP</a>
							<a class="block mt-5 text-base font-medium" href="/search">Search</a>
						</nav>
					</div>
				</div>
			</div>
		</div>
		<header class="bg-gray-300 px-4 py-1 lg:px-6 text-center" style="">
			<div class="post-heading">
				<div class="url p-1 bg-gray-100 rounded-md">Article printed from:
					<tt>https://blog.jermdavis.dev/posts/2016/graphing-activity-with-a-raspberry-pi</tt>
				</div>
				<h1 class="text-5xl mb-4 pb-1">
					Graphing activity with a Raspberry&nbsp;Pi
				</h1>
				<div class="meta">Published 21 March 2016</div>
				<div class="meta">Updated 25 August 2016</div>
				<div class="flex py-1 flex-wrap">
					<a href="/tags/iot/" class="p-1 mr-1 mt-1 bg-gray-100 rounded-md whitespace-nowrap">
						IoT</a>
					<a href="/tags/hardware/" class="p-1 mr-1 mt-1 bg-gray-100 rounded-md whitespace-nowrap">
						Hardware</a>
					<a href="/tags/sitecore/" class="p-1 mr-1 mt-1 bg-gray-100 rounded-md whitespace-nowrap">
						Sitecore</a>
					<span class="p-1 mr-1 mt-1 bg-gray-100 rounded-md whitespace-nowrap">~8 min. read</span>
				</div>
			</div>
		</header>
		<div class="py-2 lg:pl-3">
			<div class="lg:flex">
				<div class="lg:flex-auto mx-3 lg:min-w-0 content">
					<p>I've had a Raspberry Pi sitting under my desk for some time now, but things keep getting in the way of me doing much with it. But in honour of the whole "<a href="http://www.marchisformakers.com/" target="_blank" rel="noopener noreferrer">March is for Makers</a>" thing, I decided I needed to finally do something more than boot it up and let my son tinker with
						<a href="https://scratch.mit.edu/" target="_blank" rel="noopener noreferrer">Scratch</a>
						on it. I'd also acquired a "<a href="https://www.raspberrypi.org/products/sense-hat/" target="_blank" rel="noopener noreferrer">Sense Hat</a>" add-on recently, and something about the matrix display on that made me think of animated graphs. Now that the
						<a href="https://dev.windows.com/en-us/iot" target="_blank" rel="noopener noreferrer">Windows 10 IoT build</a>
						is gaining features, I thought I'd try installing that and building something that would let me graph website activity – with a view to how it might get connected to Sitecore...
						<!--more-->
					</p>
					<h2 x-data="" class="anchor">What's the plan?<a x-on:click.prevent="copy($event.target)" href="#heading1" name="heading1">
							<img src="/img/link.png">
						</a>
						<span>url copied!</span>
					</h2>
					The idea I had was pretty simple: Incoming web requests to the Pi can indicate events, and some code can count them. Once a specified span of time has elapsed, the count can get plotted as a bar on a graph, and the code can start counting again for the next bar. That means we need:
					<ul>
						<li>A class that can track events over time and format the data in a way to let us draw a simple bar chart.</li>
						<li>A web server that will receive requests describing the events we're tracing, and pass them to the tracker.</li>
						<li>A way of drawing the tracking data on the Sense Hat's display.</li>
					</ul>
					<p>But the first step is to
						<a href="http://ms-iot.github.io/content/en-US/GetStarted.htm" target="_blank" rel="noopener noreferrer">follow Microsoft's instructions for installing Win10 on your Pi</a>, and then
						<a href="https://dev.windows.com/en-us/downloads" target="_blank" rel="noopener noreferrer">add the appropriate bits</a>
						to Visual Studio
						<a href="https://visualstudiogallery.msdn.microsoft.com/55b357e1-a533-43ad-82a5-a88ac4b01dec" target="_blank" rel="noopener noreferrer">for creating a new "headless" project</a>. Then, on to the code:</p>
					<h2 x-data="" class="anchor">Counting the events<a x-on:click.prevent="copy($event.target)" href="#heading2" name="heading2">
							<img src="/img/link.png">
						</a>
						<span>url copied!</span>
					</h2>
					To keep track of data for the graph we need an object that can count any incoming events over a span of time, and then keep a queue of previous counts. That history will form the data for the bar graph, and let it animate to show how time is changing the values. As we'll see later, incoming event messages are going to appear on one thread, and separately a timer will indicate when to update the graph. Because we don't know what threads will make these requests, we need to make sure that the code copes with multi-threaded access. That means we need something to base a lock on. We also need somewhere to keep track of the event count for the current span of time, as well as a queue to keep a set of historical values:
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public sealed class Tracker
{
    private object _lock = new object();
    private int _currentTick = 0;
    private int _historyCount;

    private Queue&lt;int&gt; _queue = new Queue&lt;int&gt;();

    public Tracker(int historyCount)
    {
        _historyCount = historyCount;

        for (int i = 0; i &lt; _historyCount; i++)
        {
            _queue.Enqueue(0);
        }
    }

    public IEnumerable&lt;int&gt; Tick()
    {
        lock (_lock)
        {
            _queue.Enqueue(_currentTick);
            _currentTick = 0;

            if (_queue.Count &gt;= _historyCount)
            {
                _queue.Dequeue();
            }

            return _queue.ToList();
        }
    }

    public void Track(int value)
    {
        lock (_lock)
        {
            _currentTick += value;
        }
    }
}

					</pre>
					<p>The
						<code>Track()</code>
						method adds the number of events specified to the current count. This operation is guarded by a lock to ensure that we don't try to update the current count while we're also trying to move that data into the queue.</p>
					<p>Calling the
						<code>Tick()</code>
						method does two things. Firstly it moves the current event count into the queue of event count history, and removes the oldest count. Secondly it returns the current state of the queue so that we can draw it on our graph.</p>
					<p>Note that this class is sealed in order to meet the requirements of exportable classes in Universal apps - the compiler requires them to be sealed.</p>
					<h2 x-data="" class="anchor">Receiving the events<a x-on:click.prevent="copy($event.target)" href="#heading3" name="heading3">
							<img src="/img/link.png">
						</a>
						<span>url copied!</span>
					</h2>
					Making a simple HTTP receiver requires us to create an HTTP listener and then raise events to the application, passing back appropriate data. There's some
					<a href="http://ms-iot.github.io/content/en-US/win10/samples/BlinkyWebServer.htm" target="_blank" rel="noopener noreferrer">example code provided by Microsoft</a>
					which can be adapted to meet the requirements here:
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public sealed class HttpReceiver
{
    private class RequestPayload
    {
        public string Origin { get; set; }
        public string Data { get; set; }
    }

    public event TypedEventHandler&lt;HttpReceiver, string&gt; DataReceived;

    private uint _bufferSize = 1024;
    private int _port;
    private StreamSocketListener _listener;

    public HttpReceiver(int port)
    {
        _port = port;

        _listener = new StreamSocketListener();
        _listener.Control.KeepAlive = true;
        _listener.Control.NoDelay = true;

        _listener.ConnectionReceived += async (s, e) =&gt; { await processRequestAsync(e.Socket); };
    }

    public void Start()
    {
        Task.Run(async () =&gt; {
            await _listener.BindServiceNameAsync(_port.ToString());
        });
    }

    private async Task processRequestAsync(StreamSocket socket)
    {
        string data = await readSocket(socket);
        RequestPayload payload = extractPayload(data);

        if (DataReceived != null)
        {
            DataReceived(this, payload.Data);
        }

        writeResponse("OK", payload.Origin, socket);
    }

    private RequestPayload extractPayload(string httpRequestData)
    {
        var lines = httpRequestData.Split(new[] { Environment.NewLine }, StringSplitOptions.RemoveEmptyEntries);

        var origin = lines.Where(o =&gt; o.Contains("Origin:")).Select(o =&gt; o.Substring(8)).FirstOrDefault();
        var result = lines.Last().Replace("\0","");

        return new RequestPayload() { Origin=origin, Data=result };
    }

    private async Task&lt;string&gt; readSocket(StreamSocket socket)
    {
        StringBuilder request = new StringBuilder();
        byte[] data = new byte[_bufferSize];
        IBuffer buffer = data.AsBuffer();
        uint dataRead = _bufferSize;
        using (IInputStream input = socket.InputStream)
        {
            while (dataRead == _bufferSize)
            {
                await input.ReadAsync(buffer, _bufferSize, InputStreamOptions.Partial);
                request.Append(Encoding.UTF8.GetString(data, 0, data.Length));
                dataRead = buffer.Length;
            }
        }

        return request.ToString();
    }

    private void writeResponse(string html, string origin, StreamSocket socket)
    {
        byte[] bodyArray = Encoding.UTF8.GetBytes(html);
            
        using (var outputStream = socket.OutputStream)
        {
            using (Stream response = outputStream.AsStreamForWrite())
            {
                using (MemoryStream stream = new MemoryStream(bodyArray))
                {
                    string header = String.Format(
                        "HTTP/1.1 200 OK\r\n" + 
                        "Access-Control-Allow-Origin: {0}\r\n" + 
                        "Content-Length: {1}\r\n" + 
                        "Connection: close\r\n" + 
                        "\r\n", 
                        origin, stream.Length);
                    byte[] headerArray = Encoding.UTF8.GetBytes(header);
                    response.Write(headerArray, 0, headerArray.Length);
                    stream.CopyTo(response);
                    response.Flush();
                }
            }
        }
    }
}

					</pre>
					<p>The class binds the specified port, and waits for requests. For each one that appears, it parses the data supplied to extract the a posted value and any origin data supplied. It then returns an "ok" message to indicate that data was accepted. The Origin header is necessary if you're going to use AJAX-style requests across domains to record events. Note that this code simply records the incoming origin and plays back the same origin when it returns its response. That will allow any other domain to make requests – you would probably want to tie this down to only accepting some origins if this code was ever exposed to the internet.</p>
					<p>It's also worth knowing that acting as an internet server is a feature that you have to tell the Windows runtime you require when writing IoT applications. The application's manifest data needs to include data specifing this. It can be set in the UI by double-clicking the project's manifest file and ensuring that the "Internet (Client &amp; Server)" option is checked:</p>
					<p>
						<a href="/img/2016/2016-03-manifest.png" target="_blank">
							<img alt="IoT Manifest" src="/img/2016/2016-03-manifest.png">
						</a>
					</p>
					<h2 x-data="" class="anchor">Drawing the graph<a x-on:click.prevent="copy($event.target)" href="#heading4" name="heading4">
							<img src="/img/link.png">
						</a>
						<span>url copied!</span>
					</h2>
					The next feature that we need is the ability to draw on the Sense Hat's display. It turns out this is much simpler than you might expect, as someone's already done the heavy lifting of accessing the Sense Hat's features via windows. The
					<a href="https://github.com/emmellsoft/RPi.SenseHat" target="_blank" rel="noopener noreferrer">"RPi.SenseHat" repository by Emmellsoft</a>
					provides all the features we need.
					<p>The whole device is wrapped up in an object you can obtain via an async call:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">var _hat = await SenseHatFactory.Singleton.GetSenseHat();

					</pre>
					<p>And we can draw on the screen by setting individual pixels to a specific colour:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">_hat.Display.Screen[4, 2] = Windows.UI.Colours.Red;

					</pre>
					<p>And then once all the updates are done, refresh the display:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">_hat.Display.Update();

					</pre>
					<p>The display is represented by an 8×8 array of
						<code>Colour</code>
						entries.<br>
						(The library does loads more than this - but this is all we need to get started)</p>
					<h2 x-data="" class="anchor">Pulling it all together<a x-on:click.prevent="copy($event.target)" href="#heading5" name="heading5">
							<img src="/img/link.png">
						</a>
						<span>url copied!</span>
					</h2>
					The entry-point class for our app needs to pull together the HTTP server, the event tracker and the display code. We're running asynchronous code here, so we need to make sure that the application doesn't accidentally end while it's waiting for these events – so we need to ensure we have a "Deferral" object to signal to the runtime that the app should keep running. Also, we're building a "headless" application here – one which does not require the traditional Windows UI. This is equivalent to the IoT equivalent of a Windows Service. So the main class of the application becomes:
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public sealed class StartupTask : IBackgroundTask
{
    private BackgroundTaskDeferral _deferral;
    private Tracker _tracker = new Tracker(8);
    private HttpReceiver _receiver;
    private ThreadPoolTimer _timer;
    private ISenseHat _hat;

    public void Run(IBackgroundTaskInstance taskInstance)
    {
        _hat = SenseHatFactory.Singleton.GetSenseHat().Result;

        _deferral = taskInstance.GetDeferral();

        _receiver = new HttpReceiver(1234);
        _receiver.DataReceived += webMessage;
        _receiver.Start();

        _timer = ThreadPoolTimer.CreatePeriodicTimer(_timer_Tick, TimeSpan.FromSeconds(1));

        _hat.Display.Clear();
        _hat.Display.Update();
    }

    private void webMessage(HttpReceiver sender, string data)
    {
        int value = 1;
        if (!string.IsNullOrWhiteSpace(data))
        {
            int.TryParse(data, out value);
        }
        _tracker.Track(value);
    }

    // 
    // More below
    //
}

					</pre>
					<p>It (synchronously in this case) gets an instance of the Sense Hat wrapper, and makes sure we have the "deferral" object we need to prevent the application being terminated before we're done. It then binds the HTTP server to a port and sets up a handler for incoming requests. The
						<code>webMessage()</code>
						handler tries to parse a number of events to record out of the data from the request, and then records that value using the tracker object.</p>
					<p>Finally it creates a timer event which will cause the graph to be updated every second, before clearing the Sense Hat's display.</p>
					<p>Each time that timer calls its handler, it runs the code to update the graph:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">private void _timer_Tick(ThreadPoolTimer timer)
{
    var ints = _tracker.Tick()
        .Reverse()
        .Scale(8)
        .ToArray();

    for (int x = 0; x &lt; 8; x++)
    {
        for (int y = 0; y &lt; 8; y++)
        {
            Color c = colourFor(y, ints[x]);
            _hat.Display.Screen[y, x] = c;
        }
    }

    _hat.Display.Update();
}

private Color colourFor(int y, int value)
{
    if(y &lt; value -1)
    {
        return Colors.Green;
    }
    else if(y &lt; value)
    {
        return Colors.Red;
    }
    else
    {
        return Colors.Black;
    }
}

					</pre>
					<p>When the timer ticks, the code captures the data from the tracker object. It then reverses the order of the data, scales it to fit the 8 pixel high display, and returns an array. The code can then loop through each of the pixels on the display and set their colour based on the graph information. The helper function
						<code>colourFor()</code>
						returns the right colour for a pixel. The graph is drawn with green bars, topped with red.</p>
					<p>Dynamically scaling the graph to ensure that the largest value never exceeds 8 pixels high is achieved via an extension method:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public static class ScaleExtension
{
    public static IEnumerable&lt;int&gt; Scale(this IEnumerable&lt;int&gt; source, int max)
    {
        int sourceMax = source.Max();

        if(sourceMax &gt; max-1)
        {
            float scale = (float)max / (float)sourceMax;
            return source.Select(i =&gt; (int)Math.Ceiling(i * scale));
        }
        else
        {
            return source;
        }
    }
}

					</pre>
					<p>This simply returns a new enumerable where the values have been scaled appropriately.</p>
					<h2 x-data="" class="anchor">Testing this code...<a x-on:click.prevent="copy($event.target)" href="#heading6" name="heading6">
							<img src="/img/link.png">
						</a>
						<span>url copied!</span>
					</h2>
					In order to test the code running on the Pi we need a way to generate requests. A simple way to achieve that is with a bit of HTML and jQuery to fire AJAX requests:<br>
					(NB:  missed out for clarity)
					<pre class="code" data-enlighter-language="xml" style="width:100%; overflow:scroll;">&lt;body&gt;
    &lt;h1&gt;Event test page&lt;/h1&gt;
    &lt;fieldset class="config"&gt;
        &lt;legend&gt;Network config for your Raspberry Pi&lt;/legend&gt;
        &lt;div&gt;
            &lt;label for="ip"&gt;IP Address: &lt;/label&gt;
            &lt;input type="text" id="ip" value="169.254.98.224" /&gt;
        &lt;/div&gt;
        &lt;div&gt;
            &lt;label for="port"&gt;Port: &lt;/label&gt;
            &lt;input type="text" id="port" value="1234" /&gt;
        &lt;/div&gt;
    &lt;/fieldset&gt;
    &lt;div class="cmd"&gt;
        &lt;a class="btn ck" href="#"&gt;Event&lt;/a&gt;
        &lt;span class="ck"&gt;...&lt;/span&gt;
    &lt;/div&gt;

    &lt;script type="text/javascript"&gt;
        $(document).ready(function () {
            $("a.ck").click(function () {
                var msgElement = $(this).parent().children("span.ck");
                jQuery.ajax({
                    url: getUrl(),
                    data: "1",
                    dataType: "text",
                    crossDomain : "true",
                    method: "POST",
                    timeout: 500
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    msgElement.text("Error: " + textStatus);
                }).success(function (data) {
                    msgElement.text("Success: " + data);
                });
            });
        });

        function getUrl() {
            var ip = $("#ip").val();
            var port = $("#port").val();
            return "http://" + ip + ":" + port + "/";
        }
    &lt;/script&gt;

&lt;/body&gt;

					</pre>
					<p>Each time the "Fire an event" link is clicked, an HTTP request is sent to the Pi, and the success or failure of the request is shown on screen. If we load that HTML file in a browser we get this:</p>
					<p>
						<a href="/img/2016/2016-03-testpage.png" target="_blank">
							<img alt="Test Page" src="/img/2016/2016-03-testpage.png">
						</a>
					</p>
					<p>If we fire up the code on the Pi and then click the "event" button a bit, we'll see something like this:</p>
					<p>
						<a href="/img/2016/2016-03-anim.gif" target="_blank">
							<img alt="Pi running" src="/img/2016/2016-03-anim.gif">
						</a>
					</p>
					<p>The graph animates nicely, and will re-scale itself dynamically to ensure that it always fits vertically into the 8 "pixels" of the display.</p>
					<p>(The complete code for this
						<a href="https://github.com/jermdavis/IoTActivityMonitor" target="_blank" rel="noopener noreferrer">is available on Github</a>
						if you want to try it)</p>
					<h2 x-data="" class="anchor">Wiring it up to a website<a x-on:click.prevent="copy($event.target)" href="#heading7" name="heading7">
							<img src="/img/link.png">
						</a>
						<span>url copied!</span>
					</h2>
					So how can we get an actual website to generate requests? Well the simplest approach would be to do something very similar to what's shown above for testing. If you add a bit of jQuery to each page in the same way you'd add analytics javascript, you can get each rendered page to send an event to the Pi.
					<p>That approach will also work in a Sitecore website – but there are other ways you could wire it up here too.</p>
					<p>It could also be wired up server-side by implementing a custom pipeline step or event handler. There's all sorts of stuff you could track via this route. Instead of tracking page requests via the
						<code>&lt;HttpRequestBegin&gt;</code>
						pipeline, you might want to track item saves on happening on your server via the
						<code>item:saved</code>
						event. At it's very simplest, that could could be some code like this:</p>
					<pre class="code" data-enlighter-language="csharp" style="width:100%; overflow:scroll;">public class TrackingEvents
{
    public void OnItemSaved(object sender, EventArgs args)
    {
        // fetch this from configuration
        var uri = "http://169.254.98.224:1234/";

        using (HttpClient client = new HttpClient())
        {
            await client.GetAsync(uri);
        }
    }
}

					</pre>
					<p>configured with a patch like:</p>
					<pre class="code" data-enlighter-language="xml" style="width:100%; overflow:scroll;">&lt;?xml version="1.0" encoding="utf-8" ?&gt;
&lt;configuration xmlns:patch="http://www.sitecore.net/xmlconfig/"&gt;
  &lt;sitecore&gt;
    &lt;events&gt;
      &lt;event name="item:saved"&gt; 
        &lt;handler type="BlogExample.TrackingEvents, BlogExample" method="OnItemSaved"/&gt; 
      &lt;/event&gt; 
    &lt;/events&gt;
  &lt;/sitecore&gt;
&lt;/configuration&gt;

					</pre>
					<p>With a little more effort, it would be sensible for the event code to pick up its target URL from configuration. For high load sites it might also be sensible to batch up requests on the server and pass the number in the batch, using a
						<code>Post</code>
						request as in the Javascript above.</p>
					<p>Sitecore has a vast number of different pipelines and events that you might track. With a bit more code it would be fairly easy to allow the Pi to track data for multiple different events here, and swap between displays for each of them using the Sense Hat's joystick.</p>
					<p>But who knows when I'll have some free evenings to give that a go...</p>
					<a class="gotop" href="#top">↑ Back to top</a>
				</div>
				<div class="sidebar lg:flex-none lg:w-64 m-0 mt-1 lg:mt-0 lg:p-1 lg:bg-gray-100">
					<div class="md:flex-row md:flex lg:flex-col md:flex-wrap lg:order-1">
						<section class="mb-2 md:basis-full md:shrink-0">
							<h3 class="bg-gray-300 p-2 md:border-r-2 md:border-white lg:border-r-0 whitespace-nowrap">Post Headings</h3>
							<div class="bg-white p-2 flex flex-wrap">
								<ol class="headings">
									<li>
										<a href="#heading1">What's the plan?</a>
									</li>
									<li>
										<a href="#heading2">Counting the events</a>
									</li>
									<li>
										<a href="#heading3">Receiving the events</a>
									</li>
									<li>
										<a href="#heading4">Drawing the graph</a>
									</li>
									<li>
										<a href="#heading5">Pulling it all together</a>
									</li>
									<li>
										<a href="#heading6">Testing this code...</a>
									</li>
									<li>
										<a href="#heading7">Wiring it up to a website</a>
									</li>
								</ol>
							</div>
						</section>
						<section class="mvp md:flex-2 md:border-l-2 md:border-gray-300 lg:border-l-0 md:shrink-0 lg:order-2 md:order-last">
							<h3 class="bg-gray-300 p-2 whitespace-nowrap">Sitecore MVP 2015-2024</h3>
							<div class="bg-white mb-2 p-2">
								<a href="/mvp">
									<img class="lg:mx-auto" src="/img/mvp/10yrs.png" width="219" height="219" alt="2024 MVP Badge">
								</a>
							</div>
						</section>
						<section class="md:basis-1/5 md:shrink-0 mb-2 lg:order-3">
							<h3 class="bg-gray-300 p-2 md:border-r-2 md:border-white lg:border-r-0 whitespace-nowrap">Recent Tags</h3>
							<div class="bg-white p-2 flex flex-wrap">
								<a href="/tags/symposium/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Symposium
								</a>
								<a href="/tags/sitecore/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Sitecore
								</a>
								<a href="/tags/xm-cloud/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									XM Cloud
								</a>
								<a href="/tags/stream/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Stream
								</a>
								<a href="/tags/composable/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Composable
								</a>
								<a href="/tags/entra/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Entra
								</a>
								<a href="/tags/docker/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Docker
								</a>
								<a href="/tags/containers/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Containers
								</a>
								<a href="/tags/visual-studio/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Visual Studio
								</a>
								<a href="/tags/graphql/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									GraphQL
								</a>
							</div>
						</section>
						<section class="md:basis-1/5 md:shrink lg:order-3">
							<h3 class="bg-gray-300 p-2 md:border-r-2 md:border-white lg:border-r-0 whitespace-nowrap">Top Tags</h3>
							<div class="bg-white p-2 flex flex-wrap">
								<a href="/tags/sitecore/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Sitecore (236)</a>
								<a href="/tags/c/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									C# (62)</a>
								<a href="/tags/powershell/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									PowerShell (32)</a>
								<a href="/tags/installation/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Installation (23)</a>
								<a href="/tags/solr/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Solr (19)</a>
								<a href="/tags/docker/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Docker (18)</a>
								<a href="/tags/general/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									General (18)</a>
								<a href="/tags/containers/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Containers (17)</a>
								<a href="/tags/ui/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									UI (15)</a>
								<a href="/tags/visual-studio/" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
									Visual Studio (12)</a>
							</div>
							<div class="bg-white mb-2 p-2">
								<a class="text-lg" href="/tags" role="button">All Tags
									<i class="fas fa-angle-double-right"></i>
								</a>
							</div>
						</section>
						<section class="md:flex-2 md:border-l-2 md:border-gray-300 lg:border-l-0 md:shrink lg:order-4">
							<h3 class="bg-gray-300 p-2 md:border-r-2 md:border-white lg:border-r-0 whitespace-nowrap">Recent Months</h3>
							<div class="bg-white p-2">
								<div>
									<a class="text-lg" href="/posts/2024-10">2024 - October</a>
								</div>
								<div>
									<a class="text-lg" href="/posts/2024-09">2024 - September</a>
								</div>
								<div>
									<a class="text-lg" href="/posts/2024-08">2024 - August</a>
								</div>
								<div>
									<a class="text-lg" href="/posts/2024-07">2024 - July</a>
								</div>
								<div>
									<a class="text-lg" href="/posts/2024-06">2024 - June</a>
								</div>
							</div>
							<div class="bg-white mb-2 p-2">
								<a class="text-lg" href="/posts" role="button">All Months
									<i class="fas fa-angle-double-right"></i>
								</a>
							</div>
						</section>
						<section class="md:flex-1 md:border-l-2 md:border-gray-300 lg:border-l-0 md:shrink-0 lg:order-5">
							<h3 class="bg-gray-300 p-2 md:border-r-2 md:border-white lg:border-r-0 whitespace-nowrap">Socials</h3>
							<div class="bg-white mb-2 p-2">
								<table>
									<tbody>
										<tr>
											<td class="border-0">
												<a rel="me" target="_blank" href="https://mastodon.social/@jermdavis">
													<img src="/img/mastodon.png" width="32" height="32" alt="Mastodon Logo">
												</a>
											</td>
											<td class="border-0 md:hidden sm:table-cell lg:table-cell">
												<a class="text-lg ml-2" rel="me" target="_blank" href="https://mastodon.social/@jermdavis">
													Mastodon
												</a>
											</td>
										</tr>
										<tr>
											<td class="border-0">
												<a rel="me" target="_blank" href="https://bsky.app/profile/jermdavis.dev">
													<img src="/img/bluesky.png" width="32" height="32" alt="Bluesky Logo">
												</a>
											</td>
											<td class="border-0 md:hidden sm:table-cell lg:table-cell">
												<a class="text-lg ml-2" rel="me" target="_blank" href="https://bsky.app/profile/jermdavis.dev">
													Bluesky
												</a>
											</td>
										</tr>
										<tr>
											<td class="border-0">
												<a rel="me" target="_blank" href="https://www.linkedin.com/in/djdavis/">
													<img src="/img/linkedin.png" width="32" height="32" alt="LinkedIn Logo">
												</a>
											</td>
											<td class="border-0 md:hidden sm:table-cell lg:table-cell">
												<a class="text-lg ml-2" rel="me" target="_blank" href="https://www.linkedin.com/in/djdavis/">
													LinkedIn
												</a>
											</td>
										</tr>
										<tr>
											<td class="border-0">
												<a rel="me" target="_blank" href="https://sitecorechat.slack.com/team/U73KL641G">
													<img src="/img/slack.png" width="32" height="32" alt="Sitecore Slack Logo">
												</a>
											</td>
											<td class="border-0 md:hidden sm:table-cell lg:table-cell">
												<a class="text-lg ml-2" rel="me" target="_blank" href="https://sitecorechat.slack.com/team/U73KL641G">
													Sitecore Slack
												</a>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</section>
					</div>
				</div>
			</div>
		</div>
		<footer class="lg:flex order-1 bg-gray-100 px-4 lg:px-6 py-4">
			<div class="flex-1 lg:flex-1 text-center lg:text-left">
				<div>©
					<a target="_blank" class="font-medium" rel="noopener" href="https://jermdavis.dev/">Jeremy Davis</a>
					2014-2024</div>
			</div>
			<div class="lg:flex-1 lg:order-3 text-center lg:text-right">
				<a class="font-medium" href="/tools">Published using Statiq</a>
				<br>
			</div>
			<ul class="list-none lg:flex-1 lg:order-2 p-0 text-center lg:align-middle" style="margin:0px !important">
				<li class="inline-block">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
					</svg>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium" target="_blank" href="/feed.rss">RSS</a>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium" target="_blank" href="/feed.atom">Atom</a>
				</li>
			</ul>
		</footer>
		<div class="min-h-screen bg-gray-300 py-6 flex flex-col justify-center sm:py-12" x-data="{ hide_banner: true }" x-init="hide_banner = docCookies.hasItem('hide_banner');" x-bind:class="{ 'hidden': hide_banner, 'fixed': !hide_banner }">
			<div class="border-2 border-gray-600 bg-gray-100 max-w-screen-lg mx-auto fixed bg-white inset-x-5 p-5 bottom-10 rounded-lg drop-shadow-2xl flex gap-4 flex-wrap md:flex-nowrap text-center md:text-left items-center justify-center md:justify-between">
				<div class="w-full text-lg">
					<a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cookie-usage" rel="noreferrer" target="_blank">This website uses Google Analytics, and its cookies.</a>
				</div>
				<button type="button" @click="hide_banner = true; docCookies.setItem('hide_banner', true, 'Fri, 31 Dec 9999 23:59:59 GMT', null, null, null, 'strict');" class="bg-gray-400 px-5 py-2 text-white rounded-md hover:bg-gray-600 focus:outline-none" aria-label="Dismiss">Understood</button>
			</div>
		</div>
		<script src="/vendor/Alpine/alpine.3.13.3.min.js" defer=""></script>
		<script src="/vendor/Enlighter/enlighterjs.min.js"></script>
		<script type="text/javascript">
            EnlighterJS.init('pre.code', 'code', {
            theme: 'droide',
            indent : 4,
            linehover : false,
            textOverflow: 'scroll',
            toolbarTop: '',
            toolbarBottom: ''
        });
        
		</script>
		<script defer="" src="/vendor/rp/rpbar-1.0.js"></script>
		<script defer="" src="/js/post.js"></script>
		<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JQ44ZR47YX"></script>
		<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-JQ44ZR47YX');
    
		</script>
	</body>
</html>