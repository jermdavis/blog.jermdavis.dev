<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' *.twitter.com unpkg.com www.googletagmanager.com www.google-analytics.com *.twimg.com; img-src 'self' data: *;style-src 'self' 'unsafe-inline' *.twitter.com *.twimg.com">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<meta name="description" content="One of the minor annoyances of some XM releases of Sitecore is that rather than just disabling analytics and not running xConnect, they do not include the DLLs necessary for personalisation at all. That can be a bit of a pain sometimes – as I discovered recently when I tried to deploy some client code into an XM docker container. The site broke because the client code included references to a personalisation DLL – which made me realise I actually wanted an &quot;XP in XM mode&quot; container so I didn't need to bother with the memory and CPU for xConnect. So here's how I hacked one up... ">
		<meta property="og:description" content="One of the minor annoyances of some XM releases of Sitecore is that rather than just disabling analytics and not running xConnect, they do not include the DLLs necessary for personalisation at all. That can be a bit of a pain sometimes – as I discovered recently when I tried to deploy some client code into an XM docker container. The site broke because the client code included references to a personalisation DLL – which made me realise I actually wanted an &quot;XP in XM mode&quot; container so I didn't need to bother with the memory and CPU for xConnect. So here's how I hacked one up... ">
		<meta name="author" content="Jeremy Davis">
		<meta name="copyright" content="Jeremy Davis">
		<title>Jeremy Davis - Making an “XP without analytics” Docker image for&nbsp;Sitecore</title>
		<link rel="canonical" href="https://blog.jermdavis.dev/posts/2020/making-an-xp-without-analytics-docker-image-for-sitecore">
		<meta name="robots" content="index, follow">
		<link type="application/rss+xml" rel="alternate" href="/feed.rss">
		<link type="application/atom+xml" rel="alternate" href="/feed.atom">
		<meta name="application-name" content="Jeremy Davis">
		<meta name="msapplication-tooltip" content="Jeremy Davis">
		<meta name="msapplication-starturl" content="/">
		<link rel="manifest" href="/manifest.json">
		<meta property="og:title" content="Jeremy Davis - Making an &amp;#x201C;XP without analytics&amp;#x201D; Docker image for&amp;#xA0;Sitecore">
		<meta property="og:image" content="https://blog.jermdavis.dev/img/featured/making-an-xp-without-analytics-docker-image-for-sitecore-social.png">
		<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": "Making an &#x201C;XP without analytics&#x201D; Docker image for&#xA0;Sitecore",
        "image": [
            "https://blog.jermdavis.dev/img/featured/making-an-xp-without-analytics-docker-image-for-sitecore-social.png"
        ],
        "datePublished": "2020-03-02T00:00:00+00:00",
        "author": [{
            "@type": "Person",
            "name": "Jeremy Davis",
            "url": "https://jermdavis.dev/"
        }]
    }
    
		</script>
		<meta property="og:url" content="https://blog.jermdavis.dev/posts/2020/making-an-xp-without-analytics-docker-image-for-sitecore">
		<meta property="og:type" content="website">
		<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
		<link rel="icon" type="image/png" href="/img/favicon-32x32.png" sizes="32x32">
		<link rel="icon" type="image/png" href="/img/favicon-16x16.png" sizes="16x16">
		<link href="/scss/tailwind.css" rel="stylesheet">
		<link href="/vendor/Enlighter/enlighterjs.min.css" rel="stylesheet">
		<link href="/scss/site-theme.css" rel="stylesheet">
		<script src="/vendor/Cookies/cookies.min.js" defers=""></script>
		
		<!-- 14/01/2022 14:22:19 -->
	</head>
	<body class="max-w-7xl mx-auto">
		<div class="relative bg-white" x-data="{ open: false }">
			
			<!-- desktop -->
			<div class="px-4 lg:px-6 bg-gray-100">
				<div class="flex justify-between items-center border-b-2 border-gray-100 py-6 lg:justify-start lg:space-x-10">
					<div class="flex justify-start lg:w-0 flex-1">
						<a href="/">
							<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
						</a>
						<div class="mx-2">
							<div class="text-3xl">Jeremy Davis</div>
							<div class="text-lg">Sitecore, C# and web development</div>
						</div>
					</div>
					<div class="-mr-2 -my-2 lg:hidden">
						<button @click="open = true" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-expanded="false">
							<span class="sr-only">Open menu</span>
							
							<!-- Heroicon name: outline/menu -->
							<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
							</svg>
						</button>
					</div>
					<nav class="hidden lg:flex space-x-10">
						<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/posts">Posts</a>
						<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/tags">Tags</a>
						<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/about">About</a>
						<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/links">Useful Links</a>
						<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/mvp">MVP</a>
					</nav>
				</div>
			</div>
			
			<!--Mobile menu, show/hide based on mobile menu state.-->
			<div class="absolute top-0 inset-x-0 p-2 transition transform origin-top-right lg:hidden z-50">
				<div class="rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 bg-white divide-y-2 divide-gray-50" x-show="open" x-transition="">
					<div class="pt-5 pb-6 px-5">
						<div class="flex items-center justify-between">
							<div class="flex">
								<a href="/">
									<img class="mt-2" width="56" height="56" src="/img/Profile.jpg" alt="Jeremy Davis">
								</a>
								<div class="mx-2">
									<div class="text-2xl">Jeremy Davis</div>
									<div class="text-base">Sitecore, C# and web development</div>
								</div>
							</div>
							<div class="-mr-2">
								<button @click="open = false" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
									<span class="sr-only">Close menu</span>
									
									<!-- Heroicon name: outline/x -->
									<svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
									</svg>
								</button>
							</div>
						</div>
					</div>
					<div class="py-6 px-5 pt-0">
						<nav class=" gap-x-8">
							<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/posts">Posts</a>
							<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/tags">Tags</a>
							<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/about">About</a>
							<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/links">Useful Links</a>
							<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/mvp">MVP</a>
						</nav>
					</div>
				</div>
			</div>
		</div>
		<header class="bg-gray-300 px-4 py-1 lg:px-6 text-center" style="background-image: url(&amp;quot;/&amp;quot;);">
			<div class="post-heading">
				<h1 class="text-5xl mb-4 pb-1">
					Making an “XP without analytics” Docker image for&nbsp;Sitecore
				</h1>
				<div class="meta">Published 02 March 2020</div>
				<div class="flex py-1">
					<a href="/tags/docker" class="p-1 mr-1 bg-gray-100 rounded-md">
						Docker</a>
					<a href="/tags/sitecore" class="p-1 mr-1 bg-gray-100 rounded-md">
						Sitecore</a>
				</div>
			</div>
		</header>
		<div class="py-2 lg:pl-3">
			<div class="lg:flex">
				<div class="lg:flex-auto mx-3 lg:min-w-0 content">
					<p>One of the minor annoyances of some XM releases of Sitecore is that rather than just disabling analytics and not running xConnect, they do not include the DLLs necessary for personalisation at all. That can be a bit of a pain sometimes – as I discovered recently when I tried to deploy some client code into an XM docker container. The site broke because the client code included references to a personalisation DLL – which made me realise I actually wanted an "XP in XM mode" container so I didn't need to bother with the memory and CPU for xConnect. So here's how I hacked one up... 
						<!--more-->
					</p>
					<p>The starting point for my hackery was having an XP v9.2 CM image. You can build one using
						<a href="https://github.com/Sitecore/docker-images" rel="noopener" target="_blank">the standard docker repo scripts</a>
						using:</p>
					<pre data-enlighter-language="powershell" style="width:100%; overflow:scroll;">.\Build.ps1 -SitecoreUsername &lt;your user&gt; -SitecorePassword &lt;your password&gt;             -SitecoreVersion '9.2.0' -Topology XP             -IncludeSpe -WindowsVersion 1903
					</pre>
					<p>(Note the improved filtering here,
						<a href="/posts/2020/building-docker-images-for-older-versions-of-sitecore" target="_blank">compared to my previous comments</a>
						– the community moves quickly to fix these issues...)</p>
					<p>This generates all the relevant images. And you can use the "standalone" CM one as the basis for a new image. Docker works on the basis of "layers" – when you build a new image you can describe it in terms of the difference between an existing one, and what you want it to be. You describe the changes in your own "<a href="https://docs.docker.com/engine/reference/builder/" rel="noopener" target="_blank">Dockerfile</a>" – text instructions to tell the Docker engine what it should do to make your new image.</p>
					<p>Configuring an instance of Sitecore to ignore analytics can be done with a config patch:</p>
					<pre data-enlighter-language="xml" style="width:100%; overflow:scroll;">&lt;configuration xmlns:patch="http://www.sitecore.net/xmlconfig/" xmlns:set="http://www.sitecore.net/xmlconfig/set/"  xmlns:role="http://www.sitecore.net/xmlconfig/role/"&gt;     &lt;sitecore&gt;         &lt;settings&gt;             &lt;setting name="Xdb.Enabled" set:value="false" /&gt;             &lt;setting name="Xdb.Tracking.Enabled" set:value="false" /&gt;         &lt;/settings&gt;     &lt;/sitecore&gt; &lt;/configuration&gt;
					</pre>
					<p>A trivial change, yes – but it was all I needed to get started and prove I could make this work. So the difference between our base image and our new one is the presence of that file in the
						<code>/App_Config/Include</code>
						folder. Hence we need our Dockerfile to do that for us:</p>
					<pre data-enlighter-theme="droide-text" data-enlighter-language="text" style="width:100%; overflow:scroll;">FROM sitecore-xp-standalone:9.2.0-windowsservercore-1903  COPY .\\config\\zDisable-Analytics.config C:\\inetpub\\wwwroot\\App_Config\\Include
					</pre>
					<p>The
						<code>FROM</code>
						command tells Docker what base image to start with. And the
						<code>COPY</code>
						command takes a file from the physical computer and puts into in the specified folder in the container. You can add in whatever extra files you need here. Other config that's specific to your setup in Docker, dependencies that your solution has, or tools like the TDS endpoint, for example...</p>
					<p>Make yourself a folder to keep your new setup files. (You'd probably add this to source control – either in your dev project or in a repo for docker image builds. You're probably going to want this file again in the future) Save the text above as
						<code>Dockerfile</code>
						(no extension) in the folder and put the analytics disabling config file into the
						<code>.\config</code>
						folder alongside the Dockerfile. And then you can ask Docker to build the image with:</p>
					<pre data-enlighter-theme="droide-text" data-enlighter-language="text" style="width:100%; overflow:scroll;">docker build -t sitecore-xpxm-standalone:9.2.0-windowsservercore-1903 .
					</pre>
					<p>The
						<code>-t</code>
						parameter specifies the tag to save the image under, and
						<code>.</code>
						says "use the
						<code>Dockerfile</code>
						in the current folder". And the result of that is:</p>
					<p>
						<a href="/img/2020/2020-01-dockerbuild.png" target="_blank">
							<img alt="Docker Build" src="/img/2020/2020-01-dockerbuild.png">
						</a>
					</p>
					<p>Which leaves us with a new image on disk:</p>
					<p>
						<a href="/img/2020/2020-01-generatedimage.png" target="_blank">
							<img alt="Generated Image" src="/img/2020/2020-01-generatedimage.png">
						</a>
					</p>
					<p>So now you have an image, you need to be able to fire it up and work with it. That involves modifying the default "Docker compose" file for the original XP instance. For the 9.2 setup I was working with, I started from
						<a href="https://github.com/Sitecore/docker-images/blob/master/windows/tests/9.2.x/docker-compose.xp.spe.yml" rel="noopener" target="_blank">9.2.x/docker-compose.xp.spe.yml</a>
						taken from the official repo. Since we're not wanting to start up xConnect the instructions for those containers (xconnect, xconnect-automationengine, xconnect-indexworker and xconnect-processingengine) can be removed. (I also removed the CD instance, as I wasn't using that) You also need to remove
						<code>xconnect</code>
						from the
						<code>links</code>
						segment of your CM role config, because it doesn't depend on analytics now. Finally, the instructions for starting the cm instance can be changed to use our newly generated image:</p>
					<pre data-enlighter-theme="droide-text" data-enlighter-highlight="22,32" data-enlighter-language="text" style="width:100%; overflow:scroll;">version: '2.4'  services:    sql:     image: ${REGISTRY}sitecore-xp-spe-sqldev:${SITECORE_VERSION}-windowsservercore-${WINDOWSSERVERCORE_VERSION}     volumes:       - .\data\sql:C:\Data     mem_limit: 2GB     ports:       - "44010:1433"    solr:     image: ${REGISTRY}sitecore-xp-solr:${SITECORE_VERSION}-nanoserver-${NANOSERVER_VERSION}     volumes:       - .\data\solr:C:\Data     mem_limit: 1GB     ports:       - "44011:8983"    cm:     image: ${REGISTRY}sitecore-xpxm-standalone:9.2.0-windowsservercore-${WINDOWSSERVERCORE_VERSION}     entrypoint: powershell.exe -Command "&amp; C:\\tools\\entrypoints\\iis\\Development.ps1 -WatchDirectoryParameters @{ Path = 'C:\\src'; Destination = 'C:\\inetpub\\wwwroot'; ExcludeFiles = @(); }"     volumes:       - ${LICENSE_PATH}:C:\license       - .\data\cm:C:\inetpub\wwwroot\App_Data\logs     ports:       - "44001:80"     links:       - sql       - solr
					</pre>
					<p>And running
						<code>docker-compose up</code>
						on that file will start up Sitecore, without any xConnect – but with all the DLLs for personalisation in place:</p>
					<p>
						<a href="/img/2020/2020-01-dockerps.png" target="_blank">
							<img alt="Docker PS" src="/img/2020/2020-01-dockerps.png">
						</a>
					</p>
					<p>Success!</p>
				</div>
				<div class="lg:flex-none lg:w-72 m-0 mt-1 lg:mt-0 lg:p-1 lg:bg-gray-100">
					<section class="mvp">
						<h3 class="bg-gray-300 p-2">Sitecore MVP 2015-2021</h3>
						<div class="bg-white mb-2 p-2">
							<a href="/mvp">
								<img src="/img/mvp/2021.jpg" width="219" height="219" alt="2021 MVP Badge">
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Top Tags</h3>
						<div class="bg-white p-2 flex flex-wrap">
							<a href="/tags/sitecore" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Sitecore (194)</a>
							<a href="/tags/c" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								C# (45)</a>
							<a href="/tags/powershell" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								PowerShell (31)</a>
							<a href="/tags/installation" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Installation (23)</a>
							<a href="/tags/solr" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Solr (15)</a>
							<a href="/tags/ui" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								UI (14)</a>
							<a href="/tags/general" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								General (13)</a>
							<a href="/tags/coveo" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Coveo (12)</a>
							<a href="/tags/visual-studio" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Visual Studio (11)</a>
							<a href="/tags/docker" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1">
								Docker (10)</a>
						</div>
						<div class="bg-white mb-2 p-2">
							<a class="" href="/tags" role="button">All Tags
								<i class="fas fa-angle-double-right"></i>
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Recent Months</h3>
						<div class="bg-white p-2">
							<div>
								<a class="text-lg" href="/posts/2021-12">2021 - December</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2021-11">2021 - November</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2021-10">2021 - October</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2021-09">2021 - September</a>
							</div>
							<div>
								<a class="text-lg" href="/posts/2021-08">2021 - August</a>
							</div>
						</div>
						<div class="bg-white mb-2 p-2">
							<a class="" href="/posts" role="button">All Posts
								<i class="fas fa-angle-double-right"></i>
							</a>
						</div>
					</section>
					<section>
						<h3 class="bg-gray-300 p-2">Twitter</h3>
						<div class="bg-white mb-2 p-2">
							<a class="twitter-timeline" data-height="400" data-chrome="noheader nofooter noborders" href="https://twitter.com/jermdavis">Tweets by JermDavis</a>
							<script async="" defer="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
						</div>
					</section>
				</div>
			</div>
		</div>
		<footer class="lg:flex order-1 bg-gray-100 px-4 lg:px-6 py-4">
			<div class="flex-1 lg:flex-1 text-center lg:text-left">
				<div>©
					<a target="_blank" class="font-medium text-gray-500 hover:text-gray-900" rel="noopener" href="https://jermdavis.dev/">Jeremy Davis</a>
					2014-2022</div>
			</div>
			<div class="lg:flex-1 lg:order-3 text-center lg:text-right">
				<a class="font-medium text-gray-500 hover:text-gray-900" href="/tools">Published using Statiq</a>
				<br>
			</div>
			<ul class="list-none lg:flex-1 lg:order-2 p-0 text-center lg:align-middle" style="margin:0px !important">
				<li class="inline-block">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
					</svg>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium text-gray-500 hover:text-gray-900" target="_blank" href="/feed.rss">RSS</a>
				</li>
				<li class="inline-block ml-4">
					<a class="font-medium text-gray-500 hover:text-gray-900" target="_blank" href="/feed.atom">Atom</a>
				</li>
			</ul>
		</footer>
		<div class="min-h-screen bg-gray-300 py-6 flex flex-col justify-center sm:py-12" x-data="{ hide_banner: true }" x-init="hide_banner = docCookies.hasItem('hide_banner');" x-bind:class="{ 'hidden': hide_banner, 'fixed': !hide_banner }">
			<div class="border-2 border-gray-600 bg-gray-100 max-w-screen-lg mx-auto fixed bg-white inset-x-5 p-5 bottom-10 rounded-lg drop-shadow-2xl flex gap-4 flex-wrap md:flex-nowrap text-center md:text-left items-center justify-center md:justify-between">
				<div class="w-full text-lg">
					<a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cookie-usage" rel="noreferrer" target="_blank">This website uses Google Analytics, and its cookies.</a>
				</div>
				<button type="button" @click="hide_banner = true; docCookies.setItem('hide_banner', true, (7*24*60*60));" class="bg-gray-400 px-5 py-2 text-white rounded-md hover:bg-gray-600 focus:outline-none" aria-label="Dismiss">Understood</button>
			</div>
		</div>
		<script src="/vendor/Alpine/alpine.3.7.1.min.js" defer=""></script>
		<script src="/vendor/Enlighter/enlighterjs.min.js"></script>
		<script type="text/javascript">
        EnlighterJS.init('pre', 'code', {
            theme: 'droide',
            indent : 4,
            linehover : false,
            textOverflow: 'scroll',
            toolbarTop: '',
            toolbarBottom: ''
        });
    
		</script>
		<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JQ44ZR47YX"></script>
		<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-JQ44ZR47YX');
    
		</script>
	</body>
</html>