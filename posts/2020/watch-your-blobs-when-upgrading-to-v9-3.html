<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="Sitecore, C# and web development">
        <meta name="author" content="Jeremy Davis">

    <title>Jeremy Davis - Watch your Blobs when upgrading to&nbsp;v9.3</title>

    <link rel="canonical" href="https://blog.jermdavis.dev/posts/2020/watch-your-blobs-when-upgrading-to-v9-3">
    <meta name="robots" content="noindex, nofollow">

            <link type="application/rss+xml" rel="alternate" href="/feed.rss">
            <link type="application/atom+xml" rel="alternate" href="/feed.atom">

    <meta name="application-name" content="Jeremy Davis">
    <meta name="msapplication-tooltip" content="Jeremy Davis">
    <meta name="msapplication-starturl" content="/">

    
    <meta property="og:title" content="Jeremy Davis - Watch your Blobs when upgrading to&nbsp;v9.3">
        <meta property="og:image" content="/img/featured/watch-your-blobs-when-upgrading-to-v9-3-social.png">
    <meta property="og:description" content="">
<meta property="og:url" content="https://blog.jermdavis.dev/posts/2020/watch-your-blobs-when-upgrading-to-v9-3">
<meta property="og:type" content="website">

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <link href="https://unpkg.com/tailwindcss@2.2.11/dist/tailwind.min.css" rel="stylesheet">

    <link href="/vendor/Enlighter/enlighterjs.min.css" rel="stylesheet">
    <link href="/scss/site-theme.css" rel="stylesheet">


    <script src="/vendor/Cookies/cookies.min.js" defers=""></script>

    

    
</head>

<body class="max-w-7xl mx-auto">
    <div class="relative bg-white" x-data="{ open: false }">

    <!-- desktop -->
    <div class="px-4 lg:px-6 bg-gray-100">
        <div class="flex justify-between items-center border-b-2 border-gray-100 py-6 lg:justify-start lg:space-x-10">

            <div class="flex justify-start lg:w-0 flex-1">
                <a href="/">
                    <img class="h-12 mt-2 w-auto lg:h-14" src="/img/Profile.jpg" alt="Jeremy Davis">
                </a>
                <div class="mx-2">
                    <div class="text-3xl">Jeremy Davis</div>
                    <div class="text-lg">Sitecore, C# and web development</div>
                </div>
            </div>

            <div class="-mr-2 -my-2 lg:hidden">
                <button @click="open = true" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-expanded="false">
                    <span class="sr-only">Open menu</span>
                    <!-- Heroicon name: outline/menu -->
                    <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>

            <nav class="hidden lg:flex space-x-10">
<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/posts">Posts</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/tags">Tags</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/about">About</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/links">Useful Links</a><a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/mvp">MVP</a>            </nav>

        </div>
    </div>

    <!--Mobile menu, show/hide based on mobile menu state.-->
    <div class="absolute top-0 inset-x-0 p-2 transition transform origin-top-right lg:hidden z-50">

        <div class="rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 bg-white divide-y-2 divide-gray-50" x-show="open" x-transition="">
            <div class="pt-5 pb-6 px-5">
                <div class="flex items-center justify-between">
                    <div class="flex">
                        <a href="/">
                            <img class="h-12 mt-2 w-auto" src="/img/Profile.jpg" alt="Jeremy Davis">
                        </a>
                        <div class="mx-2">
                            <div class="text-2xl">Jeremy Davis</div>
                            <div class="text-base">Sitecore, C# and web development</div>
                        </div>
                    </div>

                    <div class="-mr-2">
                        <button @click="open = false" type="button" class="bg-white rounded-md p-2 inline-flex items-center justify-center text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
                            <span class="sr-only">Close menu</span>
                            <!-- Heroicon name: outline/x -->
                            <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="py-6 px-5 pt-0">
                <nav class=" gap-x-8">
<a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/posts">Posts</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/tags">Tags</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/about">About</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/links">Useful Links</a><a class="block mt-5 text-base font-medium text-gray-500 hover:text-gray-900" href="/mvp">MVP</a>                </nav>
            </div>

        </div>
    </div>
</div>

    <header class="bg-gray-300 px-4 py-1 lg:px-6 text-center" style="background-image: url(&quot;/&quot;);">
    <div class="post-heading">
        <h1 class="text-5xl mb-1 pb-1">
        Watch your Blobs when upgrading to&nbsp;v9.3
        </h1>
            <div class="meta">Published 28 September 2020</div>
            <div class="flex py-1">
                    <a href="/tags/sitecore" class="p-1 mr-1 bg-gray-100 rounded-md"> Sitecore</a>
            </div>
    </div>
</header>

    <div class="py-2 lg:pl-3">
        <div class="lg:flex">
            <div class="lg:flex-auto mx-3 lg:min-w-0 content">
                <p>I've been spending a bit of time helping out a client who's working through an upgrade project recently, and the work to move from v9.1 to v9.3 raised an interesting issue I wasn't aware of. So in the spirit of making life easier for others, here's what happened:<!--more--></p>
<h2>The scenario</h2>
<p>The project in question had a distributed instance of Sitecore. Because of the distance between master and the web database, Publishing Service was in use. Plus there were multiple web databases set up as Publishing Targets.</p>
<p>After some initial work on the upgrade, Sitecore would start up and Content Editor ran. However when you looked at the public site, all the images were broken. They didn't load in the pages, and if you requested one directly you'd see something like:</p>
<p><a href="/img/2020/2020-08-error.png" target="_blank"><img alt="Image Error" src="/img/2020/2020-08-error.png"></a></p>
<p>Under the surface, the stack trace in the logs was:</p>
<pre data-enlighter-theme="droide-text" data-enlighter-language="text" style="width:100%; overflow:scroll;">1192 20:34:01 ERROR Could not run the 'getMediaStream' pipeline for '/sitecore/media library/Default Website/cover'. Original media data will be used.
Exception: System.InvalidOperationException
Message: BlobStorage
Source: Sitecore.Kernel
   at Sitecore.Data.Fields.Field.GetBlobStorage()
   at Sitecore.Data.Fields.Field.GetBlobStream()
   at Sitecore.Resources.Media.MediaData.GetBlobStream()
   at Sitecore.Resources.Media.GetMediaStreamPipelineArgs.get_OutputStream()
   at Sitecore.Resources.Media.ResizeProcessor.Process(GetMediaStreamPipelineArgs args)
   at (Object , Object )
   at Sitecore.Pipelines.CorePipeline.Run(PipelineArgs args)
   at Sitecore.Pipelines.DefaultCorePipelineManager.Run(String pipelineName, PipelineArgs args, String pipelineDomain, Boolean failIfNotExists)
   at Sitecore.Pipelines.DefaultCorePipelineManager.Run(String pipelineName, PipelineArgs args, String pipelineDomain)
   at Sitecore.Resources.Media.Media.GetStreamFromPipeline(MediaOptions options, Boolean&amp; canBeCached)
</pre>
<p>And if you pointed Content Editor at the Publishing Target that the public site was using, it worked fine until you selected the Media item for one of the images. And then you'd see much the same error in the Content Editor:</p>
<p><a href="/img/2020/2020-08-desktoperror.png" target="_blank"><img alt="Desktop Error" src="/img/2020/2020-08-desktoperror.png"></a></p>
<h2>The issue</h2>
<p>After a certain amount of googling and frustration, I came across <a href="http://www.zitecore.com/2020/05/sitecore-93-publishing-error-when.html" rel="noopener" target="_blank">a blog post relating to a similar error</a>, which gave me the hint I needed to get to the bottom of this: It describes the need for a <code>&lt;BlobStorage/&gt;</code> element in config. That post then lead on to Sitecore's <a href="https://doc.sitecore.com/developers/93/sitecore-experience-manager/en/enable-the-azure-blob-storage-module-for-sitecore-blobs.html" rel="noopener" target="_blank">documentation of v9.3's new Azure Blob Storage module</a>.</p>
<h2>Resolution</h2>
<p>So it seems that v9.3 has added a new extension point for customising how the binary data for Media Items is stored. Historically that was always in the <code>Blobs</code> table inside your content databases. But now it's configurable – so each database definition in your config needs a <code>&lt;BlobStorage/&gt;</code> element.</p>
<p>The documentation largely describes setting this up for Azure Blob Storage, but it also covers the settings required for the old SQL database approach (which is also what the blog post above mentioned).</p>
<p>So the installation of Sitecore v9.3 for this project was working ok, except for the fact that the extra publishing targets were created with config patches written for Sitecore v9.1. So they did not have this extra config.</p>
<p>Based on the blog post above and the Sitecore docs, the solution is to add a blob storage provider to each of the publishing targets:</p>
<pre data-enlighter-language="xml" style="width:100%; overflow:scroll;">&lt;database id="custom-publishing-target"&gt;
  &lt;BlobStorage&gt;
    &lt;providers default="classic"&gt;
      &lt;provider name="classic" type="Sitecore.Data.Blobs.ClassicSqlBlobProvider, Sitecore.Kernel"&gt;
        &lt;param desc="databaseName"&gt;$(id)&lt;/param&gt;
      &lt;/provider&gt;
    &lt;/providers&gt;
  &lt;/BlobStorage&gt;
&lt;/database&gt;
</pre>
<p>And once that's in place, Sitecore knows where to find the blobs for these databases, getting rid of the error.</p>
<p>So that covered Sitecore – but a load of googling didn't bring up anything about how this might affect Publishing Service. I ended up discussing this with Sitecore Support, who filled in the last bits of the puzzle for me. Given I'd had to add specific config for this to Sitecore I was concerned that there might be some sort of config change required to ensure Publishing Service knew where the blobs were, so it could know what to do with them.</p>
<p>But according to Support, Publishing Service doesn't actually care what your blob provider is. If the blobs are in SQL Server tables in your content database, then they'll get published because that's how blobs used to be dealt with. But if the blobs are in Azure, then there are no records in the content database blob table – so Publishing Service will have nothing to do there – and the images are already sat in Azure Blob Storage, ready to be served...</p>
<p>So, as long as you remember to add the default SQL blob provider to all your custom Publishing Targets when you're upgrading, everything will work.</p>
<p>And big thanks to <a href="https://www.blogger.com/profile/05043142874098063911" rel="noopener" target="_blank">Colin Cooper</a>, for the blog post that unlocked this for me.</p>


            </div>
            <div class="lg:flex-none lg:w-72 m-0 mt-1 lg:mt-0 lg:p-1 lg:bg-gray-100">
                <section>
    <h3 class="bg-gray-300 p-2">Sitecore MVP 2015-2021</h3>
    <div class="bg-white mb-2 p-2"><img src="/img/mvp/2021.jpg" alt="2021 MVP Badge"></div>
</section>

<section>
    <h3 class="bg-gray-300 p-2">Top Tags</h3>
    <div class="bg-white p-2 flex flex-wrap">
                    <a href="/tags/sitecore" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Sitecore (192)</a>
                    <a href="/tags/c" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> C# (45)</a>
                    <a href="/tags/powershell" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> PowerShell (31)</a>
                    <a href="/tags/installation" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Installation (23)</a>
                    <a href="/tags/solr" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Solr (15)</a>
                    <a href="/tags/ui" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> UI (14)</a>
                    <a href="/tags/general" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> General (12)</a>
                    <a href="/tags/coveo" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Coveo (12)</a>
                    <a href="/tags/visual-studio" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Visual Studio (11)</a>
                    <a href="/tags/docker" class="flex-initial text-lg p-1 mr-1 bg-gray-100 rounded-md mt-1"> Docker (10)</a>
    </div>
    <div class="bg-white mb-2 p-2">
        <a class="" href="/tags" role="button">All Tags <i class="fas fa-angle-double-right"></i></a>
    </div>
</section>

<section>
    <h3 class="bg-gray-300 p-2">Recent Months</h3>
    <div class="bg-white p-2">
                <div><a class="text-lg" href="/posts/2021-01">2021 - January</a></div>
                <div><a class="text-lg" href="/posts/2021-02">2021 - February</a></div>
                <div><a class="text-lg" href="/posts/2021-03">2021 - March</a></div>
                <div><a class="text-lg" href="/posts/2021-04">2021 - April</a></div>
                <div><a class="text-lg" href="/posts/2021-05">2021 - May</a></div>
    </div>
    <div class="bg-white mb-2 p-2">
        <a class="" href="/posts" role="button">All Posts <i class="fas fa-angle-double-right"></i></a>
    </div>
</section>

<section>
    <h3 class="bg-gray-300 p-2">Twitter</h3>
    <div class="bg-white mb-2 p-2">
        <a class="twitter-timeline" data-height="400" data-chrome="noheader nofooter noborders" href="https://twitter.com/jermdavis">Tweets by JermDavis</a>
        <script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
    </div>
</section>
            </div>
        </div>
    </div>

    <footer class="lg:flex order-1 bg-gray-100 px-4 lg:px-6 py-4">
    <div class="flex-1 lg:flex-1 text-center lg:text-left">© <a target="_blank" class="font-medium text-gray-500 hover:text-gray-900" href="https://jermdavis.dev/">Jeremy Davis</a> 2014-2021</div>

    <div class="lg:flex-1 lg:order-3 text-center lg:text-right"><a class="font-medium text-gray-500 hover:text-gray-900" href="/tools">Published using Statiq</a></div>

    <ul class="list-none lg:flex-1 lg:order-2 text-center align-middle">
        <li class="inline-block">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"></path>
            </svg>
        </li>
            <li class="inline-block ml-4">
                <a class="font-medium text-gray-500 hover:text-gray-900" target="_blank" href="/feed.rss">RSS</a>
            </li>
            <li class="inline-block ml-4">
                <a class="font-medium text-gray-500 hover:text-gray-900" target="_blank" href="/feed.atom">Atom</a>
            </li>
    </ul>
</footer>

    <div class="min-h-screen bg-gray-300 py-6 flex flex-col justify-center sm:py-12" x-data="{ hide_banner: true }" x-init="hide_banner = docCookies.hasItem('hide_banner') ? (docCookies.getItem('hide_banner') == 'true') : false;" x-bind:class="{ 'hidden': hide_banner, 'fixed': !hide_banner }">
        <div class="border-2 border-gray-600 bg-gray-100 max-w-screen-lg mx-auto fixed bg-white inset-x-5 p-5 bottom-10 rounded-lg drop-shadow-2xl flex gap-4 flex-wrap md:flex-nowrap text-center md:text-left items-center justify-center md:justify-between">
            <div class="w-full text-lg">This website uses Google Analytics, and its cookies.
              <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/cookie-usage" rel="noreferrer" target="_blank" class="whitespace-nowrap">Learn more</a>
            </div>

            <button type="button" @click="hide_banner = true; docCookies.setItem('hide_banner', true, (7*24*60*60));" class="bg-gray-400 px-5 py-2 text-white rounded-md hover:bg-gray-600 focus:outline-none" aria-label="Dismiss">Understood</button>
        </div>
    </div>
    
    <script src="https://unpkg.com/alpinejs" defer=""></script>    
    <script src="/vendor/Enlighter/enlighterjs.min.js"></script>

    <script type="text/javascript">
        EnlighterJS.init('pre', 'code', {
            theme: 'droide',
            indent : 4,
            linehover : false,
            textOverflow: 'scroll',
            toolbarTop: '{BTN_RAW}{BTN_COPY}',
            toolbarBottom: ''
        });
    </script>

    <script async="" src="https://www.googletagmanager.com/gtag/js?id=G-JQ44ZR47YX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-JQ44ZR47YX');
    </script>

    

    



</body></html>